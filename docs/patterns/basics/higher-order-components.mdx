# é«˜é˜¶ç»„ä»¶ (HOC) - é€»è¾‘å¤ç”¨æ¨¡å¼

import { Tabs, TabItem } from '@docusaurus/theme-common';

é«˜é˜¶ç»„ä»¶ï¼ˆHigher-Order Componentï¼Œç®€ç§°HOCï¼‰æ˜¯Reactä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„é«˜çº§æ¨¡å¼ã€‚è™½ç„¶Hookså·²ç»æˆä¸ºäº†å¤ç”¨é€»è¾‘çš„é¦–é€‰æ–¹å¼ï¼Œä½†HOCåœ¨æŸäº›åœºæ™¯ä¸‹ä»ç„¶æœ‰å®ƒçš„ä»·å€¼ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨HOCçš„æ¦‚å¿µã€å®ç°æ–¹å¼ã€ä½¿ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£é«˜é˜¶ç»„ä»¶çš„æ¦‚å¿µå’ŒåŸç†
- æŒæ¡HOCçš„å®ç°æ–¹å¼å’Œè¯­æ³•
- å­¦ä¼šç¼–å†™å¯å¤ç”¨çš„HOC
- ç†è§£HOCä¸Hooksçš„å¯¹æ¯”å’Œé€‰æ‹©
- æŒæ¡HOCçš„å¸¸è§ä½¿ç”¨åœºæ™¯
- å­¦ä¼šé¿å…HOCçš„å¸¸è§é™·é˜±
- ç†è§£HOCçš„å‘½åçº¦å®šå’Œæœ€ä½³å®è·µ

---

## 1. ä»€ä¹ˆæ˜¯é«˜é˜¶ç»„ä»¶ï¼Ÿ

é«˜é˜¶ç»„ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªç»„ä»¶å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»„ä»¶ã€‚HOCæ˜¯Reactä¸­ç”¨äºå…±äº«é€»è¾‘çš„æ¨¡å¼ï¼Œå®ƒå°†ç»„ä»¶é€»è¾‘æå–åˆ°å¯å¤ç”¨çš„å‡½æ•°ä¸­ã€‚

<Box style={{ padding: '20px', background: '#e3f2fd', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#1976d2' }}>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>é«˜é˜¶ç»„ä»¶</strong>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¢å¼ºçš„æ–°ç»„ä»¶ã€‚ç±»ä¼¼äºJavaScriptä¸­çš„<strong>é«˜é˜¶å‡½æ•°</strong>ã€‚
  </p>
</Box>

<CodeBlock>

```jsx
// é«˜é˜¶ç»„ä»¶çš„æœ¬è´¨
const EnhancedComponent = higherOrderComponent(WrappedComponent);

// å®é™…ä¾‹å­
const UserListWithLoading = withLoading(UserList);
const UserListWithAuth = withAuth(UserList);
```

</CodeBlock>

### 1.1 HOC vs é«˜é˜¶å‡½æ•°

<CodeBlock>

```jsx
// JavaScripté«˜é˜¶å‡½æ•°ç¤ºä¾‹
const numbers = [1, 2, 3, 4, 5];

// mapæ˜¯é«˜é˜¶å‡½æ•°
const doubled = numbers.map(n => n * 2);

// Reacté«˜é˜¶ç»„ä»¶ç¤ºä¾‹
const enhancedComponent = withLoading(WrappedComponent);
```

</CodeBlock>

### 1.2 ä¸ºä»€ä¹ˆä½¿ç”¨HOCï¼Ÿ

<Grid>

<div>
  <h4>é€‚ç”¨åœºæ™¯</h4>
  <ul>
    <li>ğŸ”„ é€»è¾‘å¤ç”¨ï¼ˆæœªä½¿ç”¨Hooksä¹‹å‰ï¼‰</li>
    <li>ğŸ”’ æƒé™æ§åˆ¶</li>
    <li>ğŸ”Œ æ•°æ®è®¢é˜…</li>
    <li>ğŸ“Š çŠ¶æ€ç®¡ç†</li>
    <li>ğŸ¨ æ ·å¼å¢å¼º</li>
    <li>ğŸ“ Propsè½¬æ¢</li>
  </ul>
</div>

<div>
  <h4>å†å²èƒŒæ™¯</h4>
  <ul>
    <li>ğŸ“… React 0.14+ å¼•å…¥</li>
    <li>ğŸ“… ç”¨äºå¤ç”¨ç±»ç»„ä»¶é€»è¾‘</li>
    <li>ğŸ“… Reduxã€React Routerä½¿ç”¨HOC</li>
    <li>ğŸ“… React 16.8+ Hookså‡ºç°</li>
    <li>ğŸ“… ç°åœ¨æ¨èä½¿ç”¨Hooks</li>
    <li>ğŸ“… ä»ç”¨äºåº“å¼€å‘</li>
  </ul>
</div>

</Grid>

---

## 2. HOCå®ç°åŸºç¡€

### 2.1 æœ€ç®€å•çš„HOC

<CodeBlock>

```jsx
// æœ€åŸºç¡€çš„HOC - æ·»åŠ é¢å¤–prop
function withExtraProp(WrappedComponent) {
  return function EnhancedComponent(props) {
    // æ·»åŠ é¢å¤–prop
    const enhancedProps = {
      ...props,
      extraProp: 'This is added by HOC'
    };

    // ä¼ é€’ç»™åŒ…è£…ç»„ä»¶
    return <WrappedComponent {...enhancedProps} />;
  };
}

// ä½¿ç”¨
function OriginalComponent({ name, extraProp }) {
  return <div>Hello {name}! {extraProp}</div>;
}

// åˆ›å»ºå¢å¼ºç»„ä»¶
const EnhancedComponent = withExtraProp(OriginalComponent);

// ä½¿ç”¨å¢å¼ºç»„ä»¶
<EnhancedComponent name="Alice" />
// æ¸²æŸ“: <div>Hello Alice! This is added by HOC</div>
```

</CodeBlock>

### 2.2 ç®­å¤´å‡½æ•°ç‰ˆæœ¬

<CodeBlock>

```jsx
// ä½¿ç”¨ç®­å¤´å‡½æ•°
const withExtraProp = (WrappedComponent) => (props) => {
  return <WrappedComponent {...props} extraProp="Added" />;
};

// ä¼ é€’é¢å¤–å‚æ•°
const withExtraProp = (WrappedComponent, extraValue) => (props) => {
  return <WrappedComponent {...props} extraProp={extraValue} />;
};

// ä½¿ç”¨
const EnhancedComponent = withExtraProp(OriginalComponent, 'Custom Value');
```

</CodeBlock>

### 2.3 å¤„ç†WrappedComponentçš„åç§°

<CodeBlock>

```jsx
import React from 'react';

// æ˜¾ç¤ºåç§°ï¼Œä¾¿äºè°ƒè¯•
function withName(WrappedComponent) {
  const EnhancedComponent = (props) => <WrappedComponent {...props} />;

  EnhancedComponent.displayName = `withName(${getDisplayName(WrappedComponent)})`;

  return EnhancedComponent;
}

function getDisplayName(WrappedComponent) {
  return WrappedComponent.displayName || WrappedComponent.name || 'Component';
}

// ä½¿ç”¨
function UserCard({ name }) {
  return <div>{name}</div>;
}

const EnhancedUserCard = withName(UserCard);
console.log(EnhancedUserCard.displayName); // "withName(UserCard)"
```

</CodeBlock>

---

## 3. å¸¸è§HOCæ¨¡å¼

### 3.1 æ¡ä»¶æ¸²æŸ“HOC

<CodeBlock>

```jsx
// æ ¹æ®æ¡ä»¶æ˜¾ç¤ºç»„ä»¶
function withCondition(WrappedComponent, condition) {
  return function EnhancedComponent(props) {
    if (!condition(props)) {
      return null; // æˆ–è¿”å›é»˜è®¤ç»„ä»¶
    }
    return <WrappedComponent {...props} />;
  };
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šæƒé™æ§åˆ¶
function withAuth(WrappedComponent) {
  return function AuthenticatedComponent(props) {
    const { isAuthenticated, user } = props;

    if (!isAuthenticated) {
      return <Redirect to="/login" />;
    }

    if (user && !user.hasPermission) {
      return <div>Access Denied</div>;
    }

    return <WrappedComponent {...props} />;
  };
}

// åº”ç”¨åˆ°ç»„ä»¶
const ProtectedDashboard = withAuth(Dashboard);
const AdminPanel = withAuth(AdminComponent, ({ user }) => user?.role === 'admin');
```

</CodeBlock>

### 3.2 æ•°æ®è·å–HOC

<CodeBlock>

```jsx
// æ•°æ®è·å–HOC
function withData(WrappedComponent, dataSource) {
  return function EnhancedComponent(props) {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
      const fetchData = async () => {
        try {
          setLoading(true);
          const result = await dataSource(props);
          setData(result);
        } catch (err) {
          setError(err);
        } finally {
          setLoading(false);
        }
      };

      fetchData();
    }, [props.id]); // ä¾èµ–propå˜åŒ–

    return (
      <WrappedComponent
        {...props}
        data={data}
        loading={loading}
        error={error}
      />
    );
  };
}

// ä½¿ç”¨
const fetchUser = async ({ userId }) => {
  const response = await fetch(`/api/users/${userId}`);
  return response.json();
};

const UserProfile = ({ user, loading, error }) => {
  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  return <div>{user.name}</div>;
};

const UserProfileWithData = withData(UserProfile, fetchUser);
```

</CodeBlock>

### 3.3 æ ·å¼å¢å¼ºHOC

<CodeBlock>

```jsx
// æ ·å¼å¢å¼ºHOC
function withStyles(WrappedComponent, styles) {
  return function StyledComponent(props) {
    const [isActive, setIsActive] = useState(false);
    const className = isActive ? `${styles.active} ${styles.base}` : styles.base;

    return (
      <div className={className}>
        <WrappedComponent
          {...props}
          isActive={isActive}
          setIsActive={setIsActive}
        />
      </div>
    );
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const cardStyles = {
  base: 'card',
  active: 'card-active'
};

const EnhancedCard = withStyles(Card, cardStyles);

// æˆ–è€…ä¼ é€’CSSç±»å
function withClassName(WrappedComponent, className) {
  return function EnhancedComponent(props) {
    return (
      <div className={className}>
        <WrappedComponent {...props} />
      </div>
    );
  };
}

const CenteredComponent = withClassName(MyComponent, 'mx-auto max-w-md');
```

</CodeBlock>

### 3.4 çŠ¶æ€ç®¡ç†HOC

<CodeBlock>

```jsx
// çŠ¶æ€æå‡HOC
function withState(WrappedComponent, initialState, stateName = 'state', setStateName = 'setState') {
  return function EnhancedComponent(props) {
    const [state, setState] = useState(initialState);

    const enhancedProps = {
      ...props,
      [stateName]: state,
      [setStateName]: setState
    };

    return <WrappedComponent {...enhancedProps} />;
  };
}

// ä½¿ç”¨
const EnhancedCounter = withState(Counter, 0, 'count', 'setCount');

function Counter({ count, setCount }) {
  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>Increment</button>
    </div>
  );
}

// æ›´çµæ´»çš„ç‰ˆæœ¬
function withFormState(WrappedComponent, initialValues) {
  return function EnhancedFormComponent(props) {
    const [values, setValues] = useState(initialValues);
    const [touched, setTouched] = useState({});
    const [errors, setErrors] = useState({});

    const handleChange = (name, value) => {
      setValues(prev => ({ ...prev, [name]: value }));
    };

    const handleBlur = (name) => {
      setTouched(prev => ({ ...prev, [name]: true }));
    };

    return (
      <WrappedComponent
        {...props}
        values={values}
        touched={touched}
        errors={errors}
        handleChange={handleChange}
        handleBlur={handleBlur}
      />
    );
  };
}
```

</CodeBlock>

### 3.5 äº‹ä»¶å¤„ç†HOC

<CodeBlock>

```jsx
// äº‹ä»¶å¤„ç†HOC
function withClickAnalytics(WrappedComponent, analytics) {
  return function EnhancedComponent(props) {
    const handleClick = useCallback((event) => {
      // è°ƒç”¨åŸå§‹å¤„ç†å‡½æ•°
      if (props.onClick) {
        props.onClick(event);
      }

      // å‘é€åˆ†ææ•°æ®
      analytics.track('component_clicked', {
        component: WrappedComponent.name,
        timestamp: Date.now()
      });
    }, [props.onClick, analytics]);

    return <WrappedComponent {...props} onClick={handleClick} />;
  };
}

// ä½¿ç”¨
const trackClick = {
  track: (event, data) => console.log(event, data)
};

const TrackedButton = withClickAnalytics(Button, trackClick);

// é”®ç›˜å¿«æ·é”®HOC
function withKeyboardShortcuts(WrappedComponent, shortcuts) {
  return function EnhancedComponent(props) {
    useEffect(() => {
      const handleKeyPress = (event) => {
        const key = event.key.toLowerCase();
        if (shortcuts[key]) {
          event.preventDefault();
          shortcuts[key](props);
        }
      };

      document.addEventListener('keydown', handleKeyPress);
      return () => document.removeEventListener('keydown', handleKeyPress);
    }, [shortcuts, props]);

    return <WrappedComponent {...props} />;
  };
}

const shortcuts = {
  's': () => console.log('Save action'),
  'd': () => console.log('Delete action')
};

const ShortcutEnabledComponent = withKeyboardShortcuts(MyComponent, shortcuts);
```

</CodeBlock>

---

## 4. é«˜çº§HOCæ¨¡å¼

### 4.1 é“¾å¼HOC

<CodeBlock>

```jsx
// é“¾å¼åº”ç”¨HOC
const EnhancedComponent = withAuth(
  withLoading(
    withStyles(MyComponent, styles)
  )
);

// æˆ–è€…ä½¿ç”¨composeå‡½æ•°
const compose = (...hocs) => (component) =>
  hocs.reduce((wrapped, hoc) => hoc(wrapped), component);

const enhance = compose(
  withAuth,
  withLoading,
  withStyles(styles),
  withKeyboardShortcuts(shortcuts)
);

const EnhancedComponent = enhance(MyComponent);
```

</CodeBlock>

### 4.2 ä¼ é€’Refs

<CodeBlock>

```jsx
// React.forwardRefä¼ é€’refs
import React, { forwardRef } from 'react';

function withRef(WrappedComponent) {
  // å¿…é¡»ä½¿ç”¨forwardRef
  const EnhancedComponent = forwardRef((props, ref) => {
    return <WrappedComponent ref={ref} {...props} />;
  });

  EnhancedComponent.displayName = `withRef(${getDisplayName(WrappedComponent)})`;

  return EnhancedComponent;
}

// ä½¿ç”¨
const EnhancedInput = withRef(Input);

function MyComponent() {
  const inputRef = useRef();

  useEffect(() => {
    // å¯ä»¥è®¿é—®åˆ°Inputçš„å®ä¾‹æ–¹æ³•
    inputRef.current.focus();
  }, []);

  return <EnhancedInput ref={inputRef} />;
}
```

</CodeBlock>

### 4.3 ç»§æ‰¿Propsä»£ç†æ¨¡å¼

<CodeBlock>

```jsx
// Propsä»£ç†HOC - æ“ä½œprops
function withPropsProxy(WrappedComponent) {
  return function EnhancedComponent(props) {
    // 1. æ“ä½œä¼ å…¥çš„props
    const modifiedProps = {
      ...props,
      className: `enhanced ${props.className || ''}`,
      onClick: (e) => {
        // å¢å¼ºç‚¹å‡»äº‹ä»¶
        console.log('Enhanced click');
        if (props.onClick) {
          props.onClick(e);
        }
      }
    };

    // 2. æ·»åŠ é¢å¤–props
    const addedProps = {
      theme: 'dark',
      locale: 'en-US'
    };

    // 3. æ¸²æŸ“åŒ…è£…ç»„ä»¶
    return <WrappedComponent {...modifiedProps} {...addedProps} />;
  };
}
```

</CodeBlock>

### 4.4 ç»§æ‰¿åå‘ä»£ç†æ¨¡å¼

<CodeBlock>

```jsx
// åå‘ä»£ç†HOC - åŠ«æŒç”Ÿå‘½å‘¨æœŸ
function withLifecycleProxy(WrappedComponent) {
  return class EnhancedComponent extends WrappedComponent {
    componentDidMount() {
      console.log('Enhanced component did mount');
      super.componentDidMount();
    }

    componentWillUnmount() {
      console.log('Enhanced component will unmount');
      super.componentWillUnmount();
    }

    render() {
      console.log('Enhanced component render');
      return super.render();
    }
  };
}

// æ³¨æ„ï¼šè¿™ç§æ¨¡å¼å·²ä¸æ¨èï¼Œä»…ç”¨äºç†è§£æ¦‚å¿µ
// Hooksæä¾›äº†æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ
```

</CodeBlock>

---

## 5. HOC vs Hooks

### 5.1 å¯¹æ¯”åˆ†æ

<Compare>

```jsx
// ä½¿ç”¨HOCçš„ä»£ç 
function withUser(WrappedComponent) {
  return function EnhancedComponent(props) {
    const { data, loading } = useUser();
    return <WrappedComponent {...props} user={data} loading={loading} />;
  };
}

const UserProfile = withUser(({ user, loading }) => {
  if (loading) return <div>Loading...</div>;
  return <div>{user.name}</div>;
});

// ä½¿ç”¨Hooksçš„ä»£ç 
function useUser() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchUser().then(setData);
  }, []);

  return { data, loading };
}

function UserProfile() {
  const { data: user, loading } = useUser();

  if (loading) return <div>Loading...</div>;
  return <div>{user.name}</div>;
}
```

</Compare>

### 5.2 é€‰æ‹©æŒ‡å—

<CodeBlock>

```jsx
// æ¨èä½¿ç”¨Hooksçš„åœºæ™¯
1. çŠ¶æ€é€»è¾‘å¤ç”¨ -> useState, useReducer
2. å‰¯ä½œç”¨é€»è¾‘ -> useEffect
3. ä¸Šä¸‹æ–‡å…±äº« -> useContext
4. æ€§èƒ½ä¼˜åŒ– -> useMemo, useCallback
5. è‡ªå®šä¹‰Hook -> åˆ›å»ºuseXxxå‡½æ•°

// æ¨èä½¿ç”¨HOCçš„åœºæ™¯
1. åº“å¼€å‘ (å¦‚Redux connect)
2. æ ·å¼å¢å¼º
3. ç±»ç»„ä»¶é¡¹ç›®
4. è·¨ç»„ä»¶æ ‘çš„åŠŸèƒ½æ³¨å…¥
```

</CodeBlock>

### 5.3 Hooksçš„ä¼˜åŠ¿

<CodeBlock>

```jsx
// Hooksä¼˜åŠ¿
1. æ›´å¥½çš„ç±»å‹æ”¯æŒ (TypeScript)
2. é¿å…åµŒå¥—åœ°ç‹±
3. ä¸å¼•å…¥é¢å¤–ç»„ä»¶å±‚çº§
4. æ›´çµæ´»çš„ç»„åˆæ–¹å¼
5. æ›´å¥½çš„è°ƒè¯•ä½“éªŒ
6. æ€§èƒ½æ›´å¥½ (æ— é¢å¤–ç»„ä»¶)

// HOCå±€é™
1. å‘½åå†²çª
2. ç»„ä»¶å±‚çº§å¢åŠ 
3. éš¾ä»¥ç†è§£propsæ¥æº
4. å¯èƒ½å¯¼è‡´é‡å¤æ¸²æŸ“
5. éš¾ä»¥è°ƒè¯•
```

</CodeBlock>

---

## 6. å®é™…åº”ç”¨åœºæ™¯

### 6.1 æƒé™æ§åˆ¶HOC

<CodeBlock>

```jsx
// å®Œæ•´çš„æƒé™æ§åˆ¶HOC
function withAuthorization(requiredRole) {
  return (WrappedComponent) => {
    return function AuthorizedComponent(props) {
      const { user, isLoading } = useAuth();

      if (isLoading) {
        return <div>Checking authorization...</div>;
      }

      if (!user) {
        return <Navigate to="/login" replace />;
      }

      if (user.role !== requiredRole) {
        return (
          <div className="access-denied">
            <h2>Access Denied</h2>
            <p>You don't have permission to view this page.</p>
            <p>Required role: {requiredRole}</p>
            <p>Your role: {user.role}</p>
          </div>
        );
      }

      return <WrappedComponent {...props} />;
    };
  };
}

// ä½¿ç”¨
const AdminDashboard = withAuthorization('admin')(Dashboard);
const SuperUserPanel = withAuthorization('superuser')(Panel);
```

</CodeBlock>

### 6.2 æ•°æ®ç¼“å­˜HOC

<CodeBlock>

```jsx
// æ™ºèƒ½ç¼“å­˜HOC
function withCache(WrappedComponent, options = {}) {
  const { ttl = 60000 } = options; // é»˜è®¤60ç§’

  return function CachedComponent(props) {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [lastFetch, setLastFetch] = useState(0);

    const { cacheKey, fetcher, refetch = false } = props;

    const fetchData = useCallback(async (force = false) => {
      const now = Date.now();
      const cachedData = getFromCache(cacheKey);

      // ä½¿ç”¨ç¼“å­˜
      if (!force && cachedData && now - lastFetch < ttl) {
        setData(cachedData);
        setLoading(false);
        return;
      }

      try {
        setLoading(true);
        const result = await fetcher();
        setData(result);
        setLastFetch(now);
        saveToCache(cacheKey, result);
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    }, [cacheKey, fetcher, lastFetch, ttl]);

    useEffect(() => {
      fetchData(refetch);
    }, [fetchData, refetch]);

    return (
      <WrappedComponent
        {...props}
        data={data}
        loading={loading}
        error={error}
        refetch={() => fetchData(true)}
      />
    );
  };
}

// ä½¿ç”¨
const UserListWithCache = withCache({
  cacheKey: 'user-list',
  fetcher: () => fetchUsers()
})(UserList);
```

</CodeBlock>

### 6.3 ä¸»é¢˜åˆ‡æ¢HOC

<CodeBlock>

```jsx
// ä¸»é¢˜HOC
function withTheme(WrappedComponent) {
  return function ThemedComponent(props) {
    const [theme, setTheme] = useState(() => {
      return localStorage.getItem('theme') || 'light';
    });

    const toggleTheme = useCallback(() => {
      setTheme(prevTheme => {
        const newTheme = prevTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        return newTheme;
      });
    }, []);

    useEffect(() => {
      document.body.setAttribute('data-theme', theme);
    }, [theme]);

    const themeProps = {
      theme,
      toggleTheme,
      isDark: theme === 'dark'
    };

    return <WrappedComponent {...props} {...themeProps} />;
  };
}

// ä½¿ç”¨
const ThemedHeader = withTheme(Header);

function Header({ theme, toggleTheme, isDark }) {
  return (
    <header className={`header ${isDark ? 'dark' : 'light'}`}>
      <h1>My App</h1>
      <button onClick={toggleTheme}>
        {isDark ? 'ğŸŒ' : 'ğŸŒ™'}
      </button>
    </header>
  );
}
```

</CodeBlock>

---

## 7. æœ€ä½³å®è·µ

### 7.1 å‘½åçº¦å®š

<CodeBlock>

```jsx
// âœ… å¥½çš„å‘½å
const withAuth = (WrappedComponent) => { };  // withXxx
const withLoading = (WrappedComponent) => { };
const withUserData = (WrappedComponent) => { };

// âŒ é¿å…çš„å‘½å
const auth = (WrappedComponent) => { };       // ç¼ºå°‘withå‰ç¼€
const makeAuth = (WrappedComponent) => { };   // makeXxxä¹Ÿå¯ä»¥ï¼Œä½†æ¨èwithXxx
const AuthHOC = (WrappedComponent) => { };    // ä½¿ç”¨é©¼å³°è€Œä¸æ˜¯PascalCase

// âœ… å‘½åDisplayName
function withAuth(WrappedComponent) {
  const EnhancedComponent = (props) => <WrappedComponent {...props} />;
  EnhancedComponent.displayName = `withAuth(${WrappedComponent.displayName || WrappedComponent.name})`;
  return EnhancedComponent;
}
```

</CodeBlock>

### 7.2 Propsä¼ é€’

<CodeBlock>

```jsx
// âœ… æ­£ç¡®ä¼ é€’æ‰€æœ‰props
function withExtraProp(WrappedComponent) {
  return function EnhancedComponent(props) {
    return <WrappedComponent {...props} extraProp="value" />;
  };
}

// âŒ é”™è¯¯ - ä¸ä¼ é€’æœªä½¿ç”¨çš„props
function withExtraProp(WrappedComponent) {
  return function EnhancedComponent(props) {
    const { name, ...otherProps } = props;
    return <WrappedComponent name={name} {...otherProps} extraProp="value" />;
  };
}

// æˆ–è€…æ˜ç¡®è¿‡æ»¤
function withOnlyUserProps(WrappedComponent) {
  return function EnhancedComponent(props) {
    return <WrappedComponent user={props.user} />;
  };
}
```

</CodeBlock>

### 7.3 é¿å…å‘½åå†²çª

<CodeBlock>

```jsx
// âœ… ä½¿ç”¨å”¯ä¸€å‘½åç©ºé—´
function withUser(WrappedComponent) {
  return function EnhancedComponent(props) {
    const userData = useUser();
    return (
      <WrappedComponent
        {...props}
        userData={userData}  // ä¸ç›´æ¥è¦†ç›–user
      />
    );
  };
}

// âœ… ä½¿ç”¨å‰ç¼€
function withUser(WrappedComponent) {
  return function EnhancedComponent(props) {
    return (
      <WrappedComponent
        {...props}
        withUserUserData={useUser()}  // å‰ç¼€
      />
    );
  };
}

// âœ… ä¼ é€’æ‰€æœ‰propsè®©ç»„ä»¶è‡ªå·±å¤„ç†
function withUser(WrappedComponent) {
  return function EnhancedComponent(props) {
    const userData = useUser();
    return <WrappedComponent {...props} userData={userData} />;
  };
}
```

</CodeBlock>

### 7.4 è°ƒè¯•å’Œå¼€å‘ä½“éªŒ

<CodeBlock>

```jsx
// æ·»åŠ displayName
function withAuth(WrappedComponent) {
  const AuthComponent = (props) => {
    // ...é€»è¾‘
    return <WrappedComponent {...props} />;
  };

  AuthComponent.displayName = `withAuth(${getDisplayName(WrappedComponent)})`;
  return AuthComponent;
}

// æ·»åŠ propTypes
import PropTypes from 'prop-types';

function withAuth(WrappedComponent) {
  const AuthComponent = (props) => {
    // ...é€»è¾‘
    return <WrappedComponent {...props} />;
  };

  AuthComponent.propTypes = {
    isAuthenticated: PropTypes.bool,
    user: PropTypes.object
  };

  AuthComponent.displayName = `withAuth(${getDisplayName(WrappedComponent)})`;
  return AuthComponent;
}

// React DevToolsæ”¯æŒ
import { setDisplayName } from 'recompose';

const withAuth = compose(
  setDisplayName('withAuth'),
  wrapDisplayName,
  withLogic
);
```

</CodeBlock>

---

## 8. å¸¸è§é™·é˜±

### é™·é˜±1ï¼šä¸¢å¤±Ref

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - refä¸ä¼šä¼ é€’
function withAuth(WrappedComponent) {
  return function AuthComponent(props) {
    const { isAuthenticated } = useAuth();
    return <WrappedComponent {...props} />;
  };
}

// è§£å†³ - ä½¿ç”¨forwardRef
import { forwardRef } from 'react';

function withAuth(WrappedComponent) {
  const AuthComponent = forwardRef((props, ref) => {
    const { isAuthenticated } = useAuth();
    return <WrappedComponent ref={ref} {...props} />;
  });

  AuthComponent.displayName = `withAuth(${getDisplayName(WrappedComponent)})`;
  return AuthComponent;
}
```

</ErrorBox>

### é™·é˜±2ï¼šå‘½åå†²çª

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - è¦†ç›–ç°æœ‰props
function withExtraProps(WrappedComponent) {
  return function EnhancedComponent(props) {
    // ä¼šè¦†ç›–ç»„ä»¶çš„data prop
    return <WrappedComponent {...props} data={{ new: 'data' }} />;
  };
}

// âœ… æ­£ç¡® - é¿å…å†²çª
function withExtraProps(WrappedComponent) {
  return function EnhancedComponent(props) {
    return <WrappedComponent {...props} extraData={{ new: 'data' }} />;
  };
}
```

</ErrorBox>

### é™·é˜±3ï¼šå¾ªç¯ä¾èµ–

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - å¾ªç¯ä¾èµ–
function withAuth(WrappedComponent) {
  const AuthComponent = () => <WrappedComponent />;
  return AuthComponent;
}

function withPermission(WrappedComponent) {
  const PermissionComponent = () => <WrappedComponent />;
  return PermissionComponent;
}

// å¦‚æœä¸¤ä¸ªç»„ä»¶ç›¸äº’åŒ…è£…ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–
```

</ErrorBox>

### é™·é˜±4ï¼šç»„ä»¶å®ä¾‹

<ErrorBox>

```jsx
// âŒ ä¸è¦åœ¨HOCä¸­å®ä¾‹åŒ–ç»„ä»¶
function withAuth(WrappedComponent) {
  return function AuthComponent(props) {
    return <WrappedComponent />; // âŒ æ²¡æœ‰ä¼ é€’props
  };
}

// âœ… æ­£ç¡®ä¼ é€’props
function withAuth(WrappedComponent) {
  return function AuthComponent(props) {
    return <WrappedComponent {...props} />; // âœ… ä¼ é€’æ‰€æœ‰props
  };
}
```

</ErrorBox>

---

## 9. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šåˆ›å»ºwithLoading HOC

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- åŒ…è£…ç»„ä»¶æ˜¾ç¤ºloadingçŠ¶æ€
- æ”¯æŒè‡ªå®šä¹‰loadingç»„ä»¶
- å¯é…ç½®å»¶è¿Ÿæ—¶é—´ï¼ˆé¿å…é—ªçƒï¼‰
- ä¼ é€’loadingçŠ¶æ€ç»™åŒ…è£…ç»„ä»¶

**å®ç°è¦æ±‚**ï¼š
```javascript
const EnhancedComponent = withLoading({
  delay: 500, // 500mså»¶è¿Ÿ
  loader: <Spinner /> // è‡ªå®šä¹‰loadingç»„ä»¶
})(MyComponent);
```

**æç¤º**ï¼š
- ä½¿ç”¨useStateç®¡ç†loadingçŠ¶æ€
- ä½¿ç”¨useEffectè§¦å‘loading
- ä½¿ç”¨setTimeoutå®ç°å»¶è¿Ÿ

</Expandable>

### ç»ƒä¹ 2ï¼šåˆ›å»ºwithFormValidation HOC

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- è¡¨å•éªŒè¯HOC
- æ”¯æŒå®æ—¶éªŒè¯å’Œæäº¤æ—¶éªŒè¯
- å¯é…ç½®éªŒè¯è§„åˆ™
- ä¼ é€’éªŒè¯çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

**å®ç°è¦æ±‚**ï¼š
```javascript
const rules = {
  email: { required: true, pattern: /^\S+@\S+$/ },
  password: { required: true, minLength: 6 }
};

const ValidatedForm = withFormValidation({
  rules
})(FormComponent);
```

**æ•°æ®ç»“æ„**ï¼š
- errors: 
```js
{ fieldName: errorMessage }
```

- touched:
```js
{ fieldName: boolean }
```

- validate:
```js
 (field, value) => string
```
**æç¤º**ï¼š
- ä½¿ç”¨useStateç®¡ç†çŠ¶æ€
- å®ç°éªŒè¯å‡½æ•°
- å¤„ç†blurå’Œchangeäº‹ä»¶

</Expandable>

### ç»ƒä¹ 3ï¼šåˆ›å»ºwithInfiniteScroll HOC

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ— é™æ»šåŠ¨HOC
- æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤š
- å¯é…ç½®é˜ˆå€¼ï¼ˆè·ç¦»åº•éƒ¨å¤šå°‘pxæ—¶è§¦å‘ï¼‰
- æ”¯æŒåŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†

**å®ç°è¦æ±‚**ï¼š
```javascript
const InfiniteList = withInfiniteScroll({
  threshold: 200, // è·ç¦»åº•éƒ¨200pxæ—¶åŠ è½½
  loadMore: fetchNextPage // åŠ è½½æ›´å¤šå‡½æ•°
})(ListComponent);
```

**æç¤º**ï¼š
- ä½¿ç”¨useEffectç›‘å¬æ»šåŠ¨äº‹ä»¶
- è®¡ç®—scrollTopå’ŒclientHeight
- ä½¿ç”¨Intersection Observer API (å¯é€‰)

</Expandable>

### ç»ƒä¹ 4ï¼šåˆ›å»ºwithKeyboardShortcuts HOC

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- é”®ç›˜å¿«æ·é”®HOC
- æ”¯æŒå¤šä¸ªå¿«æ·é”®
- å¿«æ·é”®å†²çªå¤„ç†
- å¯ç¦ç”¨ç‰¹å®šå¿«æ·é”®

**å®ç°è¦æ±‚**ï¼š
```javascript
const shortcuts = {
  'ctrl+s': { handler: onSave, description: 'Save' },
  'ctrl+z': { handler: onUndo, description: 'Undo' },
  '?': { handler: showHelp, description: 'Show help' }
};

const ShortcutComponent = withKeyboardShortcuts({ shortcuts })(MyComponent);
```

**æç¤º**ï¼š
- ä½¿ç”¨useEffectæ·»åŠ äº‹ä»¶ç›‘å¬
- å¤„ç†keydownäº‹ä»¶
- é¿å…åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘
- æ·»åŠ å…¨å±€å¿«æ·é”®æç¤º

</Expandable>

---

## 10. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… é«˜é˜¶ç»„ä»¶æ˜¯æ¥æ”¶ç»„ä»¶å¹¶è¿”å›æ–°ç»„ä»¶çš„å‡½æ•°
- âœ… HOCç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘ï¼ˆä¸»è¦åœ¨Hooksä¹‹å‰ï¼‰
- âœ… ä½¿ç”¨withXxxå‘½åçº¦å®š
- âœ… è®¾ç½®displayNameä¾¿äºè°ƒè¯•
- âœ… ä½¿ç”¨forwardRefä¼ é€’refs
- âœ… é¿å…å‘½åå†²çª
- âœ… æ¨èä¼˜å…ˆä½¿ç”¨Hooksè€Œä¸æ˜¯HOC
- âœ… HOCä»é€‚ç”¨äºåº“å¼€å‘ï¼ˆå¦‚Reduxï¼‰
- âœ… ä¼ é€’æ‰€æœ‰propsç»™åŒ…è£…ç»„ä»¶
- âœ… é¿å…å¾ªç¯ä¾èµ–

</Checklist>

### HOC vs Hooksé€‰æ‹©æŒ‡å—

<BestPractices>

1. **æ–°çš„é€»è¾‘å¤ç”¨** - ä¼˜å…ˆä½¿ç”¨Hooks
2. **ç±»ç»„ä»¶é¡¹ç›®** - å¯ä»¥ä½¿ç”¨HOC
3. **åº“å¼€å‘** - HOCä»æœ‰ä»·å€¼
4. **æ ·å¼å¢å¼º** - æ¨èä½¿ç”¨HOCæˆ–CSS-in-JS
5. **å¤æ‚é€»è¾‘** - ä½¿ç”¨è‡ªå®šä¹‰Hook
6. **éœ€è¦ä¿ç•™Refs** - ä½¿ç”¨forwardRef with HOC

</BestPractices>

### å¸¸è§HOCç±»å‹

**çŠ¶æ€ç±»**ï¼š
- `withState` - æ·»åŠ state
- `withFormState` - è¡¨å•çŠ¶æ€
- `withLocalStorage` - æœ¬åœ°å­˜å‚¨

**æ•°æ®ç±»**ï¼š
- `withData` - æ•°æ®è·å–
- `withCache` - ç¼“å­˜
- `withSubscription` - è®¢é˜…

**è¡Œä¸ºç±»**ï¼š
- `withAuth` - æƒé™æ§åˆ¶
- `withClickAnalytics` - ç‚¹å‡»è¿½è¸ª
- `withKeyboardShortcuts` - é”®ç›˜å¿«æ·é”®

**æ¸²æŸ“ç±»**ï¼š
- `withLoading` - åŠ è½½çŠ¶æ€
- `withErrorBoundary` - é”™è¯¯è¾¹ç•Œ
- `withStyles` - æ ·å¼å¢å¼º

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†HOCï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š

1. **[æ¸²æŸ“å±æ€§æ¨¡å¼](render-props)** - ç†è§£å¦ä¸€ç§é€»è¾‘å¤ç”¨æ–¹å¼
2. **[å¤åˆç»„ä»¶](compound-components)** - å­¦ä¹ ç»„ä»¶ç»„åˆæŠ€å·§
3. **[å®¹å™¨-å±•ç¤ºæ¨¡å¼](container-presentational)** - æŒæ¡ç»„ä»¶åˆ†ç¦»
4. **[Hooksæ¨¡å¼](../advanced/hooks-patterns)** - ç°ä»£é€»è¾‘å¤ç”¨æ–¹å¼

---

## 11. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [é«˜é˜¶ç»„ä»¶](https://react.dev/reference/react) - Reactå®˜æ–¹æ–‡æ¡£
- [Forwarding Refs](https://react.dev/reference/react/forwardRef) - Refè½¬å‘
- [Render Props](https://react.dev/reference/react) - æ¸²æŸ“å±æ€§æ¨¡å¼

### æ¨èé˜…è¯»

- [HOC vs Render Props](https://kentcdodds.com/blog/aha-moments-when-learning-react) - æ¨¡å¼å¯¹æ¯”
- [Recomposeåº“](https://github.com/acdlite/recompose) - HOCå·¥å…·åº“
- [Why React Hooks are Better than HOCs](https://kentcdodds.com/blog/how-to-control-the-boilerplate-with-react-higher-order-components) - Hooksä¼˜åŠ¿

### è¿ç§»æŒ‡å—

- [ä»HOCåˆ°Hooks](https://kentcdodds.com/blog/application-state-management-with-react) - è¿ç§»ç­–ç•¥
- [æ··åˆä½¿ç”¨](https://react.dev/reference/react) - HOCå’ŒHookså…±å­˜

---

[â† ä¸Šä¸€ç« ï¼šå‡½æ•°å¼ç»„ä»¶](functional-components) | [ä¸‹ä¸€ç« ï¼šæ¸²æŸ“å±æ€§æ¨¡å¼ â†’](render-props)
