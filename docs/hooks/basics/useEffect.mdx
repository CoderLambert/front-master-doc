# useEffect - å‰¯ä½œç”¨å¤„ç†

import { Tabs, TabItem } from '@docusaurus/theme-common';

`useEffect`æ˜¯React Hooksç³»ç»Ÿä¸­æœ€é‡è¦çš„Hookä¹‹ä¸€ï¼Œå®ƒç”¨äºå¤„ç†ç»„ä»¶ä¸­çš„å‰¯ä½œç”¨ï¼ˆSide Effectsï¼‰ã€‚å‰¯ä½œç”¨æ˜¯æŒ‡é‚£äº›å½±å“ç»„ä»¶å¤–éƒ¨ä¸–ç•Œçš„æ“ä½œï¼Œå¦‚æ•°æ®è·å–ã€è®¢é˜…ã€DOMæ“ä½œç­‰ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å…¨é¢å­¦ä¹ useEffectçš„ä½¿ç”¨æ–¹æ³•ã€ä¾èµ–æ•°ç»„çš„å·¥ä½œåŸç†ä»¥åŠæœ€ä½³å®è·µã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£useEffectçš„ä½œç”¨å’Œæ—¶æœº
- æŒæ¡useEffectçš„åŸºæœ¬è¯­æ³•
- å­¦ä¼šä½¿ç”¨ä¾èµ–æ•°ç»„æ§åˆ¶æ‰§è¡Œæ—¶æœº
- ç†è§£æ¸…ç†å‡½æ•°çš„ä½œç”¨
- æŒæ¡å¸¸è§useEffectç”¨ä¾‹
- é¿å…useEffectçš„å¸¸è§é”™è¯¯å’Œé™·é˜±
- ç†è§£useEffectä¸ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»

---

## 1. ä»€ä¹ˆæ˜¯useEffectï¼Ÿ

useEffectæ˜¯Reactæä¾›çš„Hookï¼Œç”¨äºåœ¨å‡½æ•°ç»„ä»¶ä¸­æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œã€‚å®ƒè®©å‡½æ•°ç»„ä»¶èƒ½å¤Ÿå®Œæˆç±»ç»„ä»¶ä¸­`componentDidMount`ã€`componentDidUpdate`å’Œ`componentWillUnmount`çš„å·¥ä½œã€‚

<Box style={{ padding: '20px', background: '#e8f5e9', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#2e7d32' }}>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>å‰¯ä½œç”¨ï¼ˆSide Effectï¼‰</strong>æ˜¯æŒ‡é‚£äº›ä¸åœ¨å‡½æ•°è®¡ç®—èŒƒå›´å†…çš„æ“ä½œï¼Œå¦‚ï¼šæ•°æ®è·å–ã€è®¾ç½®è®¢é˜…ã€æ‰‹åŠ¨ä¿®æ”¹DOMã€è®°å½•æ—¥å¿—ç­‰ã€‚
  </p>
</Box>

### 1.1 åŸºæœ¬è¯­æ³•

```javascript
useEffect(() => {
  // æ‰§è¡Œå‰¯ä½œç”¨
  return () => {
    // æ¸…ç†å‰¯ä½œç”¨
  };
}, [dependencies]);
```

- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ‰§è¡Œå‰¯ä½œç”¨çš„å‡½æ•°
- ç¬¬äºŒä¸ªå‚æ•°ï¼šä¾èµ–æ•°ç»„ï¼ˆå¯é€‰ï¼‰
- è¿”å›å€¼ï¼šæ¸…ç†å‡½æ•°ï¼ˆå¯é€‰ï¼‰

### 1.2 ç®€å•ç¤ºä¾‹

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function Example() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    // æ¯æ¬¡countå˜åŒ–æ—¶æ‰§è¡Œ
    document.title = `ç‚¹å‡»äº† ${count} æ¬¡`;
  }, [count]);  // ä¾èµ–æ•°ç»„ï¼šåªæœ‰countå˜åŒ–æ—¶æ‰æ‰§è¡Œ

  return (
    <div>
      <p>ç‚¹å‡»æ¬¡æ•°: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        ç‚¹å‡»
      </button>
    </div>
  );
}
```

</CodeBlock>

---

## 2. useEffectçš„æ‰§è¡Œæ—¶æœº

### 2.1 æ¯æ¬¡æ¸²æŸ“åæ‰§è¡Œ

ä¸æä¾›ä¾èµ–æ•°ç»„æ—¶ï¼ŒuseEffectåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œï¼š

<CodeBlock>

```jsx
function EffectOnEveryRender() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('ç»„ä»¶æ¸²æŸ“äº†ï¼Œå½“å‰count:', count);
    // æ¯æ¬¡ç»„ä»¶æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œ
  });  // æ²¡æœ‰ä¾èµ–æ•°ç»„

  return (
    <button onClick={() => setCount(count + 1)}>
      ç‚¹å‡»: {count}
    </button>
  );
}
```

</CodeBlock>

### 2.2 é¦–æ¬¡æ¸²æŸ“åæ‰§è¡Œ

æä¾›ç©ºä¾èµ–æ•°ç»„æ—¶ï¼ŒuseEffectåªåœ¨é¦–æ¬¡æ¸²æŸ“åæ‰§è¡Œä¸€æ¬¡ï¼š

<CodeBlock>

```jsx
function EffectOnMount() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('ç»„ä»¶é¦–æ¬¡æŒ‚è½½');
    // åªåœ¨é¦–æ¬¡æ¸²æŸ“åæ‰§è¡Œä¸€æ¬¡
  }, []);  // ç©ºä¾èµ–æ•°ç»„

  return (
    <button onClick={() => setCount(count + 1)}>
      ç‚¹å‡»: {count}
    </button>
  );
}
```

</CodeBlock>

### 2.3 ä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œ

æä¾›ä¾èµ–æ•°ç»„æ—¶ï¼ŒuseEffectåœ¨é¦–æ¬¡æ¸²æŸ“å’Œä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œï¼š

<CodeBlock>

```jsx
function EffectOnDependencyChange() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('Alice');

  useEffect(() => {
    console.log('countå˜åŒ–äº†:', count);
    // å½“countå˜åŒ–æ—¶æ‰§è¡Œ
  }, [count]);  // ä¾èµ–count

  useEffect(() => {
    console.log('nameå˜åŒ–äº†:', name);
    // å½“nameå˜åŒ–æ—¶æ‰§è¡Œ
  }, [name]);  // ä¾èµ–name

  return (
    <div>
      <button onClick={() => setCount(count + 1)}>
        è®¡æ•°: {count}
      </button>
      <button onClick={() => setName('Bob')}>
        æ”¹åä¸º: {name}
      </button>
    </div>
  );
}
```

</CodeBlock>

---

## 3. æ¸…ç†å‰¯ä½œç”¨

useEffectå¯ä»¥è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œç”¨äºå–æ¶ˆå‰¯ä½œç”¨ï¼ˆå¦‚å–æ¶ˆè®¢é˜…ã€æ¸…é™¤å®šæ—¶å™¨ç­‰ï¼‰ï¼š

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function CleanupExample() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    // è®¾ç½®å®šæ—¶å™¨
    const timer = setInterval(() => {
      console.log('å®šæ—¶å™¨æ‰§è¡Œï¼Œcount:', count);
    }, 1000);

    // æ¸…ç†å‡½æ•°ï¼šæ¸…é™¤å®šæ—¶å™¨
    return () => {
      clearInterval(timer);
      console.log('æ¸…ç†å®šæ—¶å™¨');
    };
  }, [count]);  // countå˜åŒ–æ—¶ï¼Œä¼šå…ˆæ¸…ç†æ—§çš„ï¼Œå†åˆ›å»ºæ–°çš„

  return (
    <div>
      <p>count: {count}</p>
      <button onClick={() => setCount(count + 1)}>å¢åŠ </button>
    </div>
  );
}
```

</CodeBlock>

<Box style={{ padding: '20px', background: '#fff3e0', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#e65100' }}>âš ï¸ é‡è¦æç¤º</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>æ¸…ç†å‡½æ•°åœ¨ç»„ä»¶å¸è½½å‰å’Œä¸‹æ¬¡effectæ‰§è¡Œå‰éƒ½ä¼šè¢«è°ƒç”¨</strong>ï¼Œç¡®ä¿ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚
  </p>
</Box>

---

## 4. å¸¸è§ç”¨ä¾‹

### 4.1 æ•°æ®è·å–

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function DataFetching() {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    // è·å–ç”¨æˆ·æ•°æ®
    const fetchUsers = async () => {
      try {
        setLoading(true);
        const response = await fetch('/api/users');
        const data = await response.json();
        setUsers(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);  // åªåœ¨é¦–æ¬¡åŠ è½½æ—¶è·å–æ•°æ®

  if (loading) return <p>åŠ è½½ä¸­...</p>;
  if (error) return <p>é”™è¯¯: {error}</p>;

  return (
    <ul>
      {users.map(user => (
        <li key={user.id}>{user.name}</li>
      ))}
    </ul>
  );
}
```

</CodeBlock>

### 4.2 è®¢é˜…äº‹ä»¶

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function EventSubscription() {
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    const handleMouseMove = (event) => {
      setMousePosition({
        x: event.clientX,
        y: event.clientY
      });
    };

    // è®¢é˜…é¼ æ ‡ç§»åŠ¨äº‹ä»¶
    window.addEventListener('mousemove', handleMouseMove);

    // æ¸…ç†å‡½æ•°ï¼šå–æ¶ˆè®¢é˜…
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
    };
  }, []);  // åªéœ€è¦è®¢é˜…ä¸€æ¬¡

  return (
    <p>
      é¼ æ ‡ä½ç½®: ({mousePosition.x}, {mousePosition.y})
    </p>
  );
}
```

</CodeBlock>

### 4.3 ä¿®æ”¹DOM

<CodeBlock>

```jsx
import { useEffect } from 'react';

function DOMManipulation() {
  useEffect(() => {
    // ä¿®æ”¹é¡µé¢æ ‡é¢˜
    const originalTitle = document.title;
    document.title = 'é¡µé¢å·²æ¿€æ´»';

    // æ¸…ç†å‡½æ•°ï¼šæ¢å¤åŸå§‹æ ‡é¢˜
    return () => {
      document.title = originalTitle;
    };
  }, []);

  return <div>æŸ¥çœ‹æµè§ˆå™¨æ ‡ç­¾é¡µæ ‡é¢˜</div>;
}
```

</CodeBlock>

### 4.4 æœ¬åœ°å­˜å‚¨

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function LocalStorageSync() {
  const [theme, setTheme] = useState('light');

  // ä»localStorageè¯»å–åˆå§‹å€¼
  useEffect(() => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setTheme(savedTheme);
    }
  }, []);

  // ä¸»é¢˜å˜åŒ–æ—¶ä¿å­˜åˆ°localStorage
  useEffect(() => {
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme(prev => prev === 'light' ? 'dark' : 'light');
  };

  return (
    <button onClick={toggleTheme}>
      å½“å‰ä¸»é¢˜: {theme}
    </button>
  );
}
```

</CodeBlock>

---

## 5. æ¡ä»¶æ‰§è¡ŒEffect

é€šè¿‡ä¾èµ–æ•°ç»„æ§åˆ¶effectçš„æ‰§è¡Œæ—¶æœºï¼š

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function ConditionalEffect() {
  const [userId, setUserId] = useState(null);
  const [userData, setUserData] = useState(null);

  // åªæœ‰å½“userIdå­˜åœ¨æ—¶æ‰è·å–ç”¨æˆ·æ•°æ®
  useEffect(() => {
    if (userId) {
      const fetchUserData = async () => {
        const response = await fetch(`/api/users/${userId}`);
        const data = await response.json();
        setUserData(data);
      };
      fetchUserData();
    }
  }, [userId]);  // userIdå˜åŒ–æ—¶é‡æ–°è·å–

  return (
    <div>
      <button onClick={() => setUserId(1)}>
        åŠ è½½ç”¨æˆ·1
      </button>
      <button onClick={() => setUserId(2)}>
        åŠ è½½ç”¨æˆ·2
      </button>
      <button onClick={() => setUserId(null)}>
        æ¸…ç©º
      </button>
      {userData && <p>ç”¨æˆ·: {userData.name}</p>}
    </div>
  );
}
```

</CodeBlock>

---

## 6. å¤šä¸ªEffect

ä¸€ä¸ªç»„ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªuseEffectï¼ŒæŒ‰é¡ºåºæ‰§è¡Œï¼š

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function MultipleEffects() {
  const [count, setCount] = useState(0);
  const [isOnline, setIsOnline] = useState(true);

  // Effect 1: è·Ÿè¸ªåœ¨çº¿çŠ¶æ€
  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  // Effect 2: æ›´æ–°æ ‡é¢˜
  useEffect(() => {
    document.title = `è®¡æ•°: ${count}`;
  }, [count]);

  // Effect 3: è®°å½•æ—¥å¿—
  useEffect(() => {
    console.log('åœ¨çº¿çŠ¶æ€å˜åŒ–:', isOnline);
  }, [isOnline]);

  return (
    <div>
      <p>åœ¨çº¿çŠ¶æ€: {isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}</p>
      <p>è®¡æ•°: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        +1
      </button>
    </div>
  );
}
```

</CodeBlock>

---

## 7. å¼‚æ­¥Effect

useEffectä¸­çš„å¼‚æ­¥æ“ä½œéœ€è¦ä½¿ç”¨async/awaitï¼š

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function AsyncEffect() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // å®šä¹‰å¼‚æ­¥å‡½æ•°
    const fetchData = async () => {
      setLoading(true);
      try {
        const response = await fetch('https://api.github.com/users/octocat');
        const result = await response.json();
        setData(result);
      } catch (error) {
        console.error('è·å–æ•°æ®å¤±è´¥:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  if (loading) return <p>åŠ è½½ä¸­...</p>;
  if (data) return <p>ç”¨æˆ·å: {data.login}</p>;
  return <p>æš‚æ— æ•°æ®</p>;
}
```

</CodeBlock>

<Box style={{ padding: '20px', background: '#ffebee', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#c62828' }}>âš ï¸ é‡è¦æç¤º</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>æ³¨æ„</strong>ï¼šä¸èƒ½ç›´æ¥åœ¨useEffectä¸­å†™<code>async</code>å‡½æ•°ã€‚éœ€è¦åœ¨å†…éƒ¨å®šä¹‰å¼‚æ­¥å‡½æ•°å¹¶è°ƒç”¨ã€‚
  </p>
</Box>

---

## 8. ä¾èµ–æ•°ç»„è¯¦è§£

### 8.1 ç©ºä¾èµ–æ•°ç»„

åªåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶æ‰§è¡Œä¸€æ¬¡ï¼š

<CodeBlock>

```jsx
// ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œï¼Œç±»ä¼¼ componentDidMount
useEffect(() => {
  const subscription = createSubscription();
  return () => {
    subscription.unsubscribe();  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  };
}, []);  // ç©ºæ•°ç»„
```

</CodeBlock>

### 8.2 ä¸€ä¸ªä¾èµ–

<CodeBlock>

```jsx
// å½“userIdå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
useEffect(() => {
  fetchUserData(userId);
}, [userId]);  // userIdæ˜¯ä¾èµ–
```

</CodeBlock>

### 8.3 å¤šä¸ªä¾èµ–

<CodeBlock>

```jsx
// å½“userIdæˆ–filterå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
useEffect(() => {
  fetchUsers(userId, filter);
}, [userId, filter]);  // å¤šä¸ªä¾èµ–
```

</CodeBlock>

### 8.4 æ— ä¾èµ–æ•°ç»„

<CodeBlock>

```jsx
// æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œ
useEffect(() => {
  console.log('æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œ');
});  // æ²¡æœ‰ä¾èµ–æ•°ç»„
```

</CodeBlock>

---

## 9. å¸¸è§é”™è¯¯ä¸é™·é˜±

### 9.1 å¿˜è®°ä¾èµ–æ•°ç»„

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç¼ºå°‘ä¾èµ–
function BadExample() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = `è®¡æ•°: ${count}`;
    // ç¼ºå°‘ä¾èµ–æ•°ç»„ï¼
  });

  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}

// âœ… æ­£ç¡®
function GoodExample() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = `è®¡æ•°: ${count}`;
  }, [count]);  // æ·»åŠ ä¾èµ–

  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}
```

</ErrorBox>

### 9.2 ä¾èµ–æ•°ç»„è¿‡å¤š

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ä¸å¿…è¦çš„ä¾èµ–
function BadExample() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = 'å›ºå®šæ ‡é¢˜';
  }, [count]);  // countå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œï¼Œä½†æ ‡é¢˜ä¸å˜ï¼

  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}

// âœ… æ­£ç¡®
function GoodExample() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = 'å›ºå®šæ ‡é¢˜';
  }, []);  // ä¸ä¾èµ–ä»»ä½•å€¼

  return <button onClick={() => setCount(count + 1)}>{count}</button>;
}
```

</ErrorBox>

### 9.3 åœ¨effectä¸­ç›´æ¥ä½¿ç”¨async

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - å¼‚æ­¥å‡½æ•°ä½œä¸ºeffect
function BadExample() {
  useEffect(async () => {
    const data = await fetchData();  // é”™è¯¯ï¼
  }, []);
}

// âœ… æ­£ç¡® - å†…éƒ¨å®šä¹‰å¼‚æ­¥å‡½æ•°
function GoodExample() {
  useEffect(() => {
    const fetchData = async () => {
      const data = await fetchData();
    };
    fetchData();
  }, []);
}
```

</ErrorBox>

### 9.4 æ— é™å¾ªç¯

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ä¾èµ–ä¸å½“å¯¼è‡´æ— é™å¾ªç¯
function BadExample() {
  const [data, setData] = useState(null);

  useEffect(() => {
    fetchData().then(setData);  // è®¾ç½®dataè§¦å‘é‡æ–°æ¸²æŸ“
  }, [data]);  // dataå˜åŒ–åˆè§¦å‘effectï¼

  return <div>{data}</div>;
}

// âœ… æ­£ç¡® - ç§»é™¤ä¸å½“ä¾èµ–
function GoodExample() {
  const [data, setData] = useState(null);

  useEffect(() => {
    let mounted = true;
    fetchData().then(result => {
      if (mounted) setData(result);
    });
    return () => { mounted = false; };
  }, []);  // åªæ‰§è¡Œä¸€æ¬¡

  return <div>{data}</div>;
}
```

</ErrorBox>

### 9.5 å¿˜è®°æ¸…ç†

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - æ²¡æœ‰æ¸…ç†å‰¯ä½œç”¨
function BadExample() {
  useEffect(() => {
    const timer = setInterval(() => {
      console.log('å®šæ—¶å™¨æ‰§è¡Œ');
    }, 1000);
    // æ²¡æœ‰æ¸…ç†å‡½æ•°ï¼
  }, []);

  return <div>å®šæ—¶å™¨</div>;
}

// âœ… æ­£ç¡®
function GoodExample() {
  useEffect(() => {
    const timer = setInterval(() => {
      console.log('å®šæ—¶å™¨æ‰§è¡Œ');
    }, 1000);

    return () => {
      clearInterval(timer);  // æ¸…ç†å®šæ—¶å™¨
    };
  }, []);

  return <div>å®šæ—¶å™¨</div>;
}
```

</ErrorBox>

---

## 10. é«˜çº§ç”¨æ³•

### 10.1 ä½¿ç”¨Refå­˜å‚¨å¯å˜å€¼

<CodeBlock>

```jsx
import { useEffect, useRef } from 'react';

function UseRefInEffect() {
  const countRef = useRef(0);
  const [count, setCount] = useState(0);

  useEffect(() => {
    countRef.current = count;
    console.log('å½“å‰è®¡æ•°:', count);
  }, [count]);

  useEffect(() => {
    // å¯ä»¥åœ¨å…¶ä»–effectä¸­è¯»å–refå€¼
    console.log('ä¸Šæ¬¡è®¡æ•°:', countRef.current);
  }, []);

  return (
    <button onClick={() => setCount(count + 1)}>
      ç‚¹å‡»: {count}
    </button>
  );
}
```

</CodeBlock>

### 10.2 æ¡ä»¶effect

<CodeBlock>

```jsx
import { useEffect } from 'react';

function ConditionalEffect({ user, isLoggedIn }) {
  useEffect(() => {
    if (!isLoggedIn) return;

    // åªæœ‰ç™»å½•åæ‰è®°å½•ç”¨æˆ·è¡Œä¸º
    trackUserBehavior(user.id);
  }, [user, isLoggedIn]);  // ä¾èµ–

  return <div>ç”¨æˆ·ä¿¡æ¯</div>;
}
```

</CodeBlock>

### 10.3 å¹¶å‘æ¸²æŸ“

<CodeBlock>

```jsx
import { useEffect, useState } from 'react';

function ConcurrentEffect() {
  const [data, setData] = useState(null);
  const [isStale, setIsStale] = useState(false);

  useEffect(() => {
    let isMounted = true;

    const fetchData = async () => {
      try {
        const result = await apiCall();
        if (isMounted) {
          setData(result);
          setIsStale(false);
        }
      } catch {
        if (isMounted) {
          setIsStale(true);
        }
      }
    };

    fetchData();

    return () => {
      isMounted = false;  // ç»„ä»¶å¸è½½æ—¶æ ‡è®°
    };
  }, []);

  if (isStale) {
    return <p>æ•°æ®å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°</p>;
  }

  return <div>{data}</div>;
}
```

</CodeBlock>

---

## 11. å®é™…åº”ç”¨åœºæ™¯

### 11.1 æ•°æ®ç¼“å­˜

<CodeBlock>

```jsx
import { useState, useEffect, useRef } from 'react';

function DataCache() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const cacheRef = useRef(new Map());

  const fetchWithCache = async (key) => {
    // æ£€æŸ¥ç¼“å­˜
    if (cacheRef.current.has(key)) {
      return cacheRef.current.get(key);
    }

    // æ¨¡æ‹ŸAPIè°ƒç”¨
    const response = await fetch(`/api/data/${key}`);
    const result = await response.json();

    // å­˜å…¥ç¼“å­˜
    cacheRef.current.set(key, result);
    return result;
  };

  useEffect(() => {
    setLoading(true);
    fetchWithCache('users').then(result => {
      setData(result);
      setLoading(false);
    });
  }, []);

  return loading ? <p>åŠ è½½ä¸­...</p> : <ul>{data}</ul>;
}
```

</CodeBlock>

### 11.2 è½®è¯¢

<CodeBlock>

```jsx
import { useState, useEffect } from 'react';

function Polling() {
  const [data, setData] = useState(null);
  const [intervalId, setIntervalId] = useState(null);

  useEffect(() => {
    // åˆå§‹è·å–
    fetchData();

    // è®¾ç½®è½®è¯¢
    const id = setInterval(() => {
      fetchData();
    }, 5000);

    setIntervalId(id);

    // æ¸…ç†è½®è¯¢
    return () => {
      clearInterval(id);
    };
  }, []);

  const fetchData = async () => {
    const response = await fetch('/api/status');
    const result = await response.json();
    setData(result);
  };

  return <div>çŠ¶æ€: {data?.status || 'æœªçŸ¥'}</div>;
}
```

</CodeBlock>

### 11.3 é”®ç›˜å¿«æ·é”®

<CodeBlock>

```jsx
import { useEffect } from 'react';

function KeyboardShortcuts({ onSave, onDelete }) {
  useEffect(() => {
    const handleKeyDown = (event) => {
      // Ctrl/Cmd + S ä¿å­˜
      if ((event.ctrlKey || event.metaKey) && event.key === 's') {
        event.preventDefault();
        onSave();
      }

      // Ctrl/Cmd + Delete åˆ é™¤
      if ((event.ctrlKey || event.metaKey) && event.key === 'Delete') {
        event.preventDefault();
        onDelete();
      }
    };

    window.addEventListener('keydown', handleKeyDown);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
    };
  }, [onSave, onDelete]);

  return <div>ä½¿ç”¨ Ctrl+S ä¿å­˜ï¼ŒCtrl+Delete åˆ é™¤</div>;
}
```

</CodeBlock>

---

## 12. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šå®šæ—¶å™¨ç»„ä»¶

åˆ›å»ºä¸€ä¸ªæ•°å­—æ—¶é’Ÿï¼Œæ˜¾ç¤ºå½“å‰æ—¶é—´å¹¶æ¯ç§’æ›´æ–°ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ˜¾ç¤ºå½“å‰æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ssï¼‰
- æ¯ç§’è‡ªåŠ¨æ›´æ–°
- ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
- å¯é€‰æ‹©æ˜¾ç¤º/éšè—ç§’æ•°

**æç¤º**ï¼š
- ä½¿ç”¨`setInterval`åˆ›å»ºå®šæ—¶å™¨
- åœ¨useEffectä¸­è®¾ç½®å’Œæ¸…ç†å®šæ—¶å™¨
- ä½¿ç”¨`new Date()`è·å–å½“å‰æ—¶é—´
- ä½¿ç”¨`toLocaleString()`æ ¼å¼åŒ–æ—¶é—´

</Expandable>

### ç»ƒä¹ 2ï¼šçª—å£å°ºå¯¸ç›‘å¬

åˆ›å»ºä¸€ä¸ªç»„ä»¶ï¼Œå®æ—¶æ˜¾ç¤ºæµè§ˆå™¨çª—å£çš„å°ºå¯¸ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å®æ—¶æ˜¾ç¤ºçª—å£å®½åº¦å’Œé«˜åº¦
- çª—å£å°ºå¯¸å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°
- æ·»åŠ resizeé˜²æŠ–ï¼ˆå»¶è¿Ÿæ›´æ–°ï¼‰
- å“åº”å¼æ–­ç‚¹æç¤º

**æç¤º**ï¼š
- ç›‘å¬`window.resize`äº‹ä»¶
- ä½¿ç”¨useRefå­˜å‚¨å®šæ—¶å™¨ID
- ä½¿ç”¨useEffectçš„æ¸…ç†å‡½æ•°

</Expandable>

### ç»ƒä¹ 3ï¼šæœç´¢é˜²æŠ–

åˆ›å»ºä¸€ä¸ªæœç´¢è¾“å…¥æ¡†ï¼Œå»¶è¿Ÿæ‰§è¡Œæœç´¢è¯·æ±‚ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- ç”¨æˆ·è¾“å…¥æ—¶å»¶è¿Ÿ300msæ‰§è¡Œæœç´¢
- è¾“å…¥è¿‡ç¨‹ä¸­æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- æœç´¢ç»“æœå±•ç¤º
- å–æ¶ˆä¸Šä¸€æ¬¡çš„æœç´¢è¯·æ±‚

**æç¤º**ï¼š
- ä½¿ç”¨useRefå­˜å‚¨æœ€æ–°çš„æœç´¢è¯
- åœ¨useEffectä¸­è®¾ç½®å’Œæ¸…ç†é˜²æŠ–å®šæ—¶å™¨
- ä½¿ç”¨AbortControllerå–æ¶ˆè¯·æ±‚

</Expandable>

### ç»ƒä¹ 4ï¼šæ·±æµ…è‰²ä¸»é¢˜åˆ‡æ¢

åˆ›å»ºä¸€ä¸ªä¸»é¢˜åˆ‡æ¢ç»„ä»¶ï¼Œä¿å­˜ç”¨æˆ·åå¥½ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æŒ‰é’®åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜
- ä»localStorageè¯»å–ä¸»é¢˜åå¥½
- ä¸»é¢˜å˜åŒ–æ—¶æ›´æ–°DOMç±»å
- é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜

**æç¤º**ï¼š
- ä½¿ç”¨ä¸¤ä¸ªuseEffectï¼šä¸€ä¸ªè¯»å–ï¼Œä¸€ä¸ªä¿å­˜
- ä¿®æ”¹`<body>`çš„className
- ä½¿ç”¨CSSå˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢

</Expandable>

---

## 13. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… useEffectç”¨äºå¤„ç†å‰¯ä½œç”¨ï¼ˆæ•°æ®è·å–ã€è®¢é˜…ã€DOMæ“ä½œç­‰ï¼‰
- âœ… ä¾èµ–æ•°ç»„æ§åˆ¶effectçš„æ‰§è¡Œæ—¶æœº
- âœ… ç©ºä¾èµ–æ•°ç»„`[]`åªåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶æ‰§è¡Œ
- âœ… æ¸…ç†å‡½æ•°ç”¨äºå–æ¶ˆå‰¯ä½œç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- âœ… useEffectåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œï¼ˆåŒ…æ‹¬é¦–æ¬¡ï¼‰
- âœ… ä¸èƒ½ç›´æ¥åœ¨useEffectä¸­å†™asyncå‡½æ•°
- âœ… ä¾èµ–æ•°ç»„åº”åŒ…å«effectä¸­ä½¿ç”¨çš„æ‰€æœ‰å˜é‡
- âœ… åˆç†ä½¿ç”¨useEffectä¼˜åŒ–æ€§èƒ½

</Checklist>

### æœ€ä½³å®è·µ

<BestPractices>

1. **å§‹ç»ˆæ¸…ç†å‰¯ä½œç”¨** - ç‰¹åˆ«æ˜¯å®šæ—¶å™¨ã€è®¢é˜…å’Œå¼‚æ­¥è¯·æ±‚
2. **å‡†ç¡®åˆ—å‡ºä¾èµ–** - ä¸è¦å¤šä¹Ÿä¸è¦å°‘
3. **é¿å…æ— é™å¾ªç¯** - æ£€æŸ¥ä¾èµ–é¡¹æ˜¯å¦ä¼šè¢«effectä¿®æ”¹
4. **ä½¿ç”¨æ¡ä»¶effect** - å‡å°‘ä¸å¿…è¦çš„effectæ‰§è¡Œ
5. **åˆ†ç¦»å…³æ³¨ç‚¹** - å°†ä¸åŒçš„é€»è¾‘æ”¾åœ¨ä¸åŒçš„useEffectä¸­

</BestPractices>

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†useEffectï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š

1. **[useContext](useContext)** - å­¦ä¹ è·¨ç»„ä»¶çŠ¶æ€å…±äº«
2. **[useReducer](advanced/useReducer)** - æŒæ¡å¤æ‚çŠ¶æ€é€»è¾‘
3. **[useCallback](advanced/useCallback)** - ä¼˜åŒ–æ€§èƒ½

---

## 14. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [useEffect APIå‚è€ƒ](https://react.dev/reference/react/useEffect) - Reactå®˜æ–¹æ–‡æ¡£
- [ä½¿ç”¨Effect](https://react.dev/learn/synchronizing-with-effects) - å®˜æ–¹æŒ‡å—
- [Effectä¾èµ–è¯¦è§£](https://react.dev/reference/react/useEffect#specifying-dependencies) - ä¾èµ–æ•°ç»„

### æ¨èé˜…è¯»

- [React Hookså®Œå…¨æŒ‡å—](https://legacy.reactjs.org/docs/hooks-effect.html) - useEffectè¯¦è§£
- [å¹¶å‘ç‰¹æ€§](https://react.dev/blog/2018/03/27/introducing-time-slicing) - ç†è§£å¹¶å‘æ¸²æŸ“
- [æ€§èƒ½ä¼˜åŒ–](https://react.dev/learn/render-and-commit) - ä¸useEffectçš„é…åˆ

---

[â† ä¸Šä¸€ç« ï¼šuseState](useState) | [ä¸‹ä¸€ç« ï¼šuseContext â†’](useContext)
