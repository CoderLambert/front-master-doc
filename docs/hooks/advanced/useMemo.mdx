# useMemo - è®¡ç®—å€¼è®°å¿†åŒ–

import { Tabs, TabItem } from '@docusaurus/theme-common';

`useMemo`æ˜¯Reactæä¾›çš„æ€§èƒ½ä¼˜åŒ–Hookï¼Œç”¨äºç¼“å­˜è®¡ç®—ç»“æœã€‚å½“ç»„ä»¶ä¸­æœ‰å¤æ‚çš„è®¡ç®—æ“ä½œæ—¶ï¼Œä½¿ç”¨useMemoå¯ä»¥é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½é‡æ–°è®¡ç®—ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ useMemoçš„å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯ã€æ€§èƒ½å½±å“ä»¥åŠæœ€ä½³å®è·µã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£useMemoçš„ä½œç”¨å’ŒåŸç†
- æŒæ¡useMemoçš„è¯­æ³•å’Œå‚æ•°
- å­¦ä¼šåˆ¤æ–­ä½•æ—¶ä½¿ç”¨useMemo
- ç†è§£ä¾èµ–æ•°ç»„çš„ä½œç”¨
- æŒæ¡useMemoä¸useCallbackçš„åŒºåˆ«
- å­¦ä¼šåœ¨å¤æ‚è®¡ç®—ä¸­åº”ç”¨useMemo
- é¿å…useMemoçš„è¯¯ç”¨å’Œè¿‡åº¦ä½¿ç”¨
- æŒæ¡useMemoåœ¨åˆ—è¡¨ä¼˜åŒ–ä¸­çš„åº”ç”¨

---

## 1. ä»€ä¹ˆæ˜¯useMemoï¼Ÿ

useMemoæ˜¯Reactçš„Hookï¼Œå®ƒè¿”å›ä¸€ä¸ªè®°å¿†åŒ–çš„å€¼ã€‚å½“ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒuseMemoåªæœ‰åœ¨ä¾èµ–é¡¹å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ï¼Œå¦åˆ™è¿”å›ç¼“å­˜çš„å€¼ã€‚

<Box style={{ padding: '20px', background: '#e8f5e9', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#2e7d32' }}>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>useMemo</strong>ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—æ˜‚è´µçš„æ“ä½œã€‚<br/>
    <strong>useCallback</strong>ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…é‡å¤åˆ›å»ºå‡½æ•°ã€‚<br/>
    <strong>React.memo</strong>ç¼“å­˜ç»„ä»¶æ¸²æŸ“ç»“æœï¼Œé¿å…é‡æ–°æ¸²æŸ“ã€‚
  </p>
</Box>

### 1.1 åŸºæœ¬è¯­æ³•

```javascript
const memoizedValue = useMemo(() => {
  // å¤æ‚è®¡ç®—
  return computedValue;
}, [dependency1, dependency2]);
```

- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè®¡ç®—å‡½æ•°ï¼Œè¿”å›è¦ç¼“å­˜çš„å€¼
- ç¬¬äºŒä¸ªå‚æ•°ï¼šä¾èµ–æ•°ç»„
- è¿”å›å€¼ï¼šè®°å¿†åŒ–çš„å€¼

### 1.2 ç®€å•ç¤ºä¾‹

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function MemoExample() {
  const [count, setCount] = useState(0);
  const [otherState, setOtherState] = useState(0);

  // ä¸ä½¿ç”¨useMemo - æ¯æ¬¡æ¸²æŸ“éƒ½è®¡ç®—
  const expensiveValue1 = () => {
    console.log('æ‰§è¡ŒexpensiveValue1è®¡ç®—...');
    let result = 0;
    for (let i = 0; i < 1000000; i++) {
      result += i;
    }
    return result;
  };

  // ä½¿ç”¨useMemo - åªæœ‰countå˜åŒ–æ—¶æ‰é‡æ–°è®¡ç®—
  const expensiveValue2 = useMemo(() => {
    console.log('æ‰§è¡ŒexpensiveValue2è®¡ç®—...');
    let result = 0;
    for (let i = 0; i < 1000000; i++) {
      result += i;
    }
    return result;
  }, [count]);  // åªæœ‰countå˜åŒ–æ—¶é‡æ–°è®¡ç®—

  return (
    <div>
      <p>Count: {count}</p>
      <p>Other State: {otherState}</p>

      <button onClick={() => setCount(count + 1)}>
        å¢åŠ Count (é‡æ–°è®¡ç®—expensiveValue2)
      </button>
      <button onClick={() => setOtherState(otherState + 1)}>
        å¢åŠ Other State (ä¸é‡æ–°è®¡ç®—expensiveValue2)
      </button>

      <div>
        <p>Value1 (ä¸ä½¿ç”¨useMemo): {expensiveValue1()}</p>
        <p>Value2 (ä½¿ç”¨useMemo): {expensiveValue2}</p>
      </div>
    </div>
  );
}
```

</CodeBlock>

---

## 2. æ·±å…¥ç†è§£useMemo

### 2.1 è®¡ç®—ç¼“å­˜æœºåˆ¶

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function CalculationCache() {
  const [number, setNumber] = useState(5);
  const [multiplier, setMultiplier] = useState(2);

  // è®¡ç®—é˜¶ä¹˜ - æ˜‚è´µæ“ä½œ
  const factorial = useMemo(() => {
    console.log('è®¡ç®—é˜¶ä¹˜...');
    if (number < 0) return 0;
    if (number === 0 || number === 1) return 1;

    let result = 1;
    for (let i = 2; i <= number; i++) {
      result *= i;
    }
    return result;
  }, [number]);  // åªæœ‰numberå˜åŒ–æ—¶é‡æ–°è®¡ç®—

  // è®¡ç®—ç»“æœ - å»‰ä»·æ“ä½œ
  const product = number * multiplier;

  return (
    <div>
      <p>æ•°å­—: {number}</p>
      <p>å€æ•°: {multiplier}</p>
      <p>é˜¶ä¹˜({number}!): {factorial}</p>
      <p>ä¹˜ç§¯: {product}</p>

      <button onClick={() => setNumber(number + 1)}>
        å¢åŠ æ•°å­— (é‡æ–°è®¡ç®—é˜¶ä¹˜)
      </button>
      <button onClick={() => setMultiplier(multiplier + 1)}>
        å¢åŠ å€æ•° (ä¸é‡æ–°è®¡ç®—é˜¶ä¹˜)
      </button>
    </div>
  );
}
```

</CodeBlock>

### 2.2 ä¾èµ–æ•°ç»„

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function DependencyExamples() {
  const [a, setA] = useState(0);
  const [b, setB] = useState(0);
  const [c, setC] = useState(0);

  // 1. ç©ºä¾èµ–æ•°ç»„ - åªè®¡ç®—ä¸€æ¬¡
  const once = useMemo(() => {
    console.log('åªè®¡ç®—ä¸€æ¬¡');
    return a + b;  // ä½¿ç”¨äº†aå’Œbï¼Œä½†ä¸åœ¨ä¾èµ–ä¸­ï¼Œä¸ä¼šæ›´æ–°
  }, []);  // æ°¸ä¸é‡æ–°è®¡ç®—

  // 2. å•ä¸€ä¾èµ– - è¯¥ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—
  const whenAChanges = useMemo(() => {
    console.log('å½“aå˜åŒ–æ—¶è®¡ç®—');
    return a * 10;
  }, [a]);  // åªæœ‰aå˜åŒ–æ—¶é‡æ–°è®¡ç®—

  // 3. å¤šé‡ä¾èµ– - ä»»æ„ä¸€ä¸ªå˜åŒ–éƒ½é‡æ–°è®¡ç®—
  const whenAorBChanges = useMemo(() => {
    console.log('å½“aæˆ–bå˜åŒ–æ—¶è®¡ç®—');
    return a + b;
  }, [a, b]);  // aæˆ–bå˜åŒ–æ—¶é‡æ–°è®¡ç®—

  // 4. è®¡ç®—æ‰€æœ‰å€¼
  const allValues = useMemo(() => {
    console.log('è®¡ç®—æ‰€æœ‰å€¼');
    return {
      once,
      whenAChanges,
      whenAorBChanges,
      c
    };
  }, [once, whenAChanges, whenAorBChanges, c]);

  return (
    <div>
      <p>a: {a}</p>
      <p>b: {b}</p>
      <p>c: {c}</p>
      <button onClick={() => setA(a + 1)}>A++</button>
      <button onClick={() => setB(b + 1)}>B++</button>
      <button onClick={() => setC(c + 1)}>C++</button>
    </div>
  );
}
```

</CodeBlock>

---

## 3. ä½¿ç”¨åœºæ™¯

### 3.1 å¤æ‚è®¡ç®—

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function ComplexCalculation() {
  const [list, setList] = useState([1, 2, 3, 4, 5]);
  const [filter, setFilter] = useState('');

  // è¿‡æ»¤åˆ—è¡¨
  const filteredList = useMemo(() => {
    console.log('æ‰§è¡Œè¿‡æ»¤è®¡ç®—...');
    return list.filter(item => item.toString().includes(filter));
  }, [list, filter]);

  // è®¡ç®—æ€»å’Œ
  const total = useMemo(() => {
    console.log('æ‰§è¡Œæ€»å’Œè®¡ç®—...');
    return filteredList.reduce((sum, item) => sum + item, 0);
  }, [filteredList]);

  // æ‰¾æœ€å¤§å€¼
  const max = useMemo(() => {
    console.log('æ‰§è¡Œæœ€å¤§å€¼è®¡ç®—...');
    return filteredList.length > 0
      ? Math.max(...filteredList)
      : 0;
  }, [filteredList]);

  return (
    <div>
      <input
        type="text"
        value={filter}
        onChange={(e) => setFilter(e.target.value)}
        placeholder="ç­›é€‰..."
      />

      <ul>
        {filteredList.map((item, index) => (
          <li key={index}>{item}</li>
        ))}
      </ul>

      <p>æ€»å’Œ: {total}</p>
      <p>æœ€å¤§å€¼: {max}</p>
    </div>
  );
}
```

</CodeBlock>

### 3.2 å¯¹è±¡åˆ›å»º

<Compare>

```jsx
// âŒ ä¸ä½¿ç”¨useMemo - æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å¯¹è±¡
function WithoutMemo() {
  const [firstName, setFirstName] = useState('John');
  const [lastName, setLastName] = useState('Doe');

  // æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å¯¹è±¡
  const user = {
    firstName,
    lastName,
    fullName: `${firstName} ${lastName}`
  };

  return <UserCard user={user} />;
}

// âœ… ä½¿ç”¨useMemo - åªæœ‰ä¾èµ–å˜åŒ–æ—¶æ‰åˆ›å»ºæ–°å¯¹è±¡
function WithMemo() {
  const [firstName, setFirstName] = useState('John');
  const [lastName, setLastName] = useState('Doe');

  const user = useMemo(() => ({
    firstName,
    lastName,
    fullName: `${firstName} ${lastName}`
  }), [firstName, lastName]);  // åªæœ‰åå­—å˜åŒ–æ—¶é‡æ–°åˆ›å»º

  return <UserCard user={user} />;
}
```

</Compare>

### 3.3 åˆ—è¡¨æ’åºå’Œè¿‡æ»¤

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function ProductList() {
  const [products, setProducts] = useState([
    { id: 1, name: 'Laptop', price: 999, category: 'Electronics' },
    { id: 2, name: 'Shirt', price: 29, category: 'Clothing' },
    { id: 3, name: 'Phone', price: 699, category: 'Electronics' },
    { id: 4, name: 'Pants', price: 59, category: 'Clothing' }
  ]);

  const [sortBy, setSortBy] = useState('name');
  const [filterCategory, setFilterCategory] = useState('all');

  // è¿‡æ»¤äº§å“
  const filteredProducts = useMemo(() => {
    return filterCategory === 'all'
      ? products
      : products.filter(p => p.category === filterCategory);
  }, [products, filterCategory]);

  // æ’åºäº§å“
  const sortedProducts = useMemo(() => {
    const sorted = [...filteredProducts];
    if (sortBy === 'name') {
      sorted.sort((a, b) => a.name.localeCompare(b.name));
    } else if (sortBy === 'price') {
      sorted.sort((a, b) => a.price - b.price);
    }
    return sorted;
  }, [filteredProducts, sortBy]);

  // è®¡ç®—æ€»ä»·
  const totalPrice = useMemo(() => {
    return sortedProducts.reduce((sum, product) => sum + product.price, 0);
  }, [sortedProducts]);

  return (
    <div>
      <div>
        <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)}>
          <option value="all">å…¨éƒ¨åˆ†ç±»</option>
          <option value="Electronics">ç”µå­äº§å“</option>
          <option value="Clothing">æœè£…</option>
        </select>

        <select value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
          <option value="name">æŒ‰åç§°æ’åº</option>
          <option value="price">æŒ‰ä»·æ ¼æ’åº</option>
        </select>
      </div>

      <ul>
        {sortedProducts.map(product => (
          <li key={product.id}>
            {product.name} - ${product.price}
          </li>
        ))}
      </ul>

      <p>æ€»ä»·: ${totalPrice}</p>
    </div>
  );
}
```

</CodeBlock>

---

## 4. ä¸useCallbackçš„åŒºåˆ«

<Box style={{ padding: '20px', background: '#e3f2fd', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#1976d2' }}>ğŸ’¡ åŒºåˆ«æ€»ç»“</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>useMemo</strong>ç¼“å­˜è®¡ç®—ç»“æœçš„å€¼<br/>
    <strong>useCallback</strong>ç¼“å­˜å‡½æ•°æœ¬èº«çš„å¼•ç”¨<br/>
    æœ¬è´¨ä¸Šï¼š<code>useCallback(fn, deps) = useMemo(() => fn, deps)</code>
  </p>
</Box>

### 4.1 å¯¹æ¯”ç¤ºä¾‹

<CodeBlock>

```jsx
import { useState, useMemo, useCallback } from 'react';

function MemoVsCallback() {
  const [count, setCount] = useState(0);

  // useMemoç¼“å­˜è®¡ç®—ç»“æœ
  const doubledCount = useMemo(() => {
    console.log('è®¡ç®—2å€å€¼...');
    return count * 2;
  }, [count]);

  // useCallbackç¼“å­˜å‡½æ•°
  const handleClick = useCallback(() => {
    console.log('ç‚¹å‡»äº†', count);
  }, [count]);

  // ç­‰ä»·äºï¼ˆä½†useCallbackæ›´è¯­ä¹‰åŒ–ï¼‰
  const handleClick2 = useMemo(() => {
    return () => {
      console.log('ç‚¹å‡»äº†', count);
    };
  }, [count]);

  return (
    <div>
      <p>Count: {count}</p>
      <p>2å€å€¼: {doubledCount}</p>
      <button onClick={() => setCount(count + 1)}>
        å¢åŠ 
      </button>
      <button onClick={handleClick}>
        ç‚¹å‡»
      </button>
    </div>
  );
}
```

</CodeBlock>

### 4.2 å®é™…åº”ç”¨åœºæ™¯

<Compare>

```jsx
// åœºæ™¯1ï¼šè®¡ç®—æ´¾ç”Ÿå€¼ - ä½¿ç”¨useMemo
function DerivedValue() {
  const [firstName, setFirstName] = useState('John');
  const [lastName, setLastName] = useState('Doe');

  const fullName = useMemo(() => `${firstName} ${lastName}`, [firstName, lastName]);
  const nameLength = useMemo(() => fullName.length, [fullName]);

  return <div>{fullName} ({nameLength}ä¸ªå­—ç¬¦)</div>;
}

// åœºæ™¯2ï¼šä¼ é€’ç»™å­ç»„ä»¶çš„å‡½æ•° - ä½¿ç”¨useCallback
function CallbackToChild() {
  const [count, setCount] = useState(0);

  const handleClick = useCallback(() => {
    console.log('Count:', count);
  }, [count]);

  return <Child onClick={handleClick} />;
}

// åœºæ™¯3ï¼šå¤æ‚å¯¹è±¡ - ä½¿ç”¨useMemo
function ComplexObject() {
  const [user, setUser] = useState({ name: 'Alice', age: 25 });

  const userInfo = useMemo(() => ({
    ...user,
    isAdult: user.age >= 18,
    displayName: user.name.toUpperCase()
  }), [user]);

  return <div>{userInfo.displayName}</div>;
}
```

</Compare>

---

## 5. é«˜çº§ç”¨æ³•

### 5.1 ç¼“å­˜å¯¹è±¡å±æ€§

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function CachedObjectProps() {
  const [user, setUser] = useState({
    profile: {
      personal: {
        name: 'Alice',
        age: 25
      },
      settings: {
        theme: 'dark',
        language: 'zh'
      }
    }
  });

  // ç¼“å­˜æ·±å±‚å±æ€§
  const name = useMemo(() => user.profile.personal.name, [user]);
  const age = useMemo(() => user.profile.personal.age, [user]);
  const theme = useMemo(() => user.profile.settings.theme, [user]);

  // ç¼“å­˜è®¡ç®—å±æ€§
  const isAdult = useMemo(() => age >= 18, [age]);
  const profileSummary = useMemo(() => `${name}, ${age}å²`, [name, age]);

  return (
    <div>
      <p>å§“å: {name}</p>
      <p>å¹´é¾„: {age}</p>
      <p>ä¸»é¢˜: {theme}</p>
      <p>æ˜¯å¦æˆå¹´: {isAdult ? 'æ˜¯' : 'å¦'}</p>
      <p>ç®€ä»‹: {profileSummary}</p>
    </div>
  );
}
```

</CodeBlock>

### 5.2 æ¡ä»¶è®¡ç®—

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function ConditionalCalculation() {
  const [data, setData] = useState([1, 2, 3, 4, 5]);
  const [operation, setOperation] = useState('sum');  // 'sum' | 'avg' | 'max' | 'min'

  // æ¡ä»¶è®¡ç®—
  const result = useMemo(() => {
    console.log(`æ‰§è¡Œ${operation}è®¡ç®—...`);
    if (data.length === 0) return 0;

    switch (operation) {
      case 'sum':
        return data.reduce((a, b) => a + b, 0);
      case 'avg':
        return data.reduce((a, b) => a + b, 0) / data.length;
      case 'max':
        return Math.max(...data);
      case 'min':
        return Math.min(...data);
      default:
        return 0;
    }
  }, [data, operation]);

  return (
    <div>
      <p>æ•°æ®: {data.join(', ')}</p>
      <select value={operation} onChange={(e) => setOperation(e.target.value)}>
        <option value="sum">æ±‚å’Œ</option>
        <option value="avg">å¹³å‡å€¼</option>
        <option value="max">æœ€å¤§å€¼</option>
        <option value="min">æœ€å°å€¼</option>
      </select>
      <p>ç»“æœ: {result}</p>
    </div>
  );
}
```

</CodeBlock>

### 5.3 ç¼“å­˜å¼‚æ­¥æ•°æ®

<CodeBlock>

```jsx
import { useState, useEffect, useMemo } from 'react';

function CachedAsyncData() {
  const [data, setData] = useState([]);
  const [filter, setFilter] = useState('');
  const [sortBy, setSortBy] = useState('name');

  // æ¨¡æ‹ŸAPIè°ƒç”¨
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch('/api/items');
      const result = await response.json();
      setData(result);
    };
    fetchData();
  }, []);

  // ç¼“å­˜å¤„ç†åçš„æ•°æ®
  const processedData = useMemo(() => {
    console.log('å¤„ç†æ•°æ®...');

    // è¿‡æ»¤
    let filtered = data;
    if (filter) {
      filtered = data.filter(item =>
        item.name.toLowerCase().includes(filter.toLowerCase())
      );
    }

    // æ’åº
    const sorted = [...filtered].sort((a, b) => {
      if (sortBy === 'name') {
        return a.name.localeCompare(b.name);
      } else if (sortBy === 'id') {
        return a.id - b.id;
      }
      return 0;
    });

    return sorted;
  }, [data, filter, sortBy]);

  return (
    <div>
      <input
        type="text"
        value={filter}
        onChange={(e) => setFilter(e.target.value)}
        placeholder="æœç´¢..."
      />
      <select value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
        <option value="name">æŒ‰åç§°æ’åº</option>
        <option value="id">æŒ‰IDæ’åº</option>
      </select>
      <ul>
        {processedData.map(item => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

</CodeBlock>

---

## 6. å¸¸è§é”™è¯¯ä¸é™·é˜±

### 6.1 å¿˜è®°ä¾èµ–æ•°ç»„

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç¼ºå°‘ä¾èµ–æ•°ç»„
function BadExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    return count * 2;  // æ²¡æœ‰ä¾èµ–æ•°ç»„ï¼
  });  // ä¾èµ–æ•°ç»„ç¼ºå¤±

  return <p>{doubled}</p>;
}

// âœ… æ­£ç¡®
function GoodExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    return count * 2;
  }, [count]);  // æ·»åŠ ä¾èµ–æ•°ç»„

  return <p>{doubled}</p>;
}
```

</ErrorBox>

### 6.2 ä¾èµ–æ•°ç»„è¿‡å¤š

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ä¸å¿…è¦çš„ä¾èµ–
function BadExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    return count * 2;
  }, [count, setCount]);  // setCountæ˜¯ç¨³å®šå¼•ç”¨ï¼Œä¸éœ€è¦ï¼

  return <p>{doubled}</p>;
}

// âœ… æ­£ç¡®
function GoodExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    return count * 2;
  }, [count]);  // åªä¾èµ–count

  return <p>{doubled}</p>;
}
```

</ErrorBox>

### 6.3 è¿‡åº¦ä½¿ç”¨useMemo

<ErrorBox>

```jsx
// âŒ ä¸å¥½ - è¿‡åº¦ä¼˜åŒ–
function OverOptimized() {
  const [count, setCount] = useState(0);

  const simpleDoubled = useMemo(() => {
    return count * 2;  // ç®€å•è®¡ç®—ä¸éœ€è¦useMemo
  }, [count]);

  return <p>{simpleDoubled}</p>;
}

// âœ… ç®€å•åœºæ™¯ - ä¸ä½¿ç”¨useMemo
function SimpleCase() {
  const [count, setCount] = useState(0);

  const doubled = count * 2;  // ç›´æ¥è®¡ç®—å³å¯

  return <p>{doubled}</p>;
}
```

</ErrorBox>

### 6.4 åœ¨useMemoä¸­æ‰§è¡Œå‰¯ä½œç”¨

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - åœ¨useMemoä¸­æ‰§è¡Œå‰¯ä½œç”¨
function BadExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    console.log('æ‰§è¡Œå‰¯ä½œç”¨');  // å‰¯ä½œç”¨ï¼
    localStorage.setItem('count', count);  // å‰¯ä½œç”¨ï¼
    return count * 2;
  }, [count]);

  return <p>{doubled}</p>;
}

// âœ… æ­£ç¡® - åœ¨useEffectä¸­å¤„ç†å‰¯ä½œç”¨
function GoodExample() {
  const [count, setCount] = useState(0);

  const doubled = useMemo(() => {
    return count * 2;  // åªåšè®¡ç®—
  }, [count]);

  useEffect(() => {
    console.log('countå˜åŒ–äº†:', count);
    localStorage.setItem('count', count);
  }, [count]);  // åœ¨effectä¸­å¤„ç†å‰¯ä½œç”¨

  return <p>{doubled}</p>;
}
```

</ErrorBox>

---

## 7. æ€§èƒ½è€ƒé‡

### 7.1 ä½•æ—¶ä½¿ç”¨useMemo

<Rules>

1. **æ˜‚è´µçš„è®¡ç®—** - å¦‚æ’åºã€è¿‡æ»¤ã€å¤§é‡æ•°æ®å¤„ç†
2. **é¿å…é‡å¤æ¸²æŸ“** - å½“è®¡ç®—ç»“æœä¼ é€’ç»™å­ç»„ä»¶æ—¶
3. **å¤æ‚å¯¹è±¡åˆ›å»º** - å½“å¯¹è±¡ä½œä¸ºä¾èµ–æˆ–propsæ—¶
4. **åˆ—è¡¨ä¼˜åŒ–** - å¯¹åˆ—è¡¨è¿›è¡Œå¤æ‚å¤„ç†æ—¶

</Rules>

### 7.2 æ€§èƒ½å½±å“

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function PerformanceTest() {
  const [list, setList] = useState(Array.from({ length: 10000 }, (_, i) => i));

  // æƒ…å†µ1ï¼šç®€å•è®¡ç®— - ä¸éœ€è¦useMemo
  const simpleSum = list.reduce((sum, num) => sum + num, 0);

  // æƒ…å†µ2ï¼šæ˜‚è´µè®¡ç®— - ä½¿ç”¨useMemo
  const expensiveSum = useMemo(() => {
    console.log('æ‰§è¡Œæ˜‚è´µè®¡ç®—...');
    return list.reduce((sum, num) => sum + num, 0);
  }, [list]);

  // æƒ…å†µ3ï¼šç®€å•è®¡ç®—ä½†ä¼ é€’ç»™å­©å­ç»„ä»¶ - å¯èƒ½éœ€è¦
  const numberInfo = useMemo(() => ({
    count: list.length,
    sum: simpleSum
  }), [list.length, simpleSum]);

  return (
    <div>
      <p>åˆ—è¡¨é•¿åº¦: {list.length}</p>
      <p>ç®€å•è®¡ç®—: {simpleSum}</p>
      <p>æ˜‚è´µè®¡ç®—: {expensiveSum}</p>
      <p>ä¿¡æ¯: {JSON.stringify(numberInfo)}</p>
    </div>
  );
}
```

</CodeBlock>

### 7.3 useMemoçš„ä»£ä»·

<Box style={{ padding: '20px', background: '#fff3e0', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#e65100' }}>âš ï¸ æ€§èƒ½æƒè¡¡</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    useMemoæœ¬èº«ä¹Ÿæœ‰æ€§èƒ½å¼€é”€ï¼ˆè®°å¿†åŒ–ã€æ£€æŸ¥ä¾èµ–ç­‰ï¼‰ã€‚å¯¹äº<strong>ç®€å•è®¡ç®—</strong>ï¼Œç›´æ¥è®¡ç®—å¯èƒ½æ¯”useMemoæ›´å¿«ã€‚åªæœ‰åœ¨è®¡ç®—æ˜‚è´µæˆ–éœ€è¦ç¼“å­˜æ—¶æ‰ä½¿ç”¨ã€‚
  </p>
</Box>

---

## 8. å®é™…åº”ç”¨åœºæ™¯

### 8.1 è™šæ‹ŸåŒ–åˆ—è¡¨

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function VirtualizedList({ items, itemHeight = 50, containerHeight = 400 }) {
  const [scrollTop, setScrollTop] = useState(0);

  // è®¡ç®—å¯è§é¡¹ç›®
  const visibleItems = useMemo(() => {
    const startIndex = Math.floor(scrollTop / itemHeight);
    const endIndex = Math.min(
      startIndex + Math.ceil(containerHeight / itemHeight) + 1,
      items.length
    );

    return {
      startIndex,
      endIndex,
      visibleItems: items.slice(startIndex, endIndex)
    };
  }, [items, scrollTop, itemHeight, containerHeight]);

  // è®¡ç®—æ€»é«˜åº¦
  const totalHeight = useMemo(() => {
    return items.length * itemHeight;
  }, [items.length, itemHeight]);

  // è®¡ç®—åç§»é‡
  const offsetY = useMemo(() => {
    return visibleItems.startIndex * itemHeight;
  }, [visibleItems.startIndex, itemHeight]);

  const handleScroll = (e) => {
    setScrollTop(e.target.scrollTop);
  };

  return (
    <div
      style={{ height: containerHeight, overflow: 'auto' }}
      onScroll={handleScroll}
    >
      <div style={{ height: totalHeight, position: 'relative' }}>
        <div
          style={{
            transform: `translateY(${offsetY}px)`,
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0
          }}
        >
          {visibleItems.visibleItems.map((item, index) => (
            <div
              key={visibleItems.startIndex + index}
              style={{ height: itemHeight }}
            >
              {item}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
```

</CodeBlock>

### 8.2 ä¾èµ–é¡¹åˆ†æ

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function DependencyAnalyzer() {
  const [users, setUsers] = useState([
    { id: 1, name: 'Alice', role: 'admin', active: true },
    { id: 2, name: 'Bob', role: 'user', active: false },
    { id: 3, name: 'Charlie', role: 'admin', active: true }
  ]);

  // ç»Ÿè®¡æ•°æ®
  const stats = useMemo(() => {
    const total = users.length;
    const active = users.filter(u => u.active).length;
    const admins = users.filter(u => u.role === 'admin').length;
    const activeAdmins = users.filter(u => u.active && u.role === 'admin').length;

    return {
      total,
      active,
      inactive: total - active,
      admins,
      regularUsers: total - admins,
      activeAdmins,
      activeRegularUsers: active - activeAdmins
    };
  }, [users]);

  // æ ¼å¼åŒ–ç»Ÿè®¡ä¿¡æ¯
  const formattedStats = useMemo(() => {
    return `æ€»è®¡: ${stats.total}, æ´»è·ƒ: ${stats.active}, ç®¡ç†å‘˜: ${stats.admins}`;
  }, [stats]);

  return (
    <div>
      <ul>
        {users.map(user => (
          <li key={user.id}>
            {user.name} - {user.role} - {user.active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
          </li>
        ))}
      </ul>

      <div>
        <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
        <p>{formattedStats}</p>
        <p>æ´»è·ƒç”¨æˆ·: {stats.activeRegularUsers}</p>
        <p>æ´»è·ƒç®¡ç†å‘˜: {stats.activeAdmins}</p>
      </div>
    </div>
  );
}
```

</CodeBlock>

### 8.3 è®¡ç®—å›¾è¡¨æ•°æ®

<CodeBlock>

```jsx
import { useState, useMemo } from 'react';

function ChartDataGenerator() {
  const [dataPoints, setDataPoints] = useState(50);
  const [multiplier, setMultiplier] = useState(1);

  // ç”Ÿæˆæ•°æ®
  const rawData = useMemo(() => {
    return Array.from({ length: dataPoints }, (_, i) => ({
      x: i,
      y: Math.sin(i * 0.1) * 100 * multiplier
    }));
  }, [dataPoints, multiplier]);

  // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
  const stats = useMemo(() => {
    const values = rawData.map(d => d.y);
    const min = Math.min(...values);
    const max = Math.max(...values);
    const avg = values.reduce((a, b) => a + b, 0) / values.length;

    return { min, max, avg };
  }, [rawData]);

  // ç¼©æ”¾æ•°æ®
  const scaledData = useMemo(() => {
    const range = stats.max - stats.min;
    if (range === 0) return rawData;

    return rawData.map(point => ({
      x: point.x,
      y: ((point.y - stats.min) / range) * 100
    }));
  }, [rawData, stats]);

  return (
    <div>
      <div>
        <input
          type="range"
          min="10"
          max="200"
          value={dataPoints}
          onChange={(e) => setDataPoints(Number(e.target.value))}
        />
        æ•°æ®ç‚¹: {dataPoints}
      </div>
      <div>
        <input
          type="range"
          min="0.1"
          max="3"
          step="0.1"
          value={multiplier}
          onChange={(e) => setMultiplier(Number(e.target.value))}
        />
        ä¹˜æ•°: {multiplier}
      </div>

      <div>
        <h3>ç»Ÿè®¡</h3>
        <p>æœ€å°å€¼: {stats.min.toFixed(2)}</p>
        <p>æœ€å¤§å€¼: {stats.max.toFixed(2)}</p>
        <p>å¹³å‡å€¼: {stats.avg.toFixed(2)}</p>
      </div>

      <svg width="400" height="200">
        {scaledData.map((point, index) => (
          <circle
            key={index}
            cx={point.x * 4}
            cy={200 - point.y}
            r="2"
            fill="blue"
          />
        ))}
      </svg>
    </div>
  );
}
```

</CodeBlock>

---

## 9. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šåˆ—è¡¨æœç´¢å’Œæ’åº

åˆ›å»ºä¸€ä¸ªå¯æœç´¢ã€å¯æ’åºçš„äº§å“åˆ—è¡¨ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- äº§å“åˆ—è¡¨ï¼ˆåŒ…å«åç§°ã€ä»·æ ¼ã€åˆ†ç±»ã€åº“å­˜ï¼‰
- æœç´¢æ¡†ï¼ˆæœç´¢äº§å“åç§°ï¼‰
- æ’åºï¼ˆæŒ‰ä»·æ ¼ã€åç§°ã€åº“å­˜ï¼‰
- åˆ†ç±»ç­›é€‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»äº§å“æ•°ã€å¹³å‡ä»·æ ¼ã€æœ€é«˜ä»·æ ¼ç­‰ï¼‰

**è¦æ±‚**ï¼š
- ä½¿ç”¨useMemoç¼“å­˜è¿‡æ»¤ç»“æœ
- ä½¿ç”¨useMemoç¼“å­˜æ’åºç»“æœ
- ä½¿ç”¨useMemoè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
- æ€§èƒ½ä¼˜åŒ–ï¼Œé¿å…é‡å¤è®¡ç®—

**æç¤º**ï¼š
- åˆ†ç¦»è¿‡æ»¤å’Œæ’åºé€»è¾‘
- ç»Ÿè®¡ä¿¡æ¯ä¾èµ–è¿‡æ»¤åçš„æ•°æ®
- ä½¿ç”¨useMemoä¼˜åŒ–æ¯ä¸ªè®¡ç®—

</Expandable>

### ç»ƒä¹ 2ï¼šæ•°æ®å¯è§†åŒ–

åˆ›å»ºä¸€ä¸ªç®€å•çš„æ•°æ®å¯è§†åŒ–ç»„ä»¶ï¼Œæ”¯æŒç¼©æ”¾å’Œè¿‡æ»¤ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- éšæœºæ•°æ®ç”Ÿæˆ
- å›¾è¡¨æ•°æ®å¤„ç†ï¼ˆæ±‚å’Œã€å¹³å‡å€¼ã€åˆ†ç»„ï¼‰
- ç¼©æ”¾æ§åˆ¶ï¼ˆæ”¾å¤§ã€ç¼©å°ã€é‡ç½®ï¼‰
- åŒºé—´ç­›é€‰ï¼ˆæ˜¾ç¤ºæŒ‡å®šèŒƒå›´æ•°æ®ï¼‰
- å¯¼å‡ºåŠŸèƒ½

**è¦æ±‚**ï¼š
- ä½¿ç”¨useMemoç¼“å­˜æ•°æ®å¤„ç†ç»“æœ
- ä½¿ç”¨useMemoç¼“å­˜å›¾è¡¨ç»˜åˆ¶æ•°æ®
- é¿å…åœ¨æ¸²æŸ“ä¸­æ‰§è¡Œæ˜‚è´µè®¡ç®—
- ä¼˜åŒ–å¤§é‡æ•°æ®çš„å¤„ç†

**æç¤º**ï¼š
- åŒºåˆ†åŸå§‹æ•°æ®å’Œå¤„ç†æ•°æ®
- å›¾è¡¨æ¸²æŸ“ä½¿ç”¨ç¼“å­˜çš„æ•°æ®
- ç¼©æ”¾å’Œç­›é€‰ä½œä¸ºä¾èµ–

</Expandable>

### ç»ƒä¹ 3ï¼šå¤æ‚è¡¨å•è®¡ç®—

åˆ›å»ºä¸€ä¸ªè®¢å•è¡¨å•ï¼Œå®æ—¶è®¡ç®—æ€»ä»·ã€æŠ˜æ‰£ã€ç¨è´¹ç­‰ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å•†å“åˆ—è¡¨ï¼ˆå•ä»·ã€æ•°é‡ã€æŠ˜æ‰£ï¼‰
- ä¼˜æƒ åˆ¸è¾“å…¥
- ç¨ç‡è®¾ç½®
- å®æ—¶è®¡ç®—ï¼ˆå°è®¡ã€æŠ˜æ‰£ã€ç¨è´¹ã€æ€»è®¡ï¼‰
- æ»¡å‡æ´»åŠ¨ï¼ˆæ»¡Xå‡Yï¼‰
- åŒ…é‚®é—¨æ§›

**è¦æ±‚**ï¼š
- ä½¿ç”¨useMemoè®¡ç®—æ¯ä¸ªå­—æ®µ
- é¿å…ä¾èµ–å¾ªç¯
- åˆ†ç¦»è®¡ç®—é€»è¾‘
- ä¼˜åŒ–è®¡ç®—æ€§èƒ½

**æç¤º**ï¼š
- å°è®¡ = å•ä»· Ã— æ•°é‡
- æŠ˜æ‰£å = å°è®¡ Ã— (1 - æŠ˜æ‰£ç‡)
- ç¨è´¹ = æŠ˜æ‰£å Ã— ç¨ç‡
- æ€»è®¡ = æŠ˜æ‰£å + ç¨è´¹ - ä¼˜æƒ 

</Expandable>

### ç»ƒä¹ 4ï¼šæ ‘å½¢ç»“æ„æ“ä½œ

åˆ›å»ºä¸€ä¸ªæ ‘å½¢ç»„ä»¶ï¼Œæ”¯æŒå±•å¼€/æŠ˜å ã€æœç´¢ã€ç»Ÿè®¡ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ ‘å½¢æ•°æ®ç»“æ„
- å±•å¼€/æŠ˜å èŠ‚ç‚¹
- æœç´¢èŠ‚ç‚¹ï¼ˆé«˜äº®åŒ¹é…ï¼‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»èŠ‚ç‚¹æ•°ã€å¶å­èŠ‚ç‚¹æ•°ã€æ·±åº¦ç­‰ï¼‰
- è·¯å¾„è¿½è¸ªï¼ˆæ˜¾ç¤ºå½“å‰é€‰ä¸­èŠ‚ç‚¹è·¯å¾„ï¼‰

**è¦æ±‚**ï¼š
- ä½¿ç”¨useMemoç¼“å­˜æ ‘ç»“æ„
- ä½¿ç”¨useMemoç¼“å­˜æœç´¢ç»“æœ
- ä½¿ç”¨useMemoè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
- ä¼˜åŒ–å¤§é‡èŠ‚ç‚¹çš„æ¸²æŸ“

**æç¤º**ï¼š
- æ ‘ç»“æ„æ‰å¹³åŒ–å¤„ç†
- æœç´¢ä½¿ç”¨filterå’Œmap
- ç»Ÿè®¡ä¾èµ–èŠ‚ç‚¹æ•°é‡
- è·¯å¾„è®¡ç®—ä¼˜åŒ–

</Expandable>

---

## 10. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… useMemoç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
- âœ… åªæœ‰ä¾èµ–é¡¹å˜åŒ–æ—¶æ‰é‡æ–°è®¡ç®—
- âœ… é€‚ç”¨äºæ˜‚è´µçš„è®¡ç®—æ“ä½œ
- âœ… ä¾èµ–æ•°ç»„å¿…é¡»æ­£ç¡®åˆ—å‡ºæ‰€æœ‰ä¾èµ–
- âœ… é¿å…åœ¨useMemoä¸­æ‰§è¡Œå‰¯ä½œç”¨
- âœ… ä¸è¦è¿‡åº¦ä½¿ç”¨useMemoï¼Œç®€å•è®¡ç®—ç›´æ¥è®¡ç®—å³å¯
- âœ… ä¸useCallbackã€React.memoé…åˆä½¿ç”¨æ•ˆæœæ›´å¥½
- âœ… æ€§èƒ½ä¼˜åŒ–éœ€æƒè¡¡useMemoçš„å¼€é”€å’Œæ”¶ç›Š

</Checklist>

### æœ€ä½³å®è·µ

<BestPractices>

1. **åªåœ¨éœ€è¦æ—¶ä½¿ç”¨** - æ˜‚è´µè®¡ç®—ã€é¿å…é‡å¤æ¸²æŸ“ã€å¤æ‚å¯¹è±¡
2. **æ­£ç¡®åˆ—å‡ºä¾èµ–** - æ‰€æœ‰ç”¨åˆ°çš„å˜é‡éƒ½è¦åœ¨ä¾èµ–æ•°ç»„ä¸­
3. **ä¿æŒè®¡ç®—çº¯å‡½æ•°** - ä¸æ‰§è¡Œå‰¯ä½œç”¨ï¼Œåªåšè®¡ç®—
4. **åˆ†ç¦»è®¡ç®—é€»è¾‘** - å¤æ‚çš„è®¡ç®—é€»è¾‘å¯ä»¥æå–åˆ°å‡½æ•°ä¸­
5. **æ€§èƒ½æµ‹è¯•** - å®é™…æµ‹è¯•useMemoå¸¦æ¥çš„æ€§èƒ½æå‡
6. **å¯è¯»æ€§ä¼˜å…ˆ** - ä¸è¦ä¸ºäº†æ€§èƒ½ç‰ºç‰²ä»£ç å¯è¯»æ€§

</BestPractices>

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**ä½•æ—¶ä½¿ç”¨**ï¼š
- æ•°æ®é‡å¤§çš„åˆ—è¡¨æ’åºå’Œè¿‡æ»¤
- å¤æ‚çš„æ•°å­¦è®¡ç®—
- æ˜‚è´µçš„APIæ•°æ®å¤„ç†
- éœ€è¦ç¼“å­˜çš„å¯¹è±¡åˆ›å»º

**ä½•æ—¶ä¸ç”¨**ï¼š
- ç®€å•çš„ç®—æœ¯è¿ç®—
- å­—ç¬¦ä¸²æ‹¼æ¥
- å¸ƒå°”å€¼è®¡ç®—
- æ€§èƒ½å¼€é”€å¤§äºæ”¶ç›Šæ—¶

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†useMemoï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š

1. **[è‡ªå®šä¹‰Hooks](custom-hooks)** - åˆ›å»ºå¯å¤ç”¨çš„çŠ¶æ€é€»è¾‘
2. **[æ€§èƒ½ä¼˜åŒ–](../performance/optimization)** - ç»¼åˆæ€§èƒ½ä¼˜åŒ–ç­–ç•¥
3. **[å®é™…é¡¹ç›®åº”ç”¨](../projects)** - ç»¼åˆè¿ç”¨æ‰€æœ‰Hooks

---

## 11. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [useMemo APIå‚è€ƒ](https://react.dev/reference/react/useMemo) - Reactå®˜æ–¹æ–‡æ¡£
- [æ€§èƒ½ä¼˜åŒ–](https://react.dev/learn/render-and-commit) - æ¸²æŸ“å’Œæ€§èƒ½
- [useMemoæŒ‡å—](https://react.dev/reference/react/useMemo) - ä½•æ—¶ä½¿ç”¨useMemo

### æ¨èé˜…è¯»

- [Reactæ€§èƒ½ä¼˜åŒ–](https://kentcdodds.com/blog/application-state-management-with-react) - çŠ¶æ€ç®¡ç†å’Œæ€§èƒ½
- [useMemoåæ¨¡å¼](https://kentcdodds.com/blog/usememo-and-usecallback) - é¿å…è¯¯ç”¨
- [æ€§èƒ½ä¼˜åŒ–å®æˆ˜](https://react.dev/learn/rendering-lists) - åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–

---

[â† ä¸Šä¸€ç« ï¼šuseCallback](useCallback) | [ä¸‹ä¸€ç« ï¼šè‡ªå®šä¹‰Hooks â†’](custom-hooks)
