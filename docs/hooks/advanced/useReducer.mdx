# useReducer - å¤æ‚çŠ¶æ€ç®¡ç†

import { Tabs, TabItem } from '@docusaurus/theme-common';

`useReducer`æ˜¯Reactæä¾›çš„Hookï¼Œç”¨äºç®¡ç†å¤æ‚çš„çŠ¶æ€é€»è¾‘ã€‚å®ƒç±»ä¼¼äº Redux çš„å·¥ä½œåŸç†ï¼Œè®©ä½ èƒ½åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ç®¡ç†å¤šä¸ªå­å€¼ï¼Œå¹¶æä¾›æ›´å¼ºå¤§çš„çŠ¶æ€æ›´æ–°é€»è¾‘ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ useReducerçš„ä½¿ç”¨æ–¹æ³•ã€ä¸useStateçš„åŒºåˆ«ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£useReducerçš„ä½œç”¨å’Œé€‚ç”¨åœºæ™¯
- æŒæ¡useState vs useReducerçš„é€‰æ‹©æ ‡å‡†
- å­¦ä¼šä½¿ç”¨reducerå‡½æ•°è®¾è®¡çŠ¶æ€é€»è¾‘
- ç†è§£actionçš„ç±»å‹å’Œç»“æ„
- æŒæ¡useReducerçš„é«˜çº§ç”¨æ³•
- å­¦ä¼šä¸Contextç»“åˆä½¿ç”¨
- ç†è§£ä¸­é—´ä»¶å’Œå¼‚æ­¥æ“ä½œçš„å¤„ç†

---

## 1. ä»€ä¹ˆæ˜¯useReducerï¼Ÿ

useReduceræ˜¯React Hooksç³»ç»Ÿä¸­çš„çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå®ƒåŸºäº"Reducer"æ¨¡å¼ï¼ˆReduxçš„æ ¸å¿ƒæ€æƒ³ï¼‰æ¥ç®¡ç†å¤æ‚çŠ¶æ€ã€‚

<Box style={{ padding: '20px', background: '#e8f5e9', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#2e7d32' }}>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>Reducer</strong>æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œæ¥æ”¶å½“å‰çŠ¶æ€å’Œactionï¼Œè¿”å›æ–°çŠ¶æ€ã€‚å®ƒéµå¾ªï¼š<code>(state, action) => newState</code>
  </p>
</Box>

### 1.1 åŸºæœ¬è¯­æ³•

```javascript
const [state, dispatch] = useReducer(reducer, initialState, init?);
```

- `reducer`: çŠ¶æ€æ›´æ–°å‡½æ•° `(state, action) => newState`
- `initialState`: åˆå§‹çŠ¶æ€
- `init`: å¯é€‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œç”¨äºæƒ°æ€§åˆå§‹åŒ–
- `dispatch`: è§¦å‘çŠ¶æ€æ›´æ–°çš„å‡½æ•°

### 1.2 ç®€å•ç¤ºä¾‹

<CodeBlock>

```jsx
import { useReducer } from 'react';

// 1. å®šä¹‰reducerå‡½æ•°
function counterReducer(state, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { count: state.count + 1 };
    case 'DECREMENT':
      return { count: state.count - 1 };
    case 'RESET':
      return { count: 0 };
    default:
      return state;
  }
}

// 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨useReducer
function Counter() {
  const [state, dispatch] = useReducer(counterReducer, { count: 0 });

  return (
    <div>
      <p>è®¡æ•°: {state.count}</p>
      <button onClick={() => dispatch({ type: 'INCREMENT' })}>
        +1
      </button>
      <button onClick={() => dispatch({ type: 'DECREMENT' })}>
        -1
      </button>
      <button onClick={() => dispatch({ type: 'RESET' })}>
        é‡ç½®
      </button>
    </div>
  );
}
```

</CodeBlock>

## 2. äº¤äº’å¼ç¤ºä¾‹ï¼šTODOåº”ç”¨

<LiveCode
  code={`
function TodoApp() {
  // Reducerå‡½æ•°
  const todoReducer = (state, action) => {
    switch (action.type) {
      case 'ADD_TODO':
        return {
          ...state,
          todos: [
            ...state.todos,
            {
              id: Date.now(),
              text: action.payload,
              completed: false
            }
          ]
        };
      case 'TOGGLE_TODO':
        return {
          ...state,
          todos: state.todos.map(todo =>
            todo.id === action.payload
              ? { ...todo, completed: !todo.completed }
              : todo
          )
        };
      case 'DELETE_TODO':
        return {
          ...state,
          todos: state.todos.filter(todo => todo.id !== action.payload)
        };
      case 'CLEAR_COMPLETED':
        return {
          ...state,
          todos: state.todos.filter(todo => !todo.completed)
        };
      default:
        return state;
    }
  };

  // åˆå§‹çŠ¶æ€
  const initialState = {
    todos: [],
    filter: 'all' // 'all', 'active', 'completed'
  };

  const [state, dispatch] = useReducer(todoReducer, initialState);
  const [inputValue, setInputValue] = React.useState('');

  const addTodo = () => {
    if (inputValue.trim()) {
      dispatch({ type: 'ADD_TODO', payload: inputValue });
      setInputValue('');
    }
  };

  const activeCount = state.todos.filter(todo => !todo.completed).length;
  const completedCount = state.todos.length - activeCount;

  return (
    <div style={{
      maxWidth: '600px',
      margin: '0 auto',
      padding: '20px',
      fontFamily: 'Arial, sans-serif'
    }}>
      <h1 style={{ textAlign: 'center', color: '#333' }}>ğŸ“ TODOåº”ç”¨</h1>

      {/* è¾“å…¥æ¡† */}
      <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
        <input
          type="text"
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && addTodo()}
          placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
          style={{
            flex: 1,
            padding: '10px',
            fontSize: '16px',
            border: '2px solid #ddd',
            borderRadius: '6px',
            outline: 'none'
          }}
        />
        <button
          onClick={addTodo}
          style={{
            padding: '10px 20px',
            fontSize: '16px',
            backgroundColor: '#4CAF50',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer'
          }}
        >
          æ·»åŠ 
        </button>
      </div>

      {/* ç»Ÿè®¡ä¿¡æ¯ */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-around',
        marginBottom: '20px',
        padding: '15px',
        backgroundColor: '#f5f5f5',
        borderRadius: '6px'
      }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#333' }}>{activeCount}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>è¿›è¡Œä¸­</div>
        </div>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>{completedCount}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>å·²å®Œæˆ</div>
        </div>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2196F3' }}>{state.todos.length}</div>
          <div style={{ fontSize: '12px', color: '#666' }}>æ€»è®¡</div>
        </div>
      </div>

      {/* TODOåˆ—è¡¨ */}
      <div>
        {state.todos.length === 0 ? (
          <p style={{ textAlign: 'center', color: '#999', padding: '40px 0' }}>
            è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå§ï¼
          </p>
        ) : (
          state.todos.map(todo => (
            <div
              key={todo.id}
              style={{
                display: 'flex',
                alignItems: 'center',
                padding: '12px',
                marginBottom: '8px',
                backgroundColor: todo.completed ? '#e8f5e9' : '#fff',
                border: '1px solid #ddd',
                borderRadius: '6px',
                textDecoration: todo.completed ? 'line-through' : 'none',
                opacity: todo.completed ? 0.7 : 1
              }}
            >
              <input
                type="checkbox"
                checked={todo.completed}
                onChange={() => dispatch({ type: 'TOGGLE_TODO', payload: todo.id })}
                style={{ marginRight: '12px', width: '18px', height: '18px' }}
              />
              <span style={{ flex: 1, color: '#333' }}>{todo.text}</span>
              <button
                onClick={() => dispatch({ type: 'DELETE_TODO', payload: todo.id })}
                style={{
                  padding: '6px 12px',
                  backgroundColor: '#f44336',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '14px'
                }}
              >
                åˆ é™¤
              </button>
            </div>
          ))
        )}
      </div>

      {/* æ¸…é™¤æŒ‰é’® */}
      {completedCount > 0 && (
        <button
          onClick={() => dispatch({ type: 'CLEAR_COMPLETED' })}
          style={{
            width: '100%',
            padding: '12px',
            marginTop: '20px',
            fontSize: '16px',
            backgroundColor: '#ff9800',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer'
          }}
        >
          æ¸…é™¤å·²å®Œæˆä»»åŠ¡ ({completedCount})
        </button>
      )}
    </div>
  );
}
  `}
/>

è¿™ä¸ªäº¤äº’å¼ç¤ºä¾‹å±•ç¤ºäº†useReducerçš„å¼ºå¤§åŠŸèƒ½ï¼š
- âœ… å¤æ‚çŠ¶æ€é€»è¾‘ç®¡ç†
- âœ… å¤šä¸ªç›¸å…³çŠ¶æ€ï¼ˆtodosåˆ—è¡¨ï¼‰
- âœ… åŸºäºactionçš„ä¸å¯å˜çŠ¶æ€æ›´æ–°
- âœ… çŠ¶æ€çš„æ´¾ç”Ÿè®¡ç®—ï¼ˆactiveCount, completedCountï¼‰

---

## 3. useState vs useReducer

### 2.1 ä½•æ—¶ä½¿ç”¨useReducer

<Grid>

<div>
  <h4>ä½¿ç”¨useState</h4>
  <ul>
    <li>âœ… ç®€å•çš„ç‹¬ç«‹çŠ¶æ€ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”ï¼‰</li>
    <li>âœ… çŠ¶æ€æ›´æ–°é€»è¾‘ç®€å•</li>
    <li>âœ… çŠ¶æ€ä¹‹é—´ç›¸äº’ç‹¬ç«‹</li>
    <li>âœ… çŠ¶æ€çš„ä¸‹ä¸€å€¼ä¸»è¦ä¾èµ–äºå½“å‰çš„åŸå§‹å€¼</li>
    <li>âœ… çŠ¶æ€æ›´æ–°ä¸é¢‘ç¹</li>
  </ul>
</div>

<div>
  <h4>ä½¿ç”¨useReducer</h4>
  <ul>
    <li>âœ… å¤æ‚çš„çŠ¶æ€å¯¹è±¡ï¼ˆåŒ…å«å¤šä¸ªå­—æ®µï¼‰</li>
    <li>âœ… çŠ¶æ€æ›´æ–°é€»è¾‘å¤æ‚</li>
    <li>âœ… å¤šä¸ªçŠ¶æ€ç›¸äº’ä¾èµ–æˆ–ç›¸å…³</li>
    <li>âœ… çŠ¶æ€çš„ä¸‹ä¸€å€¼ä¾èµ–äºå…ˆå‰çš„å€¼</li>
    <li>âœ… éœ€è¦ä¸­é—´ä»¶ï¼ˆå¦‚æ—¥å¿—ã€å¼‚æ­¥å¤„ç†ï¼‰</li>
    <li>âœ… çŠ¶æ€æ›´æ–°é¢‘ç¹ä¸”æœ‰æ¨¡å¼å¯å¾ª</li>
  </ul>
</div>

</Grid>

### 2.2 å¯¹æ¯”ç¤ºä¾‹

<Compare>

```jsx
// ä½¿ç”¨useState - é€‚åˆç®€å•çŠ¶æ€
function CounterWithState() {
  const [count, setCount] = useState(0);
  const [step, setStep] = useState(1);

  const increment = () => setCount(count + step);
  const decrement = () => setCount(count - step);
  const updateStep = (value) => setStep(value);

  return (
    <div>
      <p>è®¡æ•°: {count}</p>
      <input
        type="number"
        value={step}
        onChange={(e) => updateStep(Number(e.target.value))}
      />
      <button onClick={increment}>+{step}</button>
      <button onClick={decrement}>-{step}</button>
    </div>
  );
}

// ä½¿ç”¨useReducer - é€‚åˆå¤æ‚çŠ¶æ€
function CounterWithReducer() {
  const [state, dispatch] = useReducer(counterReducer, {
    count: 0,
    step: 1
  });

  return (
    <div>
      <p>è®¡æ•°: {state.count}</p>
      <input
        type="number"
        value={state.step}
        onChange={(e) =>
          dispatch({ type: 'UPDATE_STEP', payload: Number(e.target.value) })
        }
      />
      <button onClick={() => dispatch({ type: 'INCREMENT' })}>
        +{state.step}
      </button>
      <button onClick={() => dispatch({ type: 'DECREMENT' })}>
        -{state.step}
      </button>
    </div>
  );
}

function counterReducer(state, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { ...state, count: state.count + state.step };
    case 'DECREMENT':
      return { ...state, count: state.count - state.step };
    case 'UPDATE_STEP':
      return { ...state, step: action.payload };
    default:
      return state;
  }
}
```

</Compare>

---

## 3. Reducerè®¾è®¡æ¨¡å¼

### 3.1 Actionç»“æ„

<CodeBlock>

```jsx
// ç®€å•çš„type
dispatch({ type: 'INCREMENT' });

// å¸¦æ•°æ®çš„action
dispatch({ type: 'ADD_TODO', payload: { id: 1, text: 'Learn React' } });

// ä½¿ç”¨payloadå‘½åçº¦å®š
dispatch({
  type: 'UPDATE_USER',
  payload: {
    id: 1,
    name: 'John',
    email: 'john@example.com'
  }
});

// å¤šä¸ªå­—æ®µ
dispatch({
  type: 'SET_FORM_DATA',
  payload: {
    field: 'name',
    value: 'John'
  }
});
```

</CodeBlock>

### 3.2 ä¸å¯å˜æ›´æ–°

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç›´æ¥ä¿®æ”¹state
function badReducer(state, action) {
  switch (action.type) {
    case 'ADD_ITEM':
      state.items.push(action.payload);  // ç›´æ¥ä¿®æ”¹ï¼
      return state;
    default:
      return state;
  }
}

// âœ… æ­£ç¡® - åˆ›å»ºæ–°å¯¹è±¡/æ•°ç»„
function goodReducer(state, action) {
  switch (action.type) {
    case 'ADD_ITEM':
      return {
        ...state,  // å±•å¼€å…¶ä»–å­—æ®µ
        items: [
          ...state.items,  // å±•å¼€ç°æœ‰æ•°ç»„
          action.payload  // æ·»åŠ æ–°é¡¹
        ]
      };
    case 'UPDATE_ITEM':
      return {
        ...state,
        items: state.items.map(item =>
          item.id === action.payload.id
            ? { ...item, ...action.payload }  // åˆ›å»ºæ–°å¯¹è±¡
            : item
        )
      };
    case 'REMOVE_ITEM':
      return {
        ...state,
        items: state.items.filter(item => item.id !== action.payload)
      };
    default:
      return state;
  }
}
```

</ErrorBox>

### 3.3 åµŒå¥—å¯¹è±¡æ›´æ–°

<CodeBlock>

```jsx
// æ›´æ–°åµŒå¥—å¯¹è±¡
function updateNestedReducer(state, action) {
  switch (action.type) {
    case 'UPDATE_USER_NAME':
      return {
        ...state,
        user: {
          ...state.user,
          profile: {
            ...state.user.profile,
            name: action.payload
          }
        }
      };
    case 'UPDATE_USER_ADDRESS':
      return {
        ...state,
        user: {
          ...state.user,
          address: {
            ...state.user.address,
            ...action.payload
          }
        }
      };
    default:
      return state;
  }
}

// ä½¿ç”¨å‡½æ•°å¼æ›´æ–°ï¼ˆæ¨èï¼‰
function functionalUpdateReducer(state, action) {
  switch (action.type) {
    case 'INCREMENT_COUNT':
      return {
        ...state,
        count: state.count + action.payload
      };
    default:
      return state;
  }
}
```

</CodeBlock>

---

## 4. å®é™…åº”ç”¨åœºæ™¯

### 4.1 å¾…åŠäº‹é¡¹åˆ—è¡¨

<CodeBlock>

```jsx
import { useReducer } from 'react';

function todosReducer(state, action) {
  switch (action.type) {
    case 'ADD_TODO':
      return {
        ...state,
        todos: [
          ...state.todos,
          {
            id: Date.now(),
            text: action.payload,
            completed: false
          }
        ]
      };
    case 'TOGGLE_TODO':
      return {
        ...state,
        todos: state.todos.map(todo =>
          todo.id === action.payload
            ? { ...todo, completed: !todo.completed }
            : todo
        )
      };
    case 'REMOVE_TODO':
      return {
        ...state,
        todos: state.todos.filter(todo => todo.id !== action.payload)
      };
    case 'CLEAR_COMPLETED':
      return {
        ...state,
        todos: state.todos.filter(todo => !todo.completed)
      };
    case 'SET_FILTER':
      return {
        ...state,
        filter: action.payload
      };
    default:
      return state;
  }
}

function TodoList() {
  const [state, dispatch] = useReducer(todosReducer, {
    todos: [],
    filter: 'all'  // 'all', 'active', 'completed'
  });

  const filteredTodos = state.todos.filter(todo => {
    if (state.filter === 'active') return !todo.completed;
    if (state.filter === 'completed') return todo.completed;
    return true;
  });

  return (
    <div>
      <h2>å¾…åŠäº‹é¡¹åˆ—è¡¨</h2>
      <TodoInput onAdd={(text) => dispatch({ type: 'ADD_TODO', payload: text })} />

      <div>
        <button onClick={() => dispatch({ type: 'SET_FILTER', payload: 'all' })}>
          å…¨éƒ¨
        </button>
        <button onClick={() => dispatch({ type: 'SET_FILTER', payload: 'active' })}>
          å¾…å¤„ç†
        </button>
        <button onClick={() => dispatch({ type: 'SET_FILTER', payload: 'completed' })}>
          å·²å®Œæˆ
        </button>
      </div>

      <ul>
        {filteredTodos.map(todo => (
          <li key={todo.id}>
            <input
              type="checkbox"
              checked={todo.completed}
              onChange={() => dispatch({ type: 'TOGGLE_TODO', payload: todo.id })}
            />
            <span
              style={{
                textDecoration: todo.completed ? 'line-through' : 'none'
              }}
            >
              {todo.text}
            </span>
            <button onClick={() => dispatch({ type: 'REMOVE_TODO', payload: todo.id })}>
              åˆ é™¤
            </button>
          </li>
        ))}
      </ul>

      <button onClick={() => dispatch({ type: 'CLEAR_COMPLETED' })}>
        æ¸…é™¤å·²å®Œæˆ
      </button>
    </div>
  );
}

function TodoInput({ onAdd }) {
  const [input, setInput] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (input.trim()) {
      onAdd(input.trim());
      setInput('');
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="text"
        value={input}
        onChange={(e) => setInput(e.target.value)}
        placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
      />
      <button type="submit">æ·»åŠ </button>
    </form>
  );
}
```

</CodeBlock>

### 4.2 è¡¨å•ç®¡ç†

<CodeBlock>

```jsx
import { useReducer } from 'react';

function formReducer(state, action) {
  switch (action.type) {
    case 'SET_FIELD':
      return {
        ...state,
        formData: {
          ...state.formData,
          [action.field]: action.value
        },
        errors: {
          ...state.errors,
          [action.field]: ''  // æ¸…é™¤è¯¥å­—æ®µçš„é”™è¯¯
        }
      };
    case 'SET_ERROR':
      return {
        ...state,
        errors: {
          ...state.errors,
          [action.field]: action.error
        }
      };
    case 'RESET_FORM':
      return {
        formData: initialFormData,
        errors: {}
      };
    default:
      return state;
  }
}

function RegistrationForm() {
  const [state, dispatch] = useReducer(formReducer, {
    formData: {
      name: '',
      email: '',
      password: '',
      confirmPassword: ''
    },
    errors: {}
  });

  const handleChange = (field) => (e) => {
    dispatch({
      type: 'SET_FIELD',
      field,
      value: e.target.value
    });
  };

  const validate = () => {
    const errors = {};
    if (!state.formData.name) {
      errors.name = 'å§“åä¸èƒ½ä¸ºç©º';
    }
    if (!state.formData.email) {
      errors.email = 'é‚®ç®±ä¸èƒ½ä¸ºç©º';
    } else if (!/\S+@\S+\.\S+/.test(state.formData.email)) {
      errors.email = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
    }
    if (state.formData.password.length < 6) {
      errors.password = 'å¯†ç è‡³å°‘6ä½';
    }
    if (state.formData.password !== state.formData.confirmPassword) {
      errors.confirmPassword = 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
    }

    return errors;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const errors = validate();

    if (Object.keys(errors).length > 0) {
      // è®¾ç½®é”™è¯¯
      Object.entries(errors).forEach(([field, error]) => {
        dispatch({ type: 'SET_ERROR', field, error });
      });
      return;
    }

    // æäº¤è¡¨å•
    console.log('æäº¤æ•°æ®:', state.formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      <div>
        <label>å§“å:</label>
        <input
          type="text"
          value={state.formData.name}
          onChange={handleChange('name')}
        />
        {state.errors.name && <p style={{ color: 'red' }}>{state.errors.name}</p>}
      </div>

      <div>
        <label>é‚®ç®±:</label>
        <input
          type="email"
          value={state.formData.email}
          onChange={handleChange('email')}
        />
        {state.errors.email && <p style={{ color: 'red' }}>{state.errors.email}</p>}
      </div>

      <div>
        <label>å¯†ç :</label>
        <input
          type="password"
          value={state.formData.password}
          onChange={handleChange('password')}
        />
        {state.errors.password && <p style={{ color: 'red' }}>{state.errors.password}</p>}
      </div>

      <div>
        <label>ç¡®è®¤å¯†ç :</label>
        <input
          type="password"
          value={state.formData.confirmPassword}
          onChange={handleChange('confirmPassword')}
        />
        {state.errors.confirmPassword && <p style={{ color: 'red' }}>{state.errors.confirmPassword}</p>}
      </div>

      <button type="submit">æ³¨å†Œ</button>
      <button type="button" onClick={() => dispatch({ type: 'RESET_FORM' })}>
        é‡ç½®
      </button>
    </form>
  );
}
```

</CodeBlock>

---

## 5. é«˜çº§ç”¨æ³•

### 5.1 æƒ°æ€§åˆå§‹åŒ–

<CodeBlock>

```jsx
// ä½¿ç”¨initå‡½æ•°è¿›è¡Œæƒ°æ€§åˆå§‹åŒ–
function init(initialCount) {
  // ä»localStorageè¯»å–åˆå§‹å€¼
  const saved = localStorage.getItem('count');
  return saved ? Number(saved) : initialCount;
}

function Counter() {
  const [state, dispatch] = useReducer(reducer, 0, init);

  // å½“stateå˜åŒ–æ—¶ä¿å­˜åˆ°localStorage
  useEffect(() => {
    localStorage.setItem('count', state.count);
  }, [state.count]);

  return (
    <div>
      <p>è®¡æ•°: {state.count}</p>
      <button onClick={() => dispatch({ type: 'RESET' })}>
        é‡ç½®
      </button>
      <button onClick={() => dispatch({ type: 'DECREMENT' })}>
        -1
      </button>
      <button onClick={() => dispatch({ type: 'INCREMENT' })}>
        +1
      </button>
    </div>
  );
}

function reducer(state, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { count: state.count + 1 };
    case 'DECREMENT':
      return { count: state.count - 1 };
    case 'RESET':
      return { count: 0 };
    default:
      throw new Error();
  }
}
```

</CodeBlock>

### 5.2 å¤æ‚çš„çŠ¶æ€æœº

<CodeBlock>

```jsx
// ä½¿ç”¨useReducerå®ç°çŠ¶æ€æœº
function asyncReducer(state, action) {
  switch (action.type) {
    case 'START':
      return {
        status: 'loading',
        data: null,
        error: null
      };
    case 'SUCCESS':
      return {
        status: 'success',
        data: action.payload,
        error: null
      };
    case 'ERROR':
      return {
        status: 'error',
        data: null,
        error: action.payload
      };
    case 'RESET':
      return initialState;
    default:
      return state;
  }
}

function useAsyncData(url) {
  const [state, dispatch] = useReducer(asyncReducer, {
    status: 'idle',  // 'idle', 'loading', 'success', 'error'
    data: null,
    error: null
  });

  useEffect(() => {
    if (!url) return;

    dispatch({ type: 'START' });

    const fetchData = async () => {
      try {
        const response = await fetch(url);
        const data = await response.json();
        dispatch({ type: 'SUCCESS', payload: data });
      } catch (error) {
        dispatch({ type: 'ERROR', payload: error.message });
      }
    };

    fetchData();
  }, [url]);

  return state;  // { status, data, error }
}

function DataComponent() {
  const { status, data, error } = useAsyncData('/api/users');

  if (status === 'loading') return <p>åŠ è½½ä¸­...</p>;
  if (status === 'error') return <p>é”™è¯¯: {error}</p>;
  if (status === 'success') return <p>æ•°æ®: {data}</p>;
  return null;
}
```

</CodeBlock>

### 5.3 ä¸­é—´ä»¶æ¨¡å¼

<CodeBlock>

```jsx
// å®ç°ç±»ä¼¼Reduxçš„ä¸­é—´ä»¶
function logger(reducer) {
  return (state, action) => {
    console.log('state before:', state);
    console.log('action:', action);
    const nextState = reducer(state, action);
    console.log('state after:', nextState);
    return nextState;
  };
}

function localStorageReducer(reducer) {
  return (state, action) => {
    const nextState = reducer(state, action);
    // ä¿å­˜æŸäº›actionåˆ°localStorage
    if (action.type.startsWith('UPDATE_')) {
      localStorage.setItem('appState', JSON.stringify(nextState));
    }
    return nextState;
  };
}

function configureStore(reducer) {
  return localStorageReducer(logger(reducer));
}

// ä½¿ç”¨ä¸­é—´ä»¶
const rootReducer = configureStore(todosReducer);
function TodoApp() {
  const [state, dispatch] = useReducer(rootReducer, initialState);
  // ...
}
```

</CodeBlock>

### 5.4 ä¸Contextç»“åˆ

<CodeBlock>

```jsx
import { createContext, useContext, useReducer } from 'react';

// åˆ›å»ºContext
const AppContext = createContext();

// Providerç»„ä»¶
function AppProvider({ children }) {
  const [state, dispatch] = useReducer(appReducer, initialState);

  const value = {
    state,
    dispatch
  };

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}

// è‡ªå®šä¹‰Hook
function useApp() {
  const context = useContext(AppContext);
  if (!context) {
    throw new Error('useApp must be used within AppProvider');
  }
  return context;
}

// ä½¿ç”¨
function Header() {
  const { state, dispatch } = useApp();
  return (
    <div>
      <h1>{state.title}</h1>
      <button onClick={() => dispatch({ type: 'TOGGLE_THEME' })}>
        åˆ‡æ¢ä¸»é¢˜
      </button>
    </div>
  );
}
```

</CodeBlock>

---

## 6. å¸¸è§é”™è¯¯ä¸é™·é˜±

### 6.1 å¿˜è®°ä¸å¯å˜æ›´æ–°

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç›´æ¥ä¿®æ”¹state
function badReducer(state, action) {
  switch (action.type) {
    case 'ADD_ITEM':
      state.items.push(action.payload);  // ä¿®æ”¹åŸå¯¹è±¡ï¼
      return state;
    default:
      return state;
  }
}

// âœ… æ­£ç¡® - åˆ›å»ºæ–°å¯¹è±¡
function goodReducer(state, action) {
  switch (action.type) {
    case 'ADD_ITEM':
      return {
        ...state,
        items: [...state.items, action.payload]
      };
    default:
      return state;
  }
}
```

</ErrorBox>

### 6.2 ä¸æ­£ç¡®çš„é»˜è®¤case

<ErrorBox>

```jsx

```jsx
// âŒ é”™è¯¯ - æ²¡æœ‰è¿”å›state
function badReducer(state, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { count: state.count + 1 };
    // ç¼ºå°‘defaultæˆ–å…¶ä»–case
  }
}

// âœ… æ­£ç¡® - å§‹ç»ˆè¿”å›state
function goodReducer(state, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { count: state.count + 1 };
    case 'DECREMENT':
      return { count: state.count - 1 };
    default:
      return state;  // å¿…é¡»è¿”å›å½“å‰state
  }
}
```

</ErrorBox>

### 6.3 åœ¨reducerä¸­æ‰§è¡Œå‰¯ä½œç”¨

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - åœ¨reducerä¸­æ‰§è¡Œå‰¯ä½œç”¨
function badReducer(state, action) {
  switch (action.type) {
    case 'ADD_TODO':
      console.log('Adding todo');  // å‰¯ä½œç”¨ï¼
      return {
        ...state,
        todos: [...state.todos, action.payload]
      };
    case 'INCREMENT':
      localStorage.setItem('count', state.count);  // å‰¯ä½œç”¨ï¼
      return { count: state.count + 1 };
    default:
      return state;
  }
}

// âœ… æ­£ç¡® - çº¯å‡½æ•°ï¼Œä¸æ‰§è¡Œå‰¯ä½œç”¨
function goodReducer(state, action) {
  switch (action.type) {
    case 'ADD_TODO':
      return {
        ...state,
        todos: [...state.todos, action.payload]
      };
    case 'INCREMENT':
      return { count: state.count + 1 };
    default:
      return state;
  }
}

// åœ¨ç»„ä»¶ä¸­å¤„ç†å‰¯ä½œç”¨
function App() {
  const [state, dispatch] = useReducer(reducer, initialState);

  useEffect(() => {
    localStorage.setItem('count', state.count);
  }, [state.count]);  // åœ¨effectä¸­å¤„ç†å‰¯ä½œç”¨
}
```

</ErrorBox>

### 6.4 ä½¿ç”¨éçº¯å‡½æ•°ä½œä¸ºåˆå§‹å€¼

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡ŒexpensiveOperation
function BadComponent() {
  const [state, dispatch] = useReducer(reducer, expensiveOperation());
  // ...
}

// âœ… æ­£ç¡® - æƒ°æ€§åˆå§‹åŒ–
function GoodComponent() {
  const [state, dispatch] = useReducer(
    reducer,
    0,
    (initial) => expensiveOperation(initial)
  );
  // ...
}
```

</ErrorBox>

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 ä½¿ç”¨useCallbackä¼˜åŒ–dispatchå‡½æ•°

<CodeBlock>

```jsx
function OptimizedComponent() {
  const [state, dispatch] = useReducer(reducer, initialState);

  // ç¼“å­˜action creators
  const actions = useMemo(() => ({
    increment: () => dispatch({ type: 'INCREMENT' }),
    decrement: () => dispatch({ type: 'DECREMENT' }),
    add: (value) => dispatch({ type: 'ADD', payload: value })
  }), []);  // ç©ºä¾èµ–æ•°ç»„ï¼Œå› ä¸ºdispatchæ€»æ˜¯ç¨³å®šå¼•ç”¨

  return (
    <div>
      <p>{state.count}</p>
      <button onClick={actions.increment}>+1</button>
      <button onClick={actions.decrement}>-1</button>
      <button onClick={() => actions.add(5)}>+5</button>
    </div>
  );
}
```

</CodeBlock>

### 7.2 ä½¿ç”¨useRefä¿å­˜æœ€æ–°çŠ¶æ€

<CodeBlock>

```jsx
function ComponentWithRef() {
  const [state, dispatch] = useReducer(reducer, initialState);
  const prevStateRef = useRef();

  useEffect(() => {
    prevStateRef.current = state;
  });

  // åœ¨reducerä¸­è®¿é—®å‰ä¸€ä¸ªçŠ¶æ€
  function reducer(state, action) {
    if (action.type === 'INCREMENT') {
      return {
        count: state.count + 1,
        previousCount: prevStateRef.current?.count
      };
    }
    return state;
  }

  return <div>{state.count}</div>;
}
```

</CodeBlock>

---

## 8. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šè´­ç‰©è½¦

åˆ›å»ºä¸€ä¸ªè´­ç‰©è½¦åº”ç”¨ï¼Œæ”¯æŒæ·»åŠ å•†å“ã€ä¿®æ”¹æ•°é‡ã€åˆ é™¤å•†å“å’Œè®¡ç®—æ€»ä»·ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å•†å“åˆ—è¡¨å±•ç¤º
- æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
- ä¿®æ”¹è´­ç‰©è½¦å•†å“æ•°é‡
- åˆ é™¤å•†å“
- è®¡ç®—æ€»ä»·
- æ¸…ç©ºè´­ç‰©è½¦

**æ•°æ®ç»“æ„**ï¼š
```javascript
// å•†å“
{ id, name, price, image }

// è´­ç‰©è½¦çŠ¶æ€
{
  items: [
    {
      productId: string,
      quantity: number,
      product: Product
    }
  ],
  total: number
}
```

**æç¤º**ï¼š
- ä½¿ç”¨useReducerç®¡ç†è´­ç‰©è½¦çŠ¶æ€
- çŠ¶æ€æ›´æ–°éœ€è¦è®¡ç®—æ€»ä»·
- å®ç°æ•°é‡ä¿®æ”¹å’Œåˆ é™¤é€»è¾‘

</Expandable>

### ç»ƒä¹ 2ï¼šçŠ¶æ€æœº

åˆ›å»ºä¸€ä¸ªHTTPè¯·æ±‚çŠ¶æ€æœºï¼Œç®¡ç†è¯·æ±‚çš„åŠ è½½ã€æˆåŠŸå’Œå¤±è´¥çŠ¶æ€ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- è¯·æ±‚çŠ¶æ€ï¼šç©ºé—²ã€åŠ è½½ä¸­ã€æˆåŠŸã€å¤±è´¥
- æ˜¾ç¤ºä¸åŒçŠ¶æ€çš„UI
- æ”¯æŒé‡è¯•
- é”™è¯¯ä¿¡æ¯å±•ç¤º
- æ•°æ®ç¼“å­˜

**çŠ¶æ€ç»“æ„**ï¼š
```javascript
{
  status: 'idle' | 'loading' | 'success' | 'error',
  data: any,
  error: string | null,
  timestamp: number
}
```

**æç¤º**ï¼š
- ä½¿ç”¨useReducerå®ç°çŠ¶æ€æœº
- åœ¨effectä¸­å¤„ç†å®é™…è¯·æ±‚
- æ ¹æ®ä¸åŒçŠ¶æ€æ¸²æŸ“ä¸åŒUI

</Expandable>

### ç»ƒä¹ 3ï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨

åˆ›å»ºä¸€ä¸ªç®€å•çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ’¤é”€/é‡åšã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ–‡æœ¬è¾“å…¥åŒºåŸŸ
- æ’¤é”€æŒ‰é’®
- é‡åšæŒ‰é’®
- è®°å½•å†å²çŠ¶æ€
- é™åˆ¶å†å²è®°å½•æ•°é‡

**æç¤º**ï¼š
- ä½¿ç”¨ä¸¤ä¸ªå †æ ˆï¼šä¸€ä¸ªç”¨äºæ’¤é”€ï¼Œä¸€ä¸ªç”¨äºé‡åš
- åœ¨reducerä¸­ç®¡ç†å†å²è®°å½•
- å®ç°æ’¤é”€/é‡åšé€»è¾‘

**çŠ¶æ€ç»“æ„**ï¼š
```javascript
{
  text: string,
  history: string[],
  historyIndex: number,
  maxHistory: number
}
```

</Expandable>

### ç»ƒä¹ 4ï¼šæ¸¸æˆçŠ¶æ€ç®¡ç†

åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ã€‚

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ¸¸æˆçŠ¶æ€ï¼šç­‰å¾…ã€è¿›è¡Œä¸­ã€æš‚åœã€ç»“æŸ
- ç©å®¶ä½ç½®è·Ÿè¸ª
- å¾—åˆ†ç³»ç»Ÿ
- ç¢°æ’æ£€æµ‹
- æ¸¸æˆé‡ç½®

**æç¤º**ï¼š
- ä½¿ç”¨çŠ¶æ€æœºæ¨¡å¼ç®¡ç†æ¸¸æˆçŠ¶æ€
- åœ¨reducerä¸­å¤„ç†æ¸¸æˆé€»è¾‘
- ä½¿ç”¨useEffectå¤„ç†åŠ¨ç”»

**çŠ¶æ€ç»“æ„**ï¼š
```javascript
{
  gameStatus: 'waiting' | 'playing' | 'paused' | 'gameOver',
  player: { x: number, y: number },
  score: number,
  level: number
}
```

</Expandable>

---

## 9. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… useReduceré€‚ç”¨äºå¤æ‚çŠ¶æ€é€»è¾‘
- âœ… Reduceræ˜¯çº¯å‡½æ•°ï¼Œéµå¾ª`(state, action) => newState`
- âœ… Actionæè¿°çŠ¶æ€å˜åŒ–ï¼ŒåŒ…å«`type`å’Œå¯é€‰çš„`payload`
- âœ… å§‹ç»ˆä½¿ç”¨ä¸å¯å˜æ›´æ–°
- âœ… useReduceræ¯”useStateæ›´é€‚åˆå¤æ‚çŠ¶æ€
- âœ… æ”¯æŒæƒ°æ€§åˆå§‹åŒ–å’Œä¸­é—´ä»¶
- âœ… å¯ä»¥ä¸Contextç»“åˆå®ç°å…¨å±€çŠ¶æ€ç®¡ç†
- âœ… é¿å…åœ¨reducerä¸­æ‰§è¡Œå‰¯ä½œç”¨
- âœ… dispatchå‡½æ•°å¼•ç”¨ç¨³å®šï¼Œå¯å®‰å…¨ä¼ é€’ç»™å­ç»„ä»¶

</Checklist>

### æœ€ä½³å®è·µ

<BestPractices>

1. **ä¿æŒreducerçº¯å‡½æ•°** - ä¸ä¿®æ”¹è¾“å…¥ï¼Œä¸æ‰§è¡Œå‰¯ä½œç”¨
2. **ä½¿ç”¨TypeScript** - ä¸ºstateå’Œactionå®šä¹‰ç±»å‹
3. **æ‹†åˆ†reducer** - å¤§åº”ç”¨ä¸­ä½¿ç”¨combineReducersæ¨¡å¼
4. **ä½¿ç”¨action creator** - é¿å…ç›´æ¥ä¼ é€’actionå¯¹è±¡
5. **æ·»åŠ æ—¥å¿—** - å¼€å‘æ—¶è®°å½•æ‰€æœ‰actionå’Œstateå˜åŒ–
6. **åˆç†ä½¿ç”¨ä¸­é—´ä»¶** - å¤„ç†æ—¥å¿—ã€æŒä¹…åŒ–ã€å¼‚æ­¥ç­‰

</BestPractices>

### æ€§èƒ½è€ƒè™‘

- **dispatchç¨³å®šå¼•ç”¨** - useCallbackçš„ä¾èµ–æ•°ç»„å¯ä»¥ä¸ºç©º
- **é¿å…é‡å¤è®¡ç®—** - ä½¿ç”¨useMemoç¼“å­˜æ´¾ç”Ÿå€¼
- **åˆç†æ‹†åˆ†çŠ¶æ€** - ä¸ç›¸å…³çš„çŠ¶æ€ä½¿ç”¨ä¸åŒçš„useReducer
- **ä½¿ç”¨æ‰¹é‡æ›´æ–°** - å¤šä¸ªactionå¯ä»¥åˆå¹¶å¤„ç†

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†useReducerï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ ï¼š

1. **[useCallback](useCallback)** - ä¼˜åŒ–äº‹ä»¶å¤„ç†å‡½æ•°
2. **[useMemo](useMemo)** - ä¼˜åŒ–è®¡ç®—å€¼
3. **[è‡ªå®šä¹‰Hooks](custom-hooks)** - åˆ›å»ºå¯å¤ç”¨çš„çŠ¶æ€é€»è¾‘

---

## 10. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [useReducer APIå‚è€ƒ](https://react.dev/reference/react/useReducer) - Reactå®˜æ–¹æ–‡æ¡£
- [Reduceræ¨¡å¼](https://redux.js.org/understanding/thinking-in-redux/glossary#reducer) - Reduxæ–‡æ¡£
- [çŠ¶æ€å’Œäº‹ä»¶](https://react.dev/learn/extracting-state-logic-into-a-reducer) - å®˜æ–¹æŒ‡å—

### æ¨èé˜…è¯»

- [ReactçŠ¶æ€ç®¡ç†æŒ‡å—](https://kentcdodds.com/blog/application-state-management-with-react) - çŠ¶æ€ç®¡ç†ç­–ç•¥
- [Reduceræœ€ä½³å®è·µ](https://redux.js.org/style-guide/style-guide) - Reduxé£æ ¼æŒ‡å—
- [useReducer vs useState](https://kentcdodds.com/blog/should-i-usestate-or-usereducer) - ä½•æ—¶ä½¿ç”¨useReducer

---

[â† ä¸Šä¸€ç« ï¼šuseContext](basics/useContext) | [ä¸‹ä¸€ç« ï¼šuseCallback â†’](useCallback)
