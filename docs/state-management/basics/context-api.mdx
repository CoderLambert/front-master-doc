# Context APIæ·±åº¦è§£æ - Reactå†…ç½®çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

import { Tabs, TabItem } from '@docusaurus/theme-common';

Context APIæ˜¯React 16.3å¼•å…¥çš„å†…ç½®çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œå®ƒè§£å†³äº†ç»„ä»¶é—´çŠ¶æ€å…±äº«çš„é—®é¢˜ï¼Œæ— éœ€ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å³å¯å®ç°å…¨å±€çŠ¶æ€ç®¡ç†ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨Context APIçš„å·¥ä½œåŸç†ã€é«˜çº§æ¨¡å¼ã€æ€§èƒ½ä¼˜åŒ–å’Œå®é™…åº”ç”¨åœºæ™¯ã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£Context APIçš„å·¥ä½œåŸç†å’Œç”Ÿå‘½å‘¨æœŸ
- æŒæ¡Contextåˆ›å»ºã€Providerå’ŒConsumerçš„ä½¿ç”¨
- å­¦ä¼šä½¿ç”¨useContext Hookä¼˜åŒ–Contextä½¿ç”¨
- ç†è§£Contextæ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- æŒæ¡Contexté«˜çº§æ¨¡å¼ï¼šå¤åˆProviderã€å±€éƒ¨Context
- å­¦ä¼šä½¿ç”¨Contextæ›¿ä»£Reduxçš„åœºæ™¯
- ç†è§£Contextçš„å±€é™æ€§å’Œæœ€ä½³å®è·µ
- æŒæ¡Contextåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨æ¨¡å¼

---

## 1. Context APIåŸºç¡€

Contextæä¾›äº†ä¸€ç§åœ¨ç»„ä»¶æ ‘ä¸­å…±äº«æ•°æ®çš„æ–¹å¼ï¼Œè€Œæ— éœ€åœ¨æ¯ä¸€å±‚éƒ½æ‰‹åŠ¨ä¼ é€’propsã€‚å®ƒé€‚ç”¨äºæ•°æ®å¯ä»¥è¢«å¤šä¸ªç»„ä»¶è®¿é—®ä¸”ä¸ç»å¸¸å˜åŒ–çš„åœºæ™¯ã€‚

<Box style={{ padding: '20px', background: '#e3f2fd', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#1976d2' }}>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>Context</strong>åŒ…å«ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼š<strong>Provider</strong>ï¼ˆæä¾›è€…ï¼‰æä¾›æ•°æ®ï¼Œ<strong>Consumer</strong>ï¼ˆæ¶ˆè´¹è€…ï¼‰æ¶ˆè´¹æ•°æ®ã€‚æ•°æ®é€šè¿‡ç»„ä»¶æ ‘å‘ä¸‹ä¼ é€’ï¼Œæ‰€æœ‰åœ¨Providerå†…çš„ç»„ä»¶éƒ½å¯ä»¥è®¿é—®Contextä¸­çš„æ•°æ®ã€‚
  </p>
</Box>

<CodeBlock>

```jsx
// åŸºç¡€Contextä½¿ç”¨
// 1. åˆ›å»ºContext
const ThemeContext = createContext();

// 2. æä¾›æ•°æ®
function ThemeProvider({ children }) {
  const [theme, setTheme] = useState('light');

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

// 3. æ¶ˆè´¹æ•°æ® - æ–¹å¼1ï¼šClassç»„ä»¶çš„Consumer
class Header extends React.Component {
  render() {
    return (
      <ThemeContext.Consumer>
        {({ theme, setTheme }) => (
          <div className={theme}>
            <h1>My App</h1>
            <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}>
              Toggle Theme
            </button>
          </div>
        )}
      </ThemeContext.Consumer>
    );
  }
}

// 4. æ¶ˆè´¹æ•°æ® - æ–¹å¼2ï¼šFunctionç»„ä»¶ + useContext
function Content() {
  const { theme } = useContext(ThemeContext);

  return (
    <div className={theme}>
      <p>This is the content area</p>
    </div>
  );
}

// 5. ä½¿ç”¨Provider
function App() {
  return (
    <ThemeProvider>
      <Header />
      <Content />
    </ThemeProvider>
  );
}
```

</CodeBlock>

### 1.1 Contextçš„å·¥ä½œæœºåˆ¶

<CodeBlock>

```jsx
// Contextçš„åˆ›å»ºå’Œä¼ é€’æœºåˆ¶
// 1. åˆ›å»ºContextï¼ˆå¯ä»¥åŒ…å«é»˜è®¤å€¼ï¼‰
const UserContext = createContext({
  user: null,
  login: () => {},
  logout: () => {}
});

// 2. Providerä¼ é€’æ•°æ®
function UserProvider({ children }) {
  const [user, setUser] = useState(null);

  const value = {
    user,
    login: (userData) => setUser(userData),
    logout: () => setUser(null)
  };

  // Reactå†…éƒ¨ç»´æŠ¤Contextçš„çŠ¶æ€
  // å½“Providerçš„valueå˜åŒ–æ—¶ï¼Œæ‰€æœ‰Consumeréƒ½ä¼šé‡æ–°æ¸²æŸ“
  return (
    <UserContext.Provider value={value}>
      {children}
    </UserContext.Provider>
  );
}

// 3. Consumerè®¢é˜…Contextå˜åŒ–
// Contextå˜åŒ–è§¦å‘Consumeré‡æ–°æ¸²æŸ“
function Profile() {
  // useContextè®¢é˜…Contextå˜åŒ–
  const { user, logout } = useContext(UserContext);

  // å½“Contextå˜åŒ–æ—¶ï¼ŒProfileä¼šé‡æ–°æ¸²æŸ“
  return user ? (
    <div>
      <p>Welcome, {user.name}</p>
      <button onClick={logout}>Logout</button>
    </div>
  ) : (
    <p>Please log in</p>
  );
}

// 4. ç»„ä»¶æ ‘ç»“æ„
<UserProvider>           {/* Provideråœ¨ç»„ä»¶æ ‘é¡¶ç«¯ */}
  <App>
    <Header />           {/* Consumerå¯ä»¥åµŒå¥—åœ¨ä»»ä½•å±‚çº§ */}
    <Profile />          {/* åªè¦åœ¨Providerå†…å°±èƒ½è®¿é—®Context */}
    <Footer />
  </App>
</UserProvider>
```

</CodeBlock>

### 1.2 é»˜è®¤å€¼çš„é‡è¦æ€§

<CodeBlock>

```jsx
// é»˜è®¤å€¼ç”¨äºæ²¡æœ‰ProvideråŒ…è£¹çš„æƒ…å†µ
const SettingsContext = createContext({
  theme: 'light',
  language: 'en',
  toggleTheme: () => {},
  changeLanguage: () => {}
});

// ä½¿ç”¨é»˜è®¤å€¼
function SettingsButton() {
  // å¦‚æœæ²¡æœ‰è¢«SettingsProvideråŒ…è£¹ï¼Œä½¿ç”¨é»˜è®¤å€¼
  const { toggleTheme } = useContext(SettingsContext);

  return <button onClick={toggleTheme}>Toggle Theme</button>;
}

// é”™è¯¯ï¼šæ²¡æœ‰ProvideråŒ…è£¹ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¯èƒ½ä¸æ˜¯æœŸæœ›çš„è¡Œä¸ºï¼‰
function AppWithoutProvider() {
  return <SettingsButton />;  // toggleThemeæ˜¯ç©ºå‡½æ•°
}

// æ­£ç¡®ï¼šæä¾›Provider
function AppWithProvider() {
  return (
    <SettingsContext.Provider value={{
      theme: 'dark',
      language: 'zh',
      toggleTheme: () => console.log('Toggle'),
      changeLanguage: () => console.log('Change')
    }}>
      <SettingsButton />
    </SettingsContext.Provider>
  );
}
```

</CodeBlock>

---

## 2. useContext Hookæ·±åº¦ä½¿ç”¨

useContextæ˜¯React 16.8å¼•å…¥çš„Hookï¼Œç®€åŒ–äº†Functionç»„ä»¶ä¸­æ¶ˆè´¹Contextçš„ä»£ç ã€‚

<CodeBlock>

```jsx
// useContextåŸºç¡€ç”¨æ³•
function MyComponent() {
  // è®¢é˜…Context
  const contextValue = useContext(MyContext);

  return <div>{contextValue.data}</div>;
}

// å®æˆ˜ï¼šç”¨æˆ·è®¤è¯Context
const AuthContext = createContext(null);

function useAuth() {
  const context = useContext(AuthContext);

  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }

  return context;
}

// ä½¿ç”¨è‡ªå®šä¹‰Hook
function UserProfile() {
  const { user, logout } = useAuth();

  if (!user) {
    return <LoginPage />;
  }

  return (
    <div>
      <h2>Welcome, {user.name}</h2>
      <button onClick={logout}>Logout</button>
    </div>
  );
}

// è‡ªå®šä¹‰Hookçš„ä¼˜åŠ¿
// 1. æ›´å¥½çš„é”™è¯¯æç¤º
// 2. å¯ä»¥æ·»åŠ ä¸šåŠ¡é€»è¾‘
// 3. æä¾›é»˜è®¤å€¼
// 4. å¯ä»¥æœ‰æ¡ä»¶çš„ä½¿ç”¨
function useOptionalAuth() {
  const context = useContext(AuthContext);

  // å…è®¸åœ¨Providerå¤–ä½¿ç”¨ï¼ˆè¿”å›nullï¼‰
  return context;
}

function Header() {
  const auth = useOptionalAuth();

  // ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä½†è¿”å›null
  return (
    <header>
      {auth ? (
        <UserMenu user={auth.user} />
      ) : (
        <LoginButton />
      )}
    </header>
  );
}
```

</CodeBlock>

### 2.1 useContext vs Consumerå¯¹æ¯”

<CodeBlock>

```jsx
// ä½¿ç”¨Consumerï¼ˆClassç»„ä»¶å’Œæ—©æœŸFunctionç»„ä»¶ï¼‰
function WithConsumer() {
  return (
    <MyContext.Consumer>
      {value => <div>{value}</div>}
    </MyContext.Consumer>
  );
}

// ä½¿ç”¨useContextï¼ˆæ¨èï¼‰
function WithHook() {
  const value = useContext(MyContext);
  return <div>{value}</div>;
}

// å¯¹æ¯”ä¼˜åŠ¿
// âœ… useContextæ›´ç®€æ´
// âœ… useContextä¸éœ€è¦åµŒå¥—
// âœ… useContextæ›´å®¹æ˜“æµ‹è¯•
// âœ… useContextå¯ä»¥æ·»åŠ é€»è¾‘
// âŒ useContextå¿…é¡»åœ¨Functionç»„ä»¶å†…ä½¿ç”¨
// âŒ useContextä¸èƒ½ç”¨äºç±»ç»„ä»¶

// ç±»ç»„ä»¶ä»éœ€ä½¿ç”¨Consumer
class ClassComponent extends React.Component {
  render() {
    return (
      <MyContext.Consumer>
        {value => <div>{value}</div>}
      </MyContext.Consumer>
    );
  }
}
```

</CodeBlock>

### 2.2 é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

<CodeBlock>

```jsx
// é—®é¢˜ï¼šæ¯æ¬¡Contextå€¼å˜åŒ–ï¼Œæ‰€æœ‰Consumeréƒ½é‡æ–°æ¸²æŸ“
function BadExample() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('John');

  return (
    <Context.Provider value={{ count, name }}>
      <ComponentA />  // å³ä½¿åªéœ€è¦countï¼Œä»ä¼šå› nameå˜åŒ–è€Œé‡æ¸²æŸ“
      <ComponentB />  // å³ä½¿åªéœ€è¦nameï¼Œä»ä¼šå› countå˜åŒ–è€Œé‡æ¸²æŸ“
    </Context.Provider>
  );
}

// è§£å†³æ–¹æ¡ˆ1ï¼šæ‹†åˆ†Context
function GoodExample() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('John');

  return (
    <CountContext.Provider value={count}>
      <NameContext.Provider value={name}>
        <ComponentA />
        <ComponentB />
      </NameContext.Provider>
    </CountContext.Provider>
  );
}

// è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨useMemoä¼˜åŒ–å€¼
function OptimizedExample() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('John');

  // åªæœ‰countå˜åŒ–æ—¶é‡æ–°è®¡ç®—
  const countValue = useMemo(() => ({ count }), [count]);

  return (
    <Context.Provider value={countValue}>
      <ComponentA />
    </Context.Provider>
  );
}

// è§£å†³æ–¹æ¡ˆ3ï¼šçŠ¶æ€æå‡åˆ°éœ€è¦çš„åœ°æ–¹
function BestExample() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <ComponentA count={count} />  {/* ç›´æ¥ä¼ é€’éœ€è¦çš„props */}
      <ComponentB onIncrement={() => setCount(c => c + 1)} />
    </div>
  );
}
```

</CodeBlock>

---

## 3. Contexté«˜çº§æ¨¡å¼

### 3.1 å¤åˆProviderï¼ˆProvider Compositionï¼‰

<CodeBlock>

```jsx
// æ¨¡å¼1ï¼šåµŒå¥—Provider
function App() {
  return (
    <AuthProvider>
      <ThemeProvider>
        <LanguageProvider>
          <AppContent />
        </LanguageProvider>
      </ThemeProvider>
    </AuthProvider>
  );
}

// æ¨¡å¼2ï¼šç»„åˆProvider
function AppProviders({ children }) {
  return (
    <AuthProvider>
      <ThemeProvider>
        <LanguageProvider>
          {children}
        </LanguageProvider>
      </ThemeProvider>
    </AuthProvider>
  );
}

// æ¨¡å¼3ï¼šè‡ªå®šä¹‰ç»„åˆProvider
function App() {
  return (
    <CombinedProvider
      providers={[
        [AuthProvider, {}],
        [ThemeProvider, {}],
        [LanguageProvider, {}]
      ]}
    >
      <AppContent />
    </CombinedProvider>
  );
}

// å®é™…æ¡ˆä¾‹ï¼šç”µå•†åº”ç”¨
function App() {
  return (
    <AuthProvider>
      <CartProvider>
        <UIProvider>
          <Router>
            <AppRoutes />
          </Router>
        </UIProvider>
      </CartProvider>
    </AuthProvider>
  );
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å¤šä¸ªContext
function ProductPage({ productId }) {
  const { user } = useAuth();           // è®¤è¯çŠ¶æ€
  const { items, addItem } = useCart(); // è´­ç‰©è½¦
  const { theme } = useTheme();         // ä¸»é¢˜

  return (
    <div className={theme}>
      <h1>{product.name}</h1>
      {user && (
        <button onClick={() => addItem(product)}>
          Add to Cart
        </button>
      )}
    </div>
  );
}
```

</CodeBlock>

### 3.2 å±€éƒ¨Context

<CodeBlock>

```jsx
// å±€éƒ¨Contextç”¨äºç»„ä»¶å†…éƒ¨çŠ¶æ€å…±äº«
function Dropdown({ options, value, onChange }) {
  const [isOpen, setIsOpen] = useState(false);
  const [highlightedIndex, setHighlightedIndex] = useState(-1);

  // å±€éƒ¨Context
  const contextValue = {
    isOpen,
    setIsOpen,
    highlightedIndex,
    setHighlightedIndex,
    value,
    onChange,
    options
  };

  return (
    <DropdownContext.Provider value={contextValue}>
      <div className="dropdown">
        <DropdownTrigger />
        <DropdownMenu />
      </div>
    </DropdownContext.Provider>
  );
}

function DropdownTrigger() {
  const { isOpen, setIsOpen, value } = useDropdown();

  return (
    <button onClick={() => setIsOpen(!isOpen)}>
      {value || 'Select...'}
    </button>
  );
}

function DropdownMenu() {
  const { isOpen, options } = useDropdown();

  if (!isOpen) return null;

  return (
    <ul>
      {options.map(option => (
        <DropdownItem key={option.value} option={option} />
      ))}
    </ul>
  );
}

// è‡ªå®šä¹‰Hook
function useDropdown() {
  const context = useContext(DropdownContext);

  if (!context) {
    throw new Error('useDropdown must be used within Dropdown');
  }

  return context;
}
```

</CodeBlock>

### 3.3 Contexté€‰æ‹©å™¨

<CodeBlock>

```jsx
// é—®é¢˜ï¼šContextå˜åŒ–å¯¼è‡´æ‰€æœ‰Consumeré‡æ¸²æŸ“
function BadConsumer() {
  const { user, theme, language } = useContext(MyContext);

  // åªä½¿ç”¨userï¼Œä½†themeå’Œlanguageå˜åŒ–ä¹Ÿä¼šå¯¼è‡´é‡æ¸²æŸ“
  return <div>User: {user.name}</div>;
}

// è§£å†³æ–¹æ¡ˆï¼šé€‰æ‹©å™¨Hook
function useContextSelector(context, selector) {
  const value = useContext(context);

  // ä½¿ç”¨useMemoç¼“å­˜é€‰æ‹©çš„ç»“æœ
  const selectedValue = useMemo(
    () => selector(value),
    [value, selector]
  );

  return selectedValue;
}

// ä½¿ç”¨
function GoodConsumer() {
  // åªè®¢é˜…useréƒ¨åˆ†
  const user = useContextSelector(MyContext, value => value.user);

  // themeå’Œlanguageå˜åŒ–ä¸ä¼šå¯¼è‡´é‡æ¸²æŸ“
  return <div>User: {user.name}</div>;
}

// ç®€åŒ–çš„é€‰æ‹©å™¨å®ç°
function createContextSelector(context) {
  return function useSelector(selector) {
    const value = useContext(context);
    const selected = useMemo(() => selector(value), [value, selector]);
    return selected;
  };
}

const UserContext = createContext();
const useUserSelector = createContextSelector(UserContext);

function Component() {
  const user = useUserSelector(value => value.user);
  const theme = useUserSelector(value => value.theme);

  return <div>{user.name}</div>;
}
```

</CodeBlock>

---

## 4. Contextæ€§èƒ½ä¼˜åŒ–

### 4.1 å€¼ä¼˜åŒ–

<CodeBlock>

```jsx
// é—®é¢˜ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å¯¹è±¡
function BadProvider() {
  const [count, setCount] = useState(0);

  return (
    <Context.Provider value={{
      count,
      increment: () => setCount(c => c + 1)
    }}>
      <Child />
    </Context.Provider>
  );

  // é—®é¢˜ï¼švalueå¯¹è±¡æ¯æ¬¡æ¸²æŸ“éƒ½ä¸åŒ
  // å³ä½¿countæ²¡å˜åŒ–ï¼Œincrementå‡½æ•°ä¹Ÿæ¯æ¬¡éƒ½é‡æ–°åˆ›å»º
}

// è§£å†³æ–¹æ¡ˆ1ï¼šæ‹†åˆ†Context
function SplitContextProvider() {
  const [count, setCount] = useState(0);

  return (
    <CountContext.Provider value={count}>
      <ActionsContext.Provider value={() => setCount(c => c + 1)}>
        <Child />
      </ActionsContext.Provider>
    </CountContext.Provider>
  );
}

// è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨useCallback
function OptimizedProvider() {
  const [count, setCount] = useState(0);

  const increment = useCallback(() => {
    setCount(c => c + 1);
  }, []);

  const value = useMemo(() => ({
    count,
    increment
  }), [count, increment]);

  return (
    <Context.Provider value={value}>
      <Child />
    </Context.Provider>
  );
}

// è§£å†³æ–¹æ¡ˆ3ï¼šä½¿ç”¨useRefç¼“å­˜å€¼
function CachedProvider() {
  const [count, setCount] = useState(0);
  const valueRef = useRef({ count, increment: () => {} });

  // æ›´æ–°ç¼“å­˜
  valueRef.current.count = count;
  valueRef.current.increment = useCallback(() => {
    setCount(c => c + 1);
  }, []);

  return (
    <Context.Provider value={valueRef.current}>
      <Child />
    </Context.Provider>
  );
}
```

</CodeBlock>

### 4.2 æ¶ˆè´¹è€…ä¼˜åŒ–

<CodeBlock>

```jsx
// ä½¿ç”¨React.memoé˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“
const MyConsumer = React.memo(function MyConsumer({ value }) {
  console.log('Consumer rendered');
  return <div>{value}</div>;
});

// ä½¿ç”¨useMemoåœ¨Consumerå†…ç¼“å­˜è®¡ç®—
function OptimizedConsumer() {
  const { data } = useContext(MyContext);

  // åªåœ¨dataå˜åŒ–æ—¶é‡æ–°è®¡ç®—
  const processedData = useMemo(() => {
    return data.map(item => ({
      ...item,
      processed: true
    }));
  }, [data]);

  return <List items={processedData} />;
}

// ä½¿ç”¨useCallbackä¼˜åŒ–äº‹ä»¶å¤„ç†
function EventHandlerConsumer() {
  const { onItemClick } = useContext(MyContext);

  const handleClick = useCallback((id) => {
    onItemClick(id);
  }, [onItemClick]);

  return (
    <List onItemClick={handleClick} />
  );
}

// ä½¿ç”¨useRefé¿å…é‡æ–°è®¢é˜…
function StableConsumer() {
  const [, forceUpdate] = useReducer(x => x + 1, 0);
  const contextValue = useContext(MyContext);
  const prevValueRef = useRef();

  // æ‰‹åŠ¨æ£€æŸ¥å˜åŒ–
  if (prevValueRef.current !== contextValue) {
    prevValueRef.current = contextValue;
    forceUpdate();
  }

  return <div>Value: {contextValue.data}</div>;
}
```

</CodeBlock>

### 4.3 åŠ¨æ€Provider

<CodeBlock>

```jsx
// åŠ¨æ€åˆ›å»ºå’Œé”€æ¯Context
function createDynamicContext(defaultValue) {
  const Context = createContext(defaultValue);

  function Provider({ children, value }) {
    const prevValueRef = useRef(defaultValue);

    // åŠ¨æ€æ›´æ–°å€¼
    useEffect(() => {
      prevValueRef.current = value;
    }, [value]);

    return (
      <Context.Provider value={value}>
        {children}
      </Context.Provider>
    );
  }

  return { Provider, Context };
}

// æ¡ä»¶æ€§Provider
function ConditionalProvider({ condition, children }) {
  if (!condition) {
    return children;  // ä¸åŒ…è£¹Provider
  }

  return (
    <MyContext.Provider value={getValue()}>
      {children}
    </MyContext.Provider>
  );
}

// æ‡’åŠ è½½Provider
function LazyProvider({ children }) {
  const [Provider, setProvider] = useState(null);

  useEffect(() => {
    // åŠ¨æ€å¯¼å…¥
    import('./MyContext').then(module => {
      setProvider(() => module.Provider);
    });
  }, []);

  if (!Provider) {
    return <Loading />;
  }

  return <Provider>{children}</Provider>;
}
```

</CodeBlock>

---

## 5. Contextå®é™…åº”ç”¨æ¨¡å¼

### 5.1 ä¸»é¢˜ç³»ç»Ÿ

<CodeBlock>

```jsx
// ä¸»é¢˜Context
const ThemeContext = createContext();

function ThemeProvider({ children, initialTheme = 'light' }) {
  const [theme, setTheme] = useState(() => {
    // ä»localStorageè¯»å–
    return localStorage.getItem('theme') || initialTheme;
  });

  useEffect(() => {
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('theme', theme);

    // åº”ç”¨åˆ°DOM
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  const toggleTheme = useCallback(() => {
    setTheme(prev => prev === 'light' ? 'dark' : 'light');
  }, []);

  const value = useMemo(() => ({
    theme,
    setTheme,
    toggleTheme,
    isDark: theme === 'dark'
  }), [theme, toggleTheme]);

  return (
    <ThemeContext.Provider value={value}>
      {children}
    </ThemeContext.Provider>
  );
}

// è‡ªå®šä¹‰Hook
function useTheme() {
  const context = useContext(ThemeContext);

  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider');
  }

  return context;
}

// ä½¿ç”¨ä¸»é¢˜
function ThemedButton({ children, variant = 'primary', ...props }) {
  const { theme, isDark } = useTheme();

  const baseStyles = {
    padding: '8px 16px',
    borderRadius: '4px',
    border: 'none',
    cursor: 'pointer',
    fontSize: '14px',
    fontWeight: '500'
  };

  const variantStyles = {
    primary: {
      backgroundColor: isDark ? '#4a9eff' : '#0066cc',
      color: 'white'
    },
    secondary: {
      backgroundColor: isDark ? '#444' : '#e0e0e0',
      color: isDark ? '#fff' : '#000'
    }
  };

  return (
    <button
      style={{
        ...baseStyles,
        ...variantStyles[variant]
      }}
      {...props}
    >
      {children}
    </button>
  );
}

// å…¨å±€ä¸»é¢˜ç»„ä»¶
function App() {
  return (
    <ThemeProvider>
      <div className="app">
        <h1>Theme Example</h1>
        <ThemedButton>Primary Button</ThemedButton>
        <ThemedButton variant="secondary">Secondary Button</ThemedButton>
        <ThemeToggle />
      </div>
    </ThemeProvider>
  );
}
```

</CodeBlock>

### 5.2 è®¤è¯ç³»ç»Ÿ

<CodeBlock>

```jsx
// è®¤è¯Context
const AuthContext = createContext();

function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„token
  useEffect(() => {
    const token = localStorage.getItem('token');

    if (token) {
      // éªŒè¯token
      verifyToken(token)
        .then(userData => {
          setUser(userData);
        })
        .catch(() => {
          localStorage.removeItem('token');
        })
        .finally(() => {
          setLoading(false);
        });
    } else {
      setLoading(false);
    }
  }, []);

  const login = useCallback(async (credentials) => {
    setLoading(true);
    setError(null);

    try {
      const { token, user } = await api.login(credentials);
      localStorage.setItem('token', token);
      setUser(user);
      return user;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  const logout = useCallback(() => {
    localStorage.removeItem('token');
    setUser(null);
  }, []);

  const register = useCallback(async (userData) => {
    setLoading(true);
    setError(null);

    try {
      const { token, user } = await api.register(userData);
      localStorage.setItem('token', token);
      setUser(user);
      return user;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  }, []);

  const value = useMemo(() => ({
    user,
    loading,
    error,
    login,
    logout,
    register,
    isAuthenticated: !!user
  }), [user, loading, error, login, logout, register]);

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

// è‡ªå®šä¹‰Hook
function useAuth() {
  const context = useContext(AuthContext);

  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }

  return context;
}

// å—ä¿æŠ¤çš„è·¯ç”±ç»„ä»¶
function ProtectedRoute({ children }) {
  const { isAuthenticated, loading } = useAuth();

  if (loading) {
    return <LoadingSpinner />;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" />;
  }

  return children;
}

// éœ€è¦ç‰¹å®šæƒé™çš„ç»„ä»¶
function RequirePermission({ permission, children }) {
  const { user } = useAuth();

  if (!user?.permissions?.includes(permission)) {
    return <NoAccessPage />;
  }

  return children;
}
```

</CodeBlock>

### 5.3 å›½é™…åŒ–ï¼ˆi18nï¼‰

<CodeBlock>

```jsx
// å›½é™…åŒ–Context
const LanguageContext = createContext();

function LanguageProvider({ children, defaultLanguage = 'en' }) {
  const [language, setLanguage] = useState(() => {
    return localStorage.getItem('language') || defaultLanguage;
  });

  const [translations, setTranslations] = useState({});

  useEffect(() => {
    localStorage.setItem('language', language);
    loadTranslations(language).then(setTranslations);
  }, [language]);

  const t = useCallback((key, params = {}) => {
    let text = translations[key] || key;

    // æ›¿æ¢å‚æ•°
    Object.keys(params).forEach(param => {
      text = text.replace(`{{${param}}}`, params[param]);
    });

    return text;
  }, [translations]);

  const changeLanguage = useCallback((lang) => {
    setLanguage(lang);
  }, []);

  const value = useMemo(() => ({
    language,
    t,
    changeLanguage,
    isRTL: ['ar', 'he', 'fa'].includes(language)
  }), [language, t, changeLanguage]);

  return (
    <LanguageContext.Provider value={value}>
      {children}
    </LanguageContext.Provider>
  );
}

// è‡ªå®šä¹‰Hook
function useTranslation() {
  const context = useContext(LanguageContext);

  if (!context) {
    throw new Error('useTranslation must be used within LanguageProvider');
  }

  return context;
}

// ç¿»è¯‘ç»„ä»¶
function T({ children, params }) {
  const { t } = useTranslation();

  if (typeof children === 'string') {
    return <>{t(children, params)}</>;
  }

  return children;
}

// ä½¿ç”¨ç¤ºä¾‹
function WelcomeMessage({ name }) {
  const { changeLanguage } = useTranslation();

  return (
    <div>
      <T>welcome</T>
      <T params={{ name }}>hello {{name}}</T>
      <select onChange={(e) => changeLanguage(e.target.value)}>
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡</option>
        <option value="es">EspaÃ±ol</option>
      </select>
    </div>
  );
}
```

</CodeBlock>

---

## 6. Context vs Redux

### 6.1 ä½•æ—¶ä½¿ç”¨Contextï¼Œä½•æ—¶ä½¿ç”¨Redux

<Compare>

```jsx
// ä½¿ç”¨Contextçš„åœºæ™¯
// âœ… ç®€å•çš„å…¨å±€çŠ¶æ€ï¼ˆä¸»é¢˜ã€è®¤è¯ã€å›½é™…åŒ–ï¼‰
// âœ… çŠ¶æ€ä¸é¢‘ç¹å˜åŒ–
// âœ… ç»„ä»¶å±‚çº§è¾ƒæµ…
// âœ… ä¸éœ€è¦å¤æ‚çš„çŠ¶æ€é€»è¾‘
// âœ… ä¸éœ€è¦ä¸­é—´ä»¶

// ä½¿ç”¨Reduxçš„åœºæ™¯
// âŒ å¤æ‚çš„çŠ¶æ€ç®¡ç†
// âŒ éœ€è¦æ—¶é—´æ—…è¡Œè°ƒè¯•
// âŒ éœ€è¦ä¸­é—´ä»¶å¤„ç†å‰¯ä½œç”¨
// âŒ éœ€è¦æŒä¹…åŒ–çŠ¶æ€
// âŒ éœ€è¦å¤æ‚çš„çŠ¶æ€åˆ†ç‰‡å’Œé€‰æ‹©å™¨
// âŒ å¤§å‹å›¢é˜Ÿåä½œå¼€å‘

// å†³ç­–æŒ‡å—
function chooseStateSolution(requirements) {
  const {
    teamSize,
    complexity,
    needMiddleware,
    needDevTools,
    needTimeTravel
  } = requirements;

  if (complexity === 'low' && teamSize <= 3) {
    return 'Context API';
  }

  if (needTimeTravel || needDevTools) {
    return 'Redux Toolkit';
  }

  if (needMiddleware) {
    return 'Zustand or Redux Toolkit';
  }

  return 'Context API';
}
```

</Compare>

### 6.2 Contextæ›¿ä»£Reduxçš„æ–¹æ¡ˆ

<CodeBlock>

```jsx
// ä½¿ç”¨Context + useReduceræ›¿ä»£Redux
// ç±»ä¼¼Reduxçš„çŠ¶æ€ç®¡ç†
const StateContext = createContext();
const DispatchContext = createContext();

function createStore(reducer, initialState) {
  const [state, dispatch] = useReducer(reducer, initialState);

  const store = useMemo(() => ({ state, dispatch }), [state, dispatch]);

  return store;
}

function Provider({ children, reducer, initialState }) {
  const [state, dispatch] = useReducer(reducer, initialState);

  return (
    <StateContext.Provider value={state}>
      <DispatchContext.Provider value={dispatch}>
        {children}
      </DispatchContext.Provider>
    </StateContext.Provider>
  );
}

function useSelector(selector) {
  const state = useContext(StateContext);
  return selector(state);
}

function useDispatch() {
  const dispatch = useContext(DispatchContext);
  return dispatch;
}

// ä½¿ç”¨
function App() {
  return (
    <Provider reducer={rootReducer} initialState={initialState}>
      <ComponentA />
      <ComponentB />
    </Provider>
  );
}

function ComponentA() {
  const value = useSelector(state => state.value);
  const dispatch = useDispatch();

  return (
    <button onClick={() => dispatch({ type: 'INCREMENT' })}>
      {value}
    </button>
  );
}
```

</CodeBlock>

---

## 7. Contextæœ€ä½³å®è·µ

### 7.1 è®¾è®¡åŸåˆ™

<CodeBlock>

```jsx
// âœ… å¥½çš„Contextè®¾è®¡

// 1. å•ä¸€èŒè´£
// æ¯ä¸ªContextåªè´Ÿè´£ä¸€ç§ç±»å‹çš„å…¨å±€çŠ¶æ€
const UserContext = createContext();     // åªç®¡ç†ç”¨æˆ·çŠ¶æ€
const ThemeContext = createContext();    // åªç®¡ç†ä¸»é¢˜
const CartContext = createContext();     // åªç®¡ç†è´­ç‰©è½¦

// 2. æä¾›æœ‰æ„ä¹‰çš„é»˜è®¤å€¼
const ConfigContext = createContext({
  apiUrl: 'https://api.example.com',
  timeout: 5000,
  retries: 3
});

// 3. ä½¿ç”¨è‡ªå®šä¹‰Hook
function useConfig() {
  const context = useContext(ConfigContext);

  if (!context) {
    throw new Error('useConfig must be used within ConfigProvider');
  }

  return context;
}

// 4. å°è£…ä¸šåŠ¡é€»è¾‘
function useAuth() {
  const context = useContext(AuthContext);

  return {
    ...context,
    login: async (credentials) => {
      // å°è£…ç™»å½•é€»è¾‘
      const user = await context.login(credentials);
      return user;
    },
    logout: () => {
      // å°è£…ç™»å‡ºé€»è¾‘
      context.logout();
      router.push('/login');
    }
  };
}

// 5. æ€§èƒ½ä¼˜åŒ–
function OptimizedProvider() {
  const [state, setState] = useState(initialState);

  const dispatch = useCallback((action) => {
    setState(prev => reducer(prev, action));
  }, []);

  const value = useMemo(() => ({
    state,
    dispatch
  }), [state, dispatch]);

  return (
    <Context.Provider value={value}>
      {children}
    </Context.Provider>
  );
}

// âŒ é¿å…çš„åæ¨¡å¼

// 1. è¿‡åº¦ä½¿ç”¨å…¨å±€çŠ¶æ€
function BadContext() {
  const [everything, setEverything] = useState({
    // å°†æ‰€æœ‰çŠ¶æ€éƒ½æ”¾åœ¨å…¨å±€Contextä¸­
    user: null,
    theme: 'light',
    sidebar: true,
    notifications: [],
    // ... 100ä¸ªå­—æ®µ
  });

  // é—®é¢˜ï¼šä»»ä½•å­—æ®µå˜åŒ–éƒ½ä¼šå¯¼è‡´æ‰€æœ‰Consumeré‡æ¸²æŸ“
  return (
    <Context.Provider value={everything}>
      {children}
    </Context.Provider>
  );
}

// 2. ç¼ºå°‘é”™è¯¯å¤„ç†
function UnsafeContext() {
  const value = useContext(MyContext);

  // å¦‚æœæ²¡æœ‰Providerä¼šå´©æºƒ
  return <div>{value.unsafeProperty}</div>;
}

// 3. åœ¨Providerä¸­è°ƒç”¨useContext
function WrongProvider() {
  const otherContext = useContext(OtherContext);

  // ä¸è¦åœ¨Providerä¸­æ¶ˆè´¹å…¶ä»–Context
  return (
    <MyContext.Provider value={otherContext}>
      {children}
    </MyContext.Provider>
  );
}
```

</CodeBlock>

### 7.2 æµ‹è¯•ç­–ç•¥

<CodeBlock>

```jsx
// æµ‹è¯•Context

// 1. æµ‹è¯•Provider
test('AuthProvider sets user on login', async () => {
  const TestComponent = () => {
    const { user, login } = useAuth();
    return <div>{user?.name}</div>;
  };

  render(
    <AuthProvider>
      <TestComponent />
    </AuthProvider>
  );

  // æ¨¡æ‹Ÿç™»å½•
  fireEvent.click(screen.getByText('Login'));

  await waitFor(() => {
    expect(screen.getByText('John Doe')).toBeInTheDocument();
  });
});

// 2. æµ‹è¯•æ¶ˆè´¹è€…
test('useAuth throws error outside provider', () => {
  const TestComponent = () => {
    useAuth();
    return <div>Test</div>;
  };

  expect(() => {
    render(<TestComponent />);
  }).toThrow('useAuth must be used within AuthProvider');
});

// 3. æµ‹è¯•è‡ªå®šä¹‰Hook
test('useTheme returns correct values', () => {
  const wrapper = ({ children }) => (
    <ThemeProvider initialTheme="dark">
      {children}
    </ThemeProvider>
  );

  const { result } = renderHook(() => useTheme(), { wrapper });

  expect(result.current.theme).toBe('dark');
  expect(result.current.isDark).toBe(true);
  expect(typeof result.current.toggleTheme).toBe('function');
});

// 4. æµ‹è¯•æ€§èƒ½
test('Consumer does not re-render when unrelated data changes', () => {
  const TestConsumer = () => {
    const { value } = useContextSelector(MyContext, ctx => ctx.value);
    return <div>{value}</div>;
  };

  const { rerender } = render(
    <MyContext.Provider value={{ value: 1, other: 'data' }}>
      <TestConsumer />
    </MyContext.Provider>
  );

  // æ”¹å˜otherä¸åº”è¯¥å¯¼è‡´é‡æ¸²æŸ“
  const spy = jest.spyOn(TestConsumer.prototype, 'render');

  rerender(
    <MyContext.Provider value={{ value: 1, other: 'changed' }}>
      <TestConsumer />
    </MyContext.Provider>
  );

  expect(spy).not.toHaveBeenCalled();
});
```

</CodeBlock>

---

## 8. Contextå¸¸è§é™·é˜±

### é™·é˜±1ï¼šå¿˜è®°ä½¿ç”¨useCallbackå’ŒuseMemo

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°
function BadProvider() {
  const [count, setCount] = useState(0);

  return (
    <Context.Provider value={{
      count,
      increment: () => setCount(c => c + 1)  // æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°å‡½æ•°
    }}>
      <Child />
    </Context.Provider>
  );
}

// âœ… æ­£ç¡® - ä½¿ç”¨useCallback
function GoodProvider() {
  const [count, setCount] = useState(0);

  const increment = useCallback(() => {
    setCount(c => c + 1);
  }, []);

  const value = useMemo(() => ({
    count,
    increment
  }), [count, increment]);

  return (
    <Context.Provider value={value}>
      <Child />
    </Context.Provider>
  );
}
```

</ErrorBox>

### é™·é˜±2ï¼šåœ¨å¾ªç¯ä¸­åˆ›å»ºContext

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - åœ¨å¾ªç¯ä¸­åˆ›å»ºContext
function BadComponent() {
  const items = [1, 2, 3];

  return (
    <div>
      {items.map((item, index) => {
        const ItemContext = createContext();  // âŒ æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°Context
        return (
          <ItemContext.Provider value={item}>
            <Item />
          </ItemContext.Provider>
        );
      })}
    </div>
  );
}

// âœ… æ­£ç¡® - åœ¨ç»„ä»¶å¤–åˆ›å»ºContext
const ItemContext = createContext();

function GoodComponent() {
  const items = [1, 2, 3];

  return (
    <div>
      {items.map(item => (
        <ItemContext.Provider key={item} value={item}>
          <Item />
        </ItemContext.Provider>
      ))}
    </div>
  );
}
```

</ErrorBox>

### é™·é˜±3ï¼šContextå˜åŒ–è§¦å‘è¿‡å¤šé‡æ¸²æŸ“

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - å¤šä¸ªçŠ¶æ€æ”¾åœ¨ä¸€ä¸ªContextä¸­
function BadProvider() {
  const [user, setUser] = useState(null);
  const [theme, setTheme] = useState('light');
  const [language, setLanguage] = useState('en');
  const [notifications, setNotifications] = useState([]);

  return (
    <Context.Provider value={{
      user,
      theme,
      language,
      notifications,
      setUser,
      setTheme,
      setLanguage,
      setNotifications
    }}>
      <App />
    </Context.Provider>
  );

  // é—®é¢˜ï¼šä»»ä½•çŠ¶æ€å˜åŒ–éƒ½å¯¼è‡´æ‰€æœ‰Consumeré‡æ¸²æŸ“
}

// âœ… æ­£ç¡® - æ‹†åˆ†Context
function GoodProvider() {
  return (
    <UserProvider>
      <ThemeProvider>
        <LanguageProvider>
          <NotificationProvider>
            <App />
          </NotificationProvider>
        </LanguageProvider>
      </ThemeProvider>
    </UserProvider>
  );
}
```

</ErrorBox>

### é™·é˜±4ï¼šå¿˜è®°æ·»åŠ ä¾èµ–æ•°ç»„

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç¼ºå°‘ä¾èµ–
function BadProvider({ initialValue }) {
  const [value, setValue] = useState(initialValue);

  useEffect(() => {
    // ä½¿ç”¨äº†initialValueä½†æ²¡æœ‰æ·»åŠ åˆ°ä¾èµ–æ•°ç»„
    localStorage.setItem('value', value);
  }, [value]);  // âŒ ç¼ºå°‘initialValueä¾èµ–
}

// âœ… æ­£ç¡® - æ·»åŠ æ‰€æœ‰ä¾èµ–
function GoodProvider({ initialValue }) {
  const [value, setValue] = useState(initialValue);

  useEffect(() => {
    localStorage.setItem('value', value);
  }, [value, initialValue]);  // âœ… åŒ…å«æ‰€æœ‰ä¾èµ–
}
```

</ErrorBox>

---

## 9. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šå®ç°å…¨å±€é…ç½®ç®¡ç†

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- ç®¡ç†åº”ç”¨çš„å…¨å±€é…ç½®ï¼ˆAPI URLã€è¶…æ—¶è®¾ç½®ã€é‡è¯•æ¬¡æ•°ç­‰ï¼‰
- æ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨åˆ‡æ¢
- é…ç½®å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°

**å®ç°è¦æ±‚**ï¼š
```javascript
const ConfigContext = createContext();

function ConfigProvider({ children }) {
  // ç¯å¢ƒé…ç½®
  const config = {
    apiUrl: process.env.NODE_ENV === 'production'
      ? 'https://api.production.com'
      : 'https://api.dev.com',
    timeout: 5000,
    retries: 3,
    enableLogging: process.env.NODE_ENV === 'development'
  };

  return (
    <ConfigContext.Provider value={config}>
      {children}
    </ConfigContext.Provider>
  );
}

function useConfig() {
  // å®ç°è‡ªå®šä¹‰Hook
}

// ä½¿ç”¨ç¤ºä¾‹
function ApiClient() {
  const config = useConfig();

  const request = useCallback(async (url) => {
    // ä½¿ç”¨configè¿›è¡ŒAPIè°ƒç”¨
  }, [config]);

  return request;
}
```

**æç¤º**ï¼š
- ä½¿ç”¨ç¯å¢ƒå˜é‡
- ç¼“å­˜é…ç½®å€¼
- æä¾›é»˜è®¤å€¼

</Expandable>

### ç»ƒä¹ 2ï¼šå®ç°å¤æ‚è¡¨å•çŠ¶æ€ç®¡ç†

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å¤šæ­¥éª¤è¡¨å•Wizard
- è¡¨å•éªŒè¯
- è‡ªåŠ¨ä¿å­˜è‰ç¨¿
- æ­¥éª¤é—´çŠ¶æ€å…±äº«

**å®ç°è¦æ±‚**ï¼š
```javascript
const FormContext = createContext();

function FormWizard({ initialData, onSubmit }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [formData, setFormData] = useState(initialData);
  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  const nextStep = () => setCurrentStep(prev => prev + 1);
  const prevStep = () => setCurrentStep(prev => prev - 1);
  const updateField = (name, value) => {
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  // å®ç°é€»è¾‘...
}

// ä½¿ç”¨ç¤ºä¾‹
<FormWizard onSubmit={handleSubmit}>
  <FormStep1 />
  <FormStep2 />
  <FormStep3 />
</FormWizard>
```

**æç¤º**ï¼š
- ä½¿ç”¨useReducerç®¡ç†å¤æ‚çŠ¶æ€
- éªŒè¯é€»è¾‘
- è‡ªåŠ¨ä¿å­˜

</Expandable>

### ç»ƒä¹ 3ï¼šå®ç°å¯æ’¤é”€çš„æ“ä½œå†å²

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- è®°å½•æ“ä½œå†å²
- æ”¯æŒæ’¤é”€ï¼ˆUndoï¼‰å’Œé‡åšï¼ˆRedoï¼‰
- çŠ¶æ€å‹ç¼©ï¼ˆåˆå¹¶ç›¸é‚»æ“ä½œï¼‰

**å®ç°è¦æ±‚**ï¼š
```javascript
const HistoryContext = createContext();

function HistoryProvider({ children }) {
  const [past, setPast] = useState([]);
  const [present, setPresent] = useState(null);
  const [future, setFuture] = useState([]);

  const undo = () => {
    // æ’¤é”€æ“ä½œ
  };

  const redo = () => {
    // é‡åšæ“ä½œ
  };

  const addHistory = (action) => {
    // æ·»åŠ å†å²è®°å½•
  };

  return (
    <HistoryContext.Provider value={{
      present,
      past,
      future,
      undo,
      redo,
      addHistory
    }}>
      {children}
    </HistoryContext.Provider>
  );
}
```

**æç¤º**ï¼š
- ä½¿ç”¨useReducer
- å®ç°çŠ¶æ€å‹ç¼©
- å¤„ç†è¾¹ç•Œæƒ…å†µ

</Expandable>

### ç»ƒä¹ 4ï¼šå®ç°å…¨å±€åŠ è½½çŠ¶æ€ç®¡ç†

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- è¿½è¸ªå¤šä¸ªå¼‚æ­¥æ“ä½œ
- å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨
- åŠ è½½å®Œæˆé€šçŸ¥

**å®ç°è¦æ±‚**ï¼š
```javascript
const LoadingContext = createContext();

function LoadingProvider({ children }) {
  const [loadingCount, setLoadingCount] = useState(0);
  const [loadingOperations, setLoadingOperations] = useState(new Set());

  const startLoading = (operationId) => {
    setLoadingCount(prev => prev + 1);
    setLoadingOperations(prev => new Set([...prev, operationId]));
  };

  const stopLoading = (operationId) => {
    setLoadingCount(prev => Math.max(0, prev - 1));
    setLoadingOperations(prev => {
      const newSet = new Set(prev);
      newSet.delete(operationId);
      return newSet;
    });
  };

  return (
    <LoadingContext.Provider value={{
      isLoading: loadingCount > 0,
      loadingCount,
      loadingOperations,
      startLoading,
      stopLoading
    }}>
      {children}
    </LoadingContext.Provider>
  );
}
```

**æç¤º**ï¼š
- è®¡æ•°ç®¡ç†
- è¿½è¸ªç‰¹å®šæ“ä½œ
- æ¸…ç†æœºåˆ¶

</Expandable>

---

## 10. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… Context APIæ˜¯Reactå†…ç½®çš„çŠ¶æ€å…±äº«æ–¹æ¡ˆ
- âœ… Provideræä¾›æ•°æ®ï¼ŒConsumeræ¶ˆè´¹æ•°æ®
- âœ… useContextç®€åŒ–äº†Contextçš„ä½¿ç”¨
- âœ… åˆç†æ‹†åˆ†Contexté¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- âœ… ä½¿ç”¨useCallbackå’ŒuseMemoä¼˜åŒ–æ€§èƒ½
- âœ… è‡ªå®šä¹‰Hookæä¾›æ›´å¥½çš„APIå’Œé”™è¯¯å¤„ç†
- âœ… å¤åˆProvideré€‚ç”¨äºå¤æ‚åº”ç”¨
- âœ… Contexté€‚ç”¨äºç®€å•åˆ°ä¸­ç­‰å¤æ‚åº¦çš„çŠ¶æ€ç®¡ç†
- âœ… é€‰æ‹©Context vs Reduxéœ€è¦æ ¹æ®éœ€æ±‚å†³å®š
- âœ… æ€§èƒ½ä¼˜åŒ–æ˜¯Contextçš„å…³é”®

</Checklist>

### Contextæœ€ä½³å®è·µ

<BestPractices>

1. **åˆç†æ‹†åˆ†** - ä¸è¦å°†æ‰€æœ‰çŠ¶æ€æ”¾åœ¨ä¸€ä¸ªContextä¸­
2. **æ€§èƒ½ä¼˜åŒ–** - ä½¿ç”¨useCallbackå’ŒuseMemo
3. **è‡ªå®šä¹‰Hook** - æä¾›æ›´å¥½çš„APIå’Œé”™è¯¯å¤„ç†
4. **é»˜è®¤å€¼** - æä¾›æœ‰æ„ä¹‰çš„é»˜è®¤å€¼
5. **æµ‹è¯•è¦†ç›–** - æµ‹è¯•Providerå’ŒConsumer
6. **æ–‡æ¡£æ¸…æ™°** - è®°å½•Contextçš„ç”¨é€”å’Œä½¿ç”¨æ–¹å¼
7. **é¿å…æ»¥ç”¨** - åªåœ¨éœ€è¦å…±äº«çŠ¶æ€æ—¶ä½¿ç”¨
8. **é€‰æ‹©åˆé€‚å·¥å…·** - Contextä¸æ˜¯é“¶å¼¹

</BestPractices>

### ä½•æ—¶ä½¿ç”¨Context

<BestPractices>

**æ¨èä½¿ç”¨**ï¼š
- ä¸»é¢˜ç³»ç»Ÿ
- ç”¨æˆ·è®¤è¯çŠ¶æ€
- å›½é™…åŒ–é…ç½®
- ç®€å•çš„å…¨å±€UIçŠ¶æ€
- ç»„ä»¶é—´éœ€è¦å…±äº«çš„ä½é¢‘æ•°æ®

**è€ƒè™‘å…¶ä»–æ–¹æ¡ˆ**ï¼š
- å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼ˆè€ƒè™‘Reduxï¼‰
- é«˜é¢‘æ•°æ®å˜åŒ–ï¼ˆè€ƒè™‘æœ¬åœ°çŠ¶æ€ï¼‰
- æ·±å±‚åµŒå¥—ç»„ä»¶ï¼ˆè€ƒè™‘propsä¼ é€’æˆ–é‡æ„ï¼‰
- éœ€è¦æ—¶é—´æ—…è¡Œè°ƒè¯•ï¼ˆè€ƒè™‘Redux DevToolsï¼‰

</BestPractices>

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æ·±å…¥æŒæ¡äº†Context APIï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š

1. **[ReduxåŸºç¡€](../intermediate/redux-fundamentals)** - å·¥ä¸šçº§çŠ¶æ€ç®¡ç†
2. **[Zustandè½»é‡æ–¹æ¡ˆ](../intermediate/zustand)** - ç°ä»£çŠ¶æ€ç®¡ç†
3. **[çŠ¶æ€æŒä¹…åŒ–](../basics/local-vs-global#7-çŠ¶æ€æŒä¹…åŒ–)** - æ·±å…¥æœ¬åœ°vså…¨å±€
4. **[æ€§èƒ½ä¼˜åŒ–åŸºç¡€](../basics/react-memo)** - ä¼˜åŒ–çŠ¶æ€æ›´æ–°

---

## 11. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [Context](https://react.dev/reference/react/Context) - Reactå®˜æ–¹æ–‡æ¡£
- [useContext](https://react.dev/reference/react/useContext) - useContextæŒ‡å—
- [API Context](https://react.dev/reference/react/createContext) - createContext API

### æ¨èé˜…è¯»

- [React Contextæ·±åº¦æŒ‡å—](https://kentcdodds.com/blog/) - é«˜çº§ä½¿ç”¨æŠ€å·§
- [Contextæ€§èƒ½ä¼˜åŒ–](https://kentcdodds.com/blog/) - æ€§èƒ½æœ€ä½³å®è·µ
- [Context vs Redux](https://blog.logrocket.com/) - çŠ¶æ€ç®¡ç†æ–¹æ¡ˆå¯¹æ¯”

### ç›¸å…³è¯é¢˜

- [æœ¬åœ°vså…¨å±€çŠ¶æ€](local-vs-global) - çŠ¶æ€èŒƒå›´å†³ç­–
- [useStateå’ŒuseReducer](../basics/state-lifecycle) - åŸºç¡€çŠ¶æ€ç®¡ç†
- [è‡ªå®šä¹‰Hooks](../hooks/advanced/custom-hooks) - é€»è¾‘å¤ç”¨

---

[â† ä¸Šä¸€ç« ï¼šæœ¬åœ° vs å…¨å±€çŠ¶æ€](local-vs-global) | [ä¸‹ä¸€ç« ï¼šReduxåŸºç¡€ â†’](../intermediate/redux-fundamentals)
