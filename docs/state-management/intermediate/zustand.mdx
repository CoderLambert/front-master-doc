# Zustandè½»é‡æ–¹æ¡ˆ - æç®€çŠ¶æ€ç®¡ç†

import { Tabs, TabItem } from '@docusaurus/theme-common';

Zustandæ˜¯Reactç”Ÿæ€ç³»ç»Ÿä¸­ä¸€ä¸ªè½»é‡çº§çš„çŠ¶æ€ç®¡ç†åº“ï¼Œä»¥å…¶ç®€æ´çš„APIã€é«˜æ•ˆçš„æ€§èƒ½å’Œæœ€å°çš„æ ·æ¿ä»£ç è€Œé—»åã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨Zustandçš„æ ¸å¿ƒæ¦‚å¿µã€ä½¿ç”¨æ¨¡å¼ã€æœ€ä½³å®è·µä»¥åŠå®é™…åº”ç”¨åœºæ™¯ã€‚

## æœ¬ç« å­¦ä¹ ç›®æ ‡

- ç†è§£Zustandçš„è®¾è®¡ç†å¿µå’Œæ ¸å¿ƒä¼˜åŠ¿
- æŒæ¡Zustandçš„åŸºç¡€ç”¨æ³•å’ŒAPI
- å­¦ä¼šä½¿ç”¨Zustandè¿›è¡ŒçŠ¶æ€ç®¡ç†
- ç†è§£Zustandçš„middlewareç³»ç»Ÿ
- æŒæ¡å¼‚æ­¥æ“ä½œåœ¨Zustandä¸­çš„å¤„ç†
- å­¦ä¼šä½¿ç”¨Zustandè¿›è¡Œæ€§èƒ½ä¼˜åŒ–
- æŒæ¡Zustandä¸Reactçš„é›†æˆ
- ç†è§£Zustandçš„æœ€ä½³å®è·µ
- æŒæ¡Zustandä¸å…¶ä»–çŠ¶æ€ç®¡ç†æ–¹æ¡ˆçš„å¯¹æ¯”
- å­¦ä¼šåœ¨å¤§å‹é¡¹ç›®ä¸­ä½¿ç”¨Zustand

---

## 1. Zustandæ˜¯ä»€ä¹ˆï¼Ÿ

Zustandæ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¯æ‰©å±•çš„çŠ¶æ€ç®¡ç†åº“ï¼Œä½¿ç”¨ç®€å•çš„APIè®¾è®¡ï¼Œè®©çŠ¶æ€ç®¡ç†å˜å¾—ç®€å•è€Œæœ‰è¶£ã€‚

<Box style={{ padding: '20px', background: '#e3f2fd', borderRadius: '8px', margin: '20px 0' }}>
  <h4 style={{ margin: 0, color: '#1976d2' }}>ğŸ’¡ æ ¸å¿ƒç†å¿µ</h4>
  <p style={{ margin: '10px 0 0 0' }}>
    <strong>æç®€ä¸»ä¹‰</strong> - æœ€å°‘çš„æ ·æ¿ä»£ç ï¼Œæœ€ç®€å•çš„API<br />
    <strong>é«˜æ€§èƒ½</strong> - è‡ªåŠ¨ä¼˜åŒ–çš„é€‰æ‹©å™¨ï¼Œåªé‡æ¸²æŸ“å¿…è¦çš„ç»„ä»¶<br />
    <strong>TypeScriptå‹å¥½</strong> - å®Œæ•´çš„ç±»å‹æ¨å¯¼æ”¯æŒ<br />
    <strong>å¯æ‰©å±•</strong> - å¼ºå¤§çš„middlewareç³»ç»Ÿ
  </p>
</Box>

<CodeBlock>

```jsx
// Zustandç¤ºä¾‹ - ç®€å•ä¸‰æ­¥
// 1. åˆ›å»ºstore
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
  decrement: () => set((state) => ({ count: state.count - 1 })),
}));

// 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function Counter() {
  const { count, increment, decrement } = useStore();

  return (
    <div>
      <h1>Count: {count}</h1>
      <button onClick={increment}>+</button>
      <button onClick={decrement}>-</button>
    </div>
  );
}

// 3. è®¢é˜…çŠ¶æ€å˜åŒ–
const count = useStore((state) => state.count);
```

</CodeBlock>

### 1.1 Zustandçš„æ ¸å¿ƒä¼˜åŠ¿

<Grid>

<div>
  <h4>ğŸš€ æ€§èƒ½</h4>
  <ul>
    <li>è‡ªåŠ¨ä¼˜åŒ–é€‰æ‹©å™¨</li>
    <li>æœ€å°åŒ–é‡æ¸²æŸ“</li>
    <li>æµ…æ¯”è¾ƒï¼ˆshallowï¼‰</li>
    <li>æ— æ·±å±‚è®¢é˜…</li>
  </ul>
</div>

<div>
  <h4>ğŸ“¦ ä½“ç§¯</h4>
  <ul>
    <li>æå°çš„Bundleä½“ç§¯</li>
    <li>é›¶ä¾èµ–</li>
    <li>Tree-shakingå‹å¥½</li>
    <li>~12kb minified</li>
  </ul>
</div>

<div>
  <h4>ğŸ¯ API</h4>
  <ul>
    <li>ç›´è§‚çš„APIè®¾è®¡</li>
    <li>å­¦ä¹ æ›²çº¿å¹³ç¼“</li>
    <li>æ— æ ·æ¿ä»£ç </li>
    <li>åŸç”Ÿæ”¯æŒTypeScript</li>
  </ul>
</div>

<div>
  <h4>ğŸ”§ å¯æ‰©å±•</h4>
  <ul>
    <li>å¼ºå¤§çš„middleware</li>
    <li>æŒä¹…åŒ–æ”¯æŒ</li>
    <li>Immeré›†æˆ</li>
    <li>Redux DevToolsæ”¯æŒ</li>
  </ul>
</div>

</Grid>

### 1.2 ä¸å…¶ä»–çŠ¶æ€ç®¡ç†æ–¹æ¡ˆå¯¹æ¯”

<CodeBlock>

```jsx
// å¯¹æ¯”ï¼šåˆ›å»ºstore

// âŒ Redux - æ ·æ¿ä»£ç å¤š
import { createStore } from 'redux';
const initialState = { count: 0 };
function reducer(state = initialState, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { count: state.count + 1 };
    default:
      return state;
  }
}
const store = createStore(reducer);

// âœ… Zustand - ç®€æ´ç›´æ¥
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));
```

</CodeBlock>

<CodeBlock>

```jsx
// å¯¹æ¯”ï¼šç»„ä»¶ä½¿ç”¨

// âŒ React-Redux - éœ€è¦Providerå’Œconnect
import { useSelector, useDispatch } from 'react-redux';
const count = useSelector((state) => state.count);
const dispatch = useDispatch();
dispatch(increment());

// âœ… Zustand - ç›´æ¥ä½¿ç”¨hook
const { count, increment } = useStore();
```

</CodeBlock>

<CodeBlock>

```jsx
// å¯¹æ¯”ï¼šæ€§èƒ½ä¼˜åŒ–

// âŒ React-Redux - éœ€è¦reselect
import { createSelector } from 'reselect';
const selectCount = createSelector(
  (state) => state,
  (state) => state.count
);
const count = useSelector(selectCount);

// âœ… Zustand - è‡ªåŠ¨ä¼˜åŒ–
const count = useStore((state) => state.count); // è‡ªåŠ¨æµ…æ¯”è¾ƒ
```

</CodeBlock>

---

## 2. å¿«é€Ÿå¼€å§‹

### 2.1 å®‰è£…Zustand

<CodeBlock>

```bash
# ä½¿ç”¨npm
npm install zustand

# ä½¿ç”¨yarn
yarn add zustand

# ä½¿ç”¨pnpm
pnpm add zustand
```

</CodeBlock>

### 2.2 åŸºç¡€ç”¨æ³•

<CodeBlock>

```jsx
// åŸºç¡€è®¡æ•°å™¨ç¤ºä¾‹
import { create } from 'zustand';

// 1. åˆ›å»ºstore
const useCounterStore = create((set) => ({
  count: 0,
  // åŒæ­¥æ“ä½œ
  increment: () => set((state) => ({ count: state.count + 1 })),
  decrement: () => set((state) => ({ count: state.count - 1 })),
  // é‡ç½®
  reset: () => set({ count: 0 }),
}));

// 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
function Counter() {
  const { count, increment, decrement, reset } = useCounterStore();

  return (
    <div>
      <h2>Count: {count}</h2>
      <button onClick={increment}>+</button>
      <button onClick={decrement}>-</button>
      <button onClick={reset}>Reset</button>
    </div>
  );
}
```

</CodeBlock>

### 2.3 æ›´å¤æ‚çš„çŠ¶æ€ç»“æ„

<CodeBlock>

```jsx
// å¤æ‚çŠ¶æ€ç¤ºä¾‹ - ç”¨æˆ·å’Œå¾…åŠäº‹é¡¹
const useUserStore = create((set) => ({
  // çŠ¶æ€
  user: null,
  todos: [],
  isLoading: false,
  error: null,

  // åŠ¨ä½œ
  setUser: (user) => set({ user }),
  addTodo: (todo) =>
    set((state) => ({
      todos: [...state.todos, { id: Date.now(), ...todo }],
    })),
  toggleTodo: (id) =>
    set((state) => ({
      todos: state.todos.map((t) =>
        t.id === id ? { ...t, completed: !t.completed } : t
      ),
    })),
  removeTodo: (id) =>
    set((state) => ({
      todos: state.todos.filter((t) => t.id !== id),
    })),

  // å¼‚æ­¥æ“ä½œ
  fetchUser: async (userId) => {
    set({ isLoading: true, error: null });
    try {
      const user = await api.getUser(userId);
      set({ user, isLoading: false });
    } catch (error) {
      set({ error: error.message, isLoading: false });
    }
  },
}));

// ä½¿ç”¨
function UserProfile() {
  const { user, fetchUser } = useUserStore();

  useEffect(() => {
    fetchUser(123);
  }, [fetchUser]);

  if (!user) return <div>Loading...</div>;

  return <div>Welcome, {user.name}!</div>;
}
```

</CodeBlock>

---

## 3. æ ¸å¿ƒæ¦‚å¿µæ·±å…¥

### 3.1 Storeçš„ç»“æ„

<CodeBlock>

```jsx
// Zustand storeç”±ä¸‰éƒ¨åˆ†ç»„æˆ
const useStore = create((set, get) => ({
  // 1. State - çŠ¶æ€
  // åŒ…å«åº”ç”¨ä¸­éœ€è¦å…±äº«çš„æ‰€æœ‰æ•°æ®
  state1: value1,
  state2: value2,
  nestedState: {
    field1: value1,
    field2: value2,
  },

  // 2. Actions - æ“ä½œ
  // ç”¨äºæ›´æ–°çŠ¶æ€çš„å‡½æ•°
  actionName: (params) => set((state) => ({ /* æ–°çŠ¶æ€ */ })),
  actionName2: (params) =>
    set((state) => {
      // å¯ä»¥ä½¿ç”¨get()è·å–å½“å‰çŠ¶æ€
      const currentState = get();
      // è¿”å›æ–°çŠ¶æ€
      return { /* æ–°çŠ¶æ€ */ };
    }),

  // 3. Selectors - é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼‰
  // ç”¨äºé€‰æ‹©çŠ¶æ€çš„å‡½æ•°ï¼Œé€šå¸¸åœ¨ç»„ä»¶ä¸­å®šä¹‰
}));

// setå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°
set((state) => newState);     // å‡½æ•°å¼æ›´æ–°ï¼ˆæ¨èï¼‰
set(newState);                // ç›´æ¥æ›´æ–°
set(undefined, true);         // æ›¿æ¢æ•´ä¸ªçŠ¶æ€
```

</CodeBlock>

### 3.2 setå‡½æ•°çš„å·¥ä½œåŸç†

<CodeBlock>

```jsx
const useStore = create((set) => ({
  count: 0,
  text: 'hello',

  // 1. å‡½æ•°å¼æ›´æ–° - ä¸ä¼šè¦†ç›–å…¶ä»–çŠ¶æ€
  increment: () => set((state) => ({ count: state.count + 1 })),
  updateText: (text) => set((state) => ({ text })),

  // 2. ç›´æ¥æ›´æ–° - ä¸ä¼šè¦†ç›–å…¶ä»–çŠ¶æ€
  setCount: (count) => set({ count }),
  setText: (text) => set({ text }),

  // 3. æ›¿æ¢æ•´ä¸ªçŠ¶æ€
  reset: () => set({ count: 0, text: '' }, false), // ç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueæ—¶æ›¿æ¢

  // 4. ä½¿ç”¨getè·å–å½“å‰çŠ¶æ€
  incrementBy: (amount) => {
    const current = get(); // è·å–å½“å‰çŠ¶æ€
    set({ count: current.count + amount });
  },

  // 5. å¤šæ¬¡æ›´æ–°
  incrementAndUpdateText: () => {
    set((state) => ({ count: state.count + 1 })); // ç¬¬ä¸€æ¬¡æ›´æ–°
    set((state) => ({ text: `Count: ${state.count}` })); // ç¬¬äºŒæ¬¡æ›´æ–°
  },
}));

// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹çŠ¶æ€
badUpdate: () => set((state) => {
  state.count += 1; // ä¸è¦ç›´æ¥ä¿®æ”¹state
  return state; // ä»ç„¶ä¼šè§¦å‘é‡æ¸²æŸ“ï¼Œä½†å¯èƒ½å¯¼è‡´é—®é¢˜
}),

// âœ… æ­£ç¡®ï¼šè¿”å›æ–°çŠ¶æ€
goodUpdate: () => set((state) => ({
  ...state,
  count: state.count + 1,
})),
```

</CodeBlock>

### 3.3 çŠ¶æ€é€‰æ‹©å™¨

<CodeBlock>

```jsx
const useStore = create((set) => ({
  count: 0,
  text: 'hello',
  number: 10,
}));

// 1. é€‰æ‹©æ•´ä¸ªçŠ¶æ€
const state1 = useStore(); // { count: 0, text: 'hello', number: 10 }

// 2. é€‰æ‹©å•ä¸ªå­—æ®µ
const count = useStore((state) => state.count);

// 3. è®¡ç®—å€¼
const double = useStore((state) => state.count * 2);

// 4. é€‰æ‹©å¤šä¸ªå­—æ®µ
const { count, text } = useStore((state) => ({
  count: state.count,
  text: state.text,
}));

// 5. æ¡ä»¶é€‰æ‹©
const message = useStore((state) => {
  if (state.count > 10) return 'Too high!';
  return 'OK';
});
```

</CodeBlock>

### 3.4 è‡ªåŠ¨ä¼˜åŒ–é‡æ¸²æŸ“

<CodeBlock>

```jsx
const useStore = create((set) => ({
  count: 0,
  text: 'hello',
  deep: { nested: { value: 0 } },
}));

// 1. é»˜è®¤è¡Œä¸ºï¼šæµ…æ¯”è¾ƒ
function Component1() {
  const count = useStore((state) => state.count);
  // åªåœ¨countå˜åŒ–æ—¶é‡æ¸²æŸ“
  return <div>Count: {count}</div>;
}

// 2. æ˜¾å¼æ¯”è¾ƒ
const deepValue = useStore(
  (state) => state.deep,
  (a, b) => a.deep.nested.value === b.deep.nested.value
);

// 3. ä½¿ç”¨shallowæ¯”è¾ƒå™¨
import { shallow } from 'zustand/shallow';

const { count, text } = useStore(
  (state) => ({ count: state.count, text: state.text }),
  shallow
);
```

</CodeBlock>

---

## 4. çŠ¶æ€æ¨¡å¼å’Œç»„ç»‡

### 4.1 åŸºç¡€çŠ¶æ€ç®¡ç†

<CodeBlock>

```jsx
// åŸºç¡€æ¨¡å¼ï¼šç®€å•çš„getterå’Œsetter
const useBasicStore = create((set) => ({
  // æ•°æ®
  data: [],
  loading: false,
  error: null,

  // åŠ¨ä½œ
  setData: (data) => set({ data }),
  setLoading: (loading) => set({ loading }),
  setError: (error) => set({ error }),
  clear: () => set({ data: [], error: null }),

  // å¤åˆåŠ¨ä½œ
  updateItem: (id, updates) =>
    set((state) => ({
      data: state.data.map((item) =>
        item.id === id ? { ...item, ...updates } : item
      ),
    })),
  removeItem: (id) =>
    set((state) => ({
      data: state.data.filter((item) => item.id !== id),
    })),
  addItem: (item) =>
    set((state) => ({
      data: [...state.data, item],
    })),
}));
```

</CodeBlock>

### 4.2 å¼‚æ­¥æ“ä½œæ¨¡å¼

<CodeBlock>

```jsx
// å¼‚æ­¥æ“ä½œæ¨¡å¼
const useAsyncStore = create((set) => ({
  // çŠ¶æ€
  data: null,
  loading: false,
  error: null,

  // å¼‚æ­¥åŠ¨ä½œ
  fetchData: async () => {
    set({ loading: true, error: null });
    try {
      const response = await fetch('/api/data');
      const data = await response.json();
      set({ data, loading: false });
    } catch (error) {
      set({ error: error.message, loading: false });
    }
  },

  // å¸¦æœ‰å‚æ•°çš„å¼‚æ­¥æ“ä½œ
  fetchUserById: async (id) => {
    set({ loading: true, error: null });
    try {
      const response = await fetch(`/api/users/${id}`);
      if (!response.ok) throw new Error('Failed to fetch');
      const user = await response.json();
      set({ data: user, loading: false });
      return user;
    } catch (error) {
      set({ error: error.message, loading: false });
      throw error;
    }
  },

  // å¤šä¸ªå¼‚æ­¥æ“ä½œ
  fetchMultiple: async (ids) => {
    set({ loading: true, error: null });
    try {
      const promises = ids.map((id) => fetch(`/api/items/${id}`));
      const responses = await Promise.all(promises);
      const data = await Promise.all(
        responses.map((r) => r.json())
      );
      set({ data, loading: false });
    } catch (error) {
      set({ error: error.message, loading: false });
    }
  },
}));
```

</CodeBlock>

### 4.3 å¤æ‚ä¸šåŠ¡é€»è¾‘æ¨¡å¼

<CodeBlock>

```jsx
// å¤æ‚ä¸šåŠ¡é€»è¾‘
const useEcommerceStore = create((set, get) => ({
  // çŠ¶æ€
  products: [],
  cart: [],
  user: null,
  filters: {
    category: 'all',
    priceRange: [0, 1000],
    search: '',
  },

  // åŸºç¡€åŠ¨ä½œ
  setProducts: (products) => set({ products }),
  setUser: (user) => set({ user }),
  setFilters: (filters) => set((state) => ({
    filters: { ...state.filters, ...filters },
  })),

  // å¤æ‚åŠ¨ä½œ
  addToCart: (productId) => {
    const { products, cart } = get();
    const product = products.find((p) => p.id === productId);
    if (!product) return;

    const existingItem = cart.find((item) => item.id === productId);
    if (existingItem) {
      set({
        cart: cart.map((item) =>
          item.id === productId
            ? { ...item, quantity: item.quantity + 1 }
            : item
        ),
      });
    } else {
      set({
        cart: [...cart, { ...product, quantity: 1 }],
      });
    }
  },

  removeFromCart: (productId) =>
    set((state) => ({
      cart: state.cart.filter((item) => item.id !== productId),
    })),

  updateCartQuantity: (productId, quantity) =>
    set((state) => ({
      cart: state.cart.map((item) =>
        item.id === productId ? { ...item, quantity } : item
      ),
    })),

  clearCart: () => set({ cart: [] }),

  // è®¡ç®—æ´¾ç”ŸçŠ¶æ€
  getCartTotal: () => {
    const { cart } = get();
    return cart.reduce(
      (total, item) => total + item.price * item.quantity,
      0
    );
  },

  getCartItemsCount: () => {
    const { cart } = get();
    return cart.reduce((count, item) => count + item.quantity, 0);
  },

  // è¿‡æ»¤äº§å“
  getFilteredProducts: () => {
    const { products, filters } = get();
    return products.filter((product) => {
      if (filters.category !== 'all' && product.category !== filters.category) {
        return false;
      }
      if (product.price < filters.priceRange[0] || product.price > filters.priceRange[1]) {
        return false;
      }
      if (filters.search && !product.name.toLowerCase().includes(filters.search.toLowerCase())) {
        return false;
      }
      return true;
    });
  },
}));
```

</CodeBlock>

---

## 5. Middlewareç³»ç»Ÿ

Zustandçš„å¼ºå¤§ä¹‹å¤„åœ¨äºå…¶å¯æ‰©å±•çš„middlewareç³»ç»Ÿã€‚

### 5.1 æŒä¹…åŒ–ä¸­é—´ä»¶

<CodeBlock>

```jsx
// 1. åŸºç¡€æŒä¹…åŒ–
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

const useStore = create(
  persist(
    (set) => ({
      count: 0,
      increment: () => set((state) => ({ count: state.count + 1 })),
    }),
    {
      name: 'my-store', // localStorageä¸­çš„é”®å
      // storage: customStorage, // è‡ªå®šä¹‰å­˜å‚¨
      // partialize: (state) => ({ count: state.count }), // åªæŒä¹…åŒ–éƒ¨åˆ†çŠ¶æ€
      // version: 1, // ç‰ˆæœ¬å·
      // migrate: (persistedState, version) => { // è¿ç§»å‡½æ•°
      //   if (version === 0) {
      //     // ä»ç‰ˆæœ¬0å‡çº§åˆ°ç‰ˆæœ¬1
      //     return { ...persistedState, newField: 'value' };
      //   }
      //   return persistedState;
      // },
    }
  )
);

// 2. åªæŒä¹…åŒ–ç‰¹å®šå­—æ®µ
const usePartialStore = create(
  persist(
    (set) => ({
      count: 0,
      text: 'hello',
      temp: 'not persisted',
    }),
    {
      name: 'partial-store',
      partialize: (state) => ({ count: state.count, text: state.text }),
    }
  )
);

// 3. ä½¿ç”¨sessionStorage
const useSessionStore = create(
  persist(
    (set) => ({
      data: null,
      setData: (data) => set({ data }),
    }),
    {
      name: 'session-store',
      storage: createJSONStorage(() => sessionStorage),
    }
  )
);
```

</CodeBlock>

### 5.2 Immerä¸­é—´ä»¶

<CodeBlock>

```jsx
// ä½¿ç”¨Immerè¿›è¡Œä¸å¯å˜æ›´æ–°
import { create } from 'zustand';
import { immer } from 'zustand/middleware/immer';
import { produce } from 'immer';

const useStore = create(
  immer((set) => ({
    count: 0,
    todos: [],
    increment: () =>
      set((state) => {
        state.count += 1; // å¯ä»¥ç›´æ¥ä¿®æ”¹
      }),
    addTodo: (todo) =>
      set((state) => {
        state.todos.push({ id: Date.now(), ...todo }); // å¯ä»¥ç›´æ¥ä¿®æ”¹æ•°ç»„
      }),
    toggleTodo: (id) =>
      set((state) => {
        const todo = state.todos.find((t) => t.id === id);
        if (todo) {
          todo.completed = !todo.completed; // å¯ä»¥ç›´æ¥ä¿®æ”¹åµŒå¥—å¯¹è±¡
        }
      }),
    updateTodo: (id, updates) =>
      set((state) => {
        const index = state.todos.findIndex((t) => t.id === id);
        if (index !== -1) {
          state.todos[index] = { ...state.todos[index], ...updates };
        }
      }),
    // ä¹Ÿå¯ä»¥ä½¿ç”¨produceå‡½æ•°
    complexUpdate: (id, newData) =>
      set(
        produce((state) => {
          const todo = state.todos.find((t) => t.id === id);
          if (todo) {
            Object.assign(todo, newData);
            todo.updatedAt = new Date().toISOString();
          }
        })
      ),
  }))
);
```

</CodeBlock>

### 5.3 Redux DevToolsä¸­é—´ä»¶

<CodeBlock>

```jsx
// ä½¿ç”¨Redux DevToolsè°ƒè¯•
import { create } from 'zustand';
import { devtools } from 'zustand/middleware/devtools';

const useStore = create(
  devtools(
    (set) => ({
      count: 0,
      increment: () => set((state) => ({ count: state.count + 1 })),
    }),
    {
      name: 'counter-store', // åœ¨DevToolsä¸­æ˜¾ç¤ºçš„åç§°
      // serialize: true, // å¯ç”¨åºåˆ—åŒ–
      // anonymousActionType: 'INCREMENT', // åŒ¿ååŠ¨ä½œçš„ç±»å‹
    }
  )
);

// å‘½åç©ºé—´ç®¡ç†
const createNamedStore = (name, fn) =>
  create(devtools(fn, { name }));

const useUserStore = createNamedStore('user', (set) => ({
  user: null,
  setUser: (user) => set({ user }),
}));

const useCartStore = createNamedStore('cart', (set) => ({
  items: [],
  addItem: (item) => set((state) => ({ items: [...state.items, item] })),
}));
```

</CodeBlock>

### 5.4 combineä¸­é—´ä»¶

<CodeBlock>

```jsx
// ä½¿ç”¨combineç»„åˆå¤šä¸ªstore
import { create } from 'zustand';
import { combine } from 'zustand/middleware';

const useStore = create(
  combine(
    {
      // çŠ¶æ€
      count: 0,
      text: 'hello',
    },
    (set) => ({
      // åŠ¨ä½œ
      increment: () => set((state) => ({ count: state.count + 1 })),
      updateText: (text) => set({ text }),
    })
  )
);

// æ¨èçš„æ–‡ä»¶ç»„ç»‡æ–¹å¼
// store/counter.js
export const useCounterStore = create(
  combine(
    { count: 0 },
    (set) => ({
      increment: () => set((state) => ({ count: state.count + 1 })),
      decrement: () => set((state) => ({ count: state.count - 1 })),
      reset: () => set({ count: 0 }),
    })
  )
);

// store/todos.js
export const useTodosStore = create(
  combine(
    { todos: [] },
    (set) => ({
      addTodo: (todo) =>
        set((state) => ({ todos: [...state.todos, { id: Date.now(), ...todo }] })),
      toggleTodo: (id) =>
        set((state) => ({
          todos: state.todos.map((t) =>
            t.id === id ? { ...t, completed: !t.completed } : t
          ),
        })),
      removeTodo: (id) =>
        set((state) => ({
          todos: state.todos.filter((t) => t.id !== id),
        })),
    })
  )
);
```

</CodeBlock>

### 5.5 è‡ªå®šä¹‰ä¸­é—´ä»¶

<CodeBlock>

```jsx
// åˆ›å»ºè‡ªå®šä¹‰ä¸­é—´ä»¶
import { StateCreator } from 'zustand';

// 1. æ—¥å¿—ä¸­é—´ä»¶
const logger =
  (config) =>
  (set, get, api) =>
    config(
      (...args) => {
        console.log('Applying action:', args);
        set(...args);
        console.log('New state:', get());
      },
      get,
      api
    );

// 2. è‡ªåŠ¨ä¿å­˜ä¸­é—´ä»¶
const autoSave =
  (config) =>
  (set, get, api) => {
    const store = config(set, get, api);

    api.subscribe((state) => {
      localStorage.setItem('auto-save', JSON.stringify(state));
    });

    return store;
  };

// 3. é”™è¯¯å¤„ç†ä¸­é—´ä»¶
const errorHandler =
  (config) =>
  (set, get, api) => {
    return config(
      (...args) => {
        try {
          set(...args);
        } catch (error) {
          console.error('State update error:', error);
          // å¯ä»¥å‘é€åˆ°é”™è¯¯è¿½è¸ªæœåŠ¡
        }
      },
      get,
      api
    );
  };

// ä½¿ç”¨è‡ªå®šä¹‰ä¸­é—´ä»¶
const useStore = create(
  logger(
    autoSave(
      errorHandler((set) => ({
        count: 0,
        increment: () => set((state) => ({ count: state.count + 1 })),
      }))
    )
  )
);
```

</CodeBlock>

---

## 6. Reacté›†æˆ

### 6.1 Provideræ¨¡å¼

<CodeBlock>

```jsx
// åˆ›å»ºå¸¦Providerçš„store
import { createContext, useContext, useRef } from 'react';
import { create } from 'zustand';

// 1. åˆ›å»ºContext
const StoreContext = createContext();

// 2. åˆ›å»ºProviderç»„ä»¶
export const StoreProvider = ({ children }) => {
  const storeRef = useRef();
  if (!storeRef.current) {
    storeRef.current = create((set) => ({
      // storeå®šä¹‰
      count: 0,
      increment: () => set((state) => ({ count: state.count + 1 })),
    }));
  }

  return (
    <StoreContext.Provider value={storeRef.current}>
      {children}
    </StoreContext.Provider>
  );
};

// 3. è‡ªå®šä¹‰Hook
export const useStore = (selector) => {
  const store = useContext(StoreContext);
  return store(selector);
};

// 4. ä½¿ç”¨
function App() {
  return (
    <StoreProvider>
      <Counter />
    </StoreProvider>
  );
}

function Counter() {
  const { count, increment } = useStore((state) => ({
    count: state.count,
    increment: state.increment,
  }));

  return <button onClick={increment}>{count}</button>;
}
```

</CodeBlock>

### 6.2 ç»„ä»¶å†…å¤–ä½¿ç”¨

<CodeBlock>

```jsx
// 1. ç»„ä»¶å†…ä½¿ç”¨ï¼ˆæœ€å¸¸è§ï¼‰
function Component1() {
  const { count, increment } = useStore();

  return <button onClick={increment}>Count: {count}</button>;
}

// 2. ç»„ä»¶å¤–ä½¿ç”¨ï¼ˆéœ€è¦é€‰æ‹©å™¨ï¼‰
// âŒ é”™è¯¯ï¼šä¸è¦åœ¨ç»„ä»¶å¤–ç›´æ¥ä½¿ç”¨
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));

// âŒ é”™è¯¯åšæ³•
const state = useStore(); // è¿™ä¸ä¼šå·¥ä½œ

// âœ… æ­£ç¡®ï¼šä½¿ç”¨getState()
const store = useStore.getState();
const count = store.count;

// 3. è®¢é˜…çŠ¶æ€å˜åŒ–
import { useEffect } from 'react';

function Component2() {
  const { count } = useStore();

  useEffect(() => {
    // è®¢é˜…countå˜åŒ–
    const unsubscribe = useStore.subscribe(
      (state) => state.count,
      (count) => {
        console.log('Count changed to:', count);
      }
    );

    return () => unsubscribe();
  }, []);

  return <div>Count: {count}</div>;
}

// 4. æ¡ä»¶è®¢é˜…
function Component3() {
  const count = useStore((state) => state.count);
  const [notification, setNotification] = useState(null);

  useEffect(() => {
    const unsubscribe = useStore.subscribe(
      (state) => state.count,
      (count) => {
        if (count > 10) {
          setNotification('Count is too high!');
        } else {
          setNotification(null);
        }
      }
    );

    return () => unsubscribe();
  }, []);

  return (
    <div>
      <div>Count: {count}</div>
      {notification && <div>{notification}</div>}
    </div>
  );
}
```

</CodeBlock>

### 6.3 æ€§èƒ½ä¼˜åŒ–

<CodeBlock>

```jsx
// 1. ä½¿ç”¨æµ…æ¯”è¾ƒ
import { shallow } from 'zustand/shallow';

function OptimizedComponent() {
  // âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡
  const { count, text } = useStore((state) => ({
    count: state.count,
    text: state.text,
  }));

  // âœ… å¥½ï¼šä½¿ç”¨shallow
  const { count, text } = useStore(
    (state) => ({ count: state.count, text: state.text }),
    shallow
  );

  return <div>{text} {count}</div>;
}

// 2. é€‰æ‹©ç‰¹å®šå­—æ®µ
function SpecificField() {
  // åªè®¢é˜…count
  const count = useStore((state) => state.count);
  // å³ä½¿textå˜åŒ–ä¹Ÿä¸ä¼šé‡æ¸²æŸ“
  return <div>Count: {count}</div>;
}

// 3. ä½¿ç”¨useEffectä¼˜åŒ–
function EffectOptimized() {
  const count = useStore((state) => state.count);

  // åªåœ¨countå˜åŒ–æ—¶æ‰§è¡Œ
  useEffect(() => {
    console.log('Count changed:', count);
  }, [count]);

  return <div>{count}</div>;
}

// 4. æ‹†åˆ†store
const useCountStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));

const useTextStore = create((set) => ({
  text: 'hello',
  setText: (text) => set({ text }),
}));

function CountComponent() {
  const { count, increment } = useCountStore();
  return <button onClick={increment}>{count}</button>;
}

function TextComponent() {
  const { text, setText } = useTextStore();
  return <input value={text} onChange={(e) => setText(e.target.value)} />;
}
```

</CodeBlock>

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1 è´­ç‰©è½¦ç³»ç»Ÿ

<CodeBlock>

```jsx
// è´­ç‰©è½¦Store
export const useCartStore = create(
  persist(
    (set, get) => ({
      // çŠ¶æ€
      items: [],
      isOpen: false,

      // åŸºç¡€æ“ä½œ
      addItem: (product) => {
        const { items } = get();
        const existingItem = items.find((item) => item.id === product.id);

        if (existingItem) {
          set({
            items: items.map((item) =>
              item.id === product.id
                ? { ...item, quantity: item.quantity + 1 }
                : item
            ),
          });
        } else {
          set({
            items: [...items, { ...product, quantity: 1 }],
          });
        }
      },

      removeItem: (productId) =>
        set({
          items: get().items.filter((item) => item.id !== productId),
        }),

      updateQuantity: (productId, quantity) => {
        if (quantity <= 0) {
          get().removeItem(productId);
          return;
        }

        set({
          items: get().items.map((item) =>
            item.id === productId ? { ...item, quantity } : item
          ),
        });
      },

      clearCart: () => set({ items: [] }),

      // UIæ“ä½œ
      openCart: () => set({ isOpen: true }),
      closeCart: () => set({ isOpen: false }),

      // è®¡ç®—å€¼
      getTotalItems: () => {
        return get().items.reduce((total, item) => total + item.quantity, 0);
      },

      getTotalPrice: () => {
        return get().items.reduce(
          (total, item) => total + item.price * item.quantity,
          0
        );
      },

      getTotalSavings: () => {
        return get().items.reduce(
          (total, item) =>
            total + (item.originalPrice - item.price) * item.quantity,
          0
        );
      },
    }),
    {
      name: 'cart-storage',
      partialize: (state) => ({ items: state.items }),
    }
  )
);

// è´­ç‰©è½¦ç»„ä»¶
function Cart() {
  const { items, isOpen, closeCart, getTotalPrice } = useCartStore();

  if (!isOpen) return null;

  return (
    <div className="cart">
      <h2>Shopping Cart</h2>
      {items.length === 0 ? (
        <p>Cart is empty</p>
      ) : (
        <>
          {items.map((item) => (
            <CartItem key={item.id} item={item} />
          ))}
          <div className="total">
            Total: ${getTotalPrice().toFixed(2)}
          </div>
        </>
      )}
}

// æ·»åŠ åˆ°è´­ç‰©è½¦æŒ‰é’®
function AddToCartButton({ product }) {
  const addItem = useCartStore((state) => state.addItem);

  return (
    <button onClick={() => addItem(product)}>
      Add to Cart
    </button>
  );
}
```

</CodeBlock>

### 7.2 ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

<CodeBlock>

```jsx
// è®¤è¯Store
export const useAuthStore = create(
  persist(
    (set, get) => ({
      // çŠ¶æ€
      user: null,
      token: null,
      refreshToken: null,
      isAuthenticated: false,
      loading: false,
      error: null,

      // åŠ¨ä½œ
      login: async (credentials) => {
        set({ loading: true, error: null });
        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(credentials),
          });

          if (!response.ok) throw new Error('Login failed');

          const { user, token, refreshToken } = await response.json();

          set({
            user,
            token,
            refreshToken,
            isAuthenticated: true,
            loading: false,
          });

          // è®¾ç½®tokenåˆ°æ‰€æœ‰è¯·æ±‚
          setAuthToken(token);

          return user;
        } catch (error) {
          set({ error: error.message, loading: false });
          throw error;
        }
      },

      register: async (userData) => {
        set({ loading: true, error: null });
        try {
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData),
          });

          if (!response.ok) throw new Error('Registration failed');

          const { user, token, refreshToken } = await response.json();

          set({
            user,
            token,
            refreshToken,
            isAuthenticated: true,
            loading: false,
          });

          setAuthToken(token);
          return user;
        } catch (error) {
          set({ error: error.message, loading: false });
          throw error;
        }
      },

      logout: () => {
        set({
          user: null,
          token: null,
          refreshToken: null,
          isAuthenticated: false,
        });
        clearAuthToken();
      },

      refreshAccessToken: async () => {
        const { refreshToken } = get();
        if (!refreshToken) {
          get().logout();
          return;
        }

        try {
          const response = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken }),
          });

          if (!response.ok) throw new Error('Token refresh failed');

          const { token } = await response.json();

          set({ token });
          setAuthToken(token);
        } catch (error) {
          get().logout();
          throw error;
        }
      },

      clearError: () => set({ error: null }),
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        user: state.user,
        token: state.token,
        refreshToken: state.refreshToken,
        isAuthenticated: state.isAuthenticated,
      }),
    }
  )
);

// å—ä¿æŠ¤çš„è·¯ç”±
function ProtectedRoute({ children }) {
  const { isAuthenticated, loading } = useAuthStore();

  if (loading) return <div>Loading...</div>;
  if (!isAuthenticated) return <Navigate to="/login" />;

  return children;
}

// ç™»å½•ç»„ä»¶
function LoginForm() {
  const { login, loading, error } = useAuthStore();
  const [formData, setFormData] = useState({ email: '', password: '' });

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      await login(formData);
      // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
    } catch (error) {
      // é”™è¯¯ç”±storeå¤„ç†
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {error && <div className="error">{error}</div>}
      <input
        type="email"
        placeholder="Email"
        value={formData.email}
        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
      />
      <input
        type="password"
        placeholder="Password"
        value={formData.password}
        onChange={(e) => setFormData({ ...formData, password: e.target.value })}
      />
      <button type="submit" disabled={loading}>
        {loading ? 'Loading...' : 'Login'}
      </button>
    </form>
  );
}
```

</CodeBlock>

### 7.3 æ•°æ®è·å–å’Œç¼“å­˜

<CodeBlock>

```jsx
// æ•°æ®è·å–Store
export const useDataStore = create(
  persist(
    (set, get) => ({
      // çŠ¶æ€
      data: {},
      loading: {},
      errors: {},

      // åŸºç¡€è·å–æ–¹æ³•
      fetchData: async (key, fetcher) => {
        set((state) => ({
          loading: { ...state.loading, [key]: true },
          errors: { ...state.errors, [key]: null },
        }));

        try {
          const data = await fetcher();
          set((state) => ({
            data: { ...state.data, [key]: data },
            loading: { ...state.loading, [key]: false },
          }));
          return data;
        } catch (error) {
          set((state) => ({
            errors: { ...state.errors, [key]: error.message },
            loading: { ...state.loading, [key]: false },
          }));
          throw error;
        }
      },

      // ç¼“å­˜ç­–ç•¥
      fetchWithCache: async (key, fetcher, ttl = 5 * 60 * 1000) => {
        const { data, dataFetched } = get();

        // æ£€æŸ¥ç¼“å­˜
        if (data[key] && dataFetched[key] && Date.now() - dataFetched[key] < ttl) {
          return data[key];
        }

        // è·å–æ–°æ•°æ®
        return get().fetchData(key, fetcher);
      },

      // æ‰¹é‡è·å–
      fetchBatch: async (requests) => {
        const promises = requests.map(([key, fetcher]) =>
          get().fetchData(key, fetcher)
        );

        try {
          const results = await Promise.all(promises);
          return results;
        } catch (error) {
          // å¦‚æœä»»ä½•ä¸€ä¸ªè¯·æ±‚å¤±è´¥
          throw error;
        }
      },

      // ä¹è§‚æ›´æ–°
      updateData: (key, updater) => {
        set((state) => {
          const newData = typeof updater === 'function'
            ? updater(state.data[key])
            : updater;

          return {
            data: { ...state.data, [key]: newData },
          };
        });
      },

      // é”™è¯¯å¤„ç†
      clearError: (key) =>
        set((state) => ({
          errors: { ...state.errors, [key]: null },
        })),

      clearAll: () => set({ data: {}, loading: {}, errors: {} }),
    }),
    {
      name: 'data-storage',
      partialize: (state) => ({ data: state.data }),
    }
  )
);

// æ•°æ®è·å–ç»„ä»¶
function DataComponent({ id }) {
  const { data, loading, errors, fetchData } = useDataStore();

  useEffect(() => {
    if (!data[id]) {
      fetchData(id, () => api.getData(id));
    }
  }, [id, fetchData, data]);

  if (loading[id]) return <div>Loading...</div>;
  if (errors[id]) return <div>Error: {errors[id]}</div>;
  if (!data[id]) return null;

  return <div>{data[id].content}</div>;
}

// ç¼“å­˜åˆ—è¡¨
function CachedList() {
  const { data, fetchWithCache, loading } = useDataStore();

  useEffect(() => {
    fetchWithCache('items', () => api.getItems(), 10 * 60 * 1000); // 10åˆ†é’Ÿç¼“å­˜
  }, [fetchWithCache]);

  if (loading['items']) return <div>Loading...</div>;
  if (!data['items']) return null;

  return (
    <ul>
      {data['items'].map((item) => (
        <li key={item.id}>{item.name}</li>
      ))}
    </ul>
  );
}
```

</CodeBlock>

---

## 8. æœ€ä½³å®è·µ

### 8.1 Storeè®¾è®¡åŸåˆ™

<CodeBlock>

```jsx
// âœ… å¥½çš„å®è·µ

// 1. ä¿æŒstoreç²¾ç®€
const useUserStore = create((set) => ({
  user: null,
  setUser: (user) => set({ user }),
  logout: () => set({ user: null }),
}));

// 2. åˆ†ç¦»å…³æ³¨ç‚¹
const useAuthStore = create((set) => ({
  // è®¤è¯ç›¸å…³
  user: null,
  login: (user) => set({ user }),
}));

const useCartStore = create((set) => ({
  // è´­ç‰©è½¦ç›¸å…³
  items: [],
  addItem: (item) => set((state) => ({ items: [...state.items, item] })),
}));

// 3. å‘½åæ¸…æ™°
const useStore = create((set) => ({
  // çŠ¶æ€
  isLoading: false,
  error: null,
  userData: null,

  // åŠ¨ä½œ
  startLoading: () => set({ isLoading: true }),
  stopLoading: () => set({ isLoading: false }),
  setError: (error) => set({ error }),
  setUserData: (data) => set({ userData: data }),
}));

// 4. ä½¿ç”¨TypeScript
import { create } from 'zustand';

interface User {
  id: string;
  name: string;
  email: string;
}

interface UserState {
  user: User | null;
  setUser: (user: User) => void;
  logout: () => void;
}

const useUserStore = create<UserState>((set) => ({
  user: null,
  setUser: (user) => set({ user }),
  logout: () => set({ user: null }),
}));
```

</CodeBlock>

### 8.2 æ€§èƒ½ä¼˜åŒ–å®è·µ

<CodeBlock>

```jsx
// âŒ é¿å…ï¼šå¤§å‹å•ä¸€store
const useAppStore = create((set) => ({
  // ä¸è¦æŠŠæ‰€æœ‰ä¸œè¥¿æ”¾åœ¨ä¸€ä¸ªstoreé‡Œ
  user: null,
  products: [],
  cart: [],
  orders: [],
  // ... 100ä¸ªå­—æ®µ
  updateUser: () => {},
  addProduct: () => {},
  // ... 100ä¸ªæ–¹æ³•
}));

// âœ… æ¨èï¼šåˆ†ç¦»çš„å¤šä¸ªstore
const useUserStore = create((set) => ({
  user: null,
  setUser: (user) => set({ user }),
}));

const useProductStore = create((set) => ({
  products: [],
  addProduct: (product) => set((state) => ({ products: [...state.products, product] })),
}));

const useCartStore = create((set) => ({
  items: [],
  addItem: (item) => set((state) => ({ items: [...state.items, item] })),
}));

// âœ… æ¨èï¼šä½¿ç”¨shallowæ¯”è¾ƒ
import { shallow } from 'zustand/shallow';

function Component() {
  const { count, text } = useStore(
    (state) => ({ count: state.count, text: state.text }),
    shallow
  );
  return <div>{text} {count}</div>;
}

// âœ… æ¨èï¼šé€‰æ‹©ç‰¹å®šå­—æ®µ
function OptimizedComponent() {
  const count = useStore((state) => state.count);
  // åªä½¿ç”¨countï¼Œä¸ä¼šå› å…¶ä»–å­—æ®µå˜åŒ–è€Œé‡æ¸²æŸ“
  return <div>{count}</div>;
}
```

</CodeBlock>

### 8.3 å¼‚æ­¥æ“ä½œæœ€ä½³å®è·µ

<CodeBlock>

```jsx
// âœ… å¥½çš„å¼‚æ­¥å¤„ç†
const useAsyncStore = create((set, get) => ({
  data: null,
  loading: false,
  error: null,

  fetchData: async (url) => {
    set({ loading: true, error: null });
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Request failed');
      const data = await response.json();
      set({ data, loading: false });
      return data;
    } catch (error) {
      set({ error: error.message, loading: false });
      throw error;
    }
  },

  // å¸¦é‡è¯•çš„fetch
  fetchWithRetry: async (url, retries = 3) => {
    for (let i = 0; i < retries; i++) {
      try {
        return await get().fetchData(url);
      } catch (error) {
        if (i === retries - 1) throw error;
        await new Promise((resolve) => setTimeout(resolve, 1000 * (i + 1)));
      }
    }
  },

  // å–æ¶ˆæ“ä½œ
  fetchWithCancel: (url) => {
    const controller = new AbortController();
    const signal = controller.signal;

    set({ loading: true });
    fetch(url, { signal })
      .then((response) => response.json())
      .then((data) => set({ data, loading: false }))
      .catch((error) => {
        if (error.name !== 'AbortError') {
          set({ error: error.message, loading: false });
        }
      });

    return () => controller.abort();
  },
}));

// âœ… å¥½çš„é”™è¯¯å¤„ç†
function SafeComponent() {
  const { data, loading, error, fetchData } = useAsyncStore();

  useEffect(() => {
    fetchData('/api/data').catch(() => {
      // é”™è¯¯å·²åœ¨storeä¸­å¤„ç†
    });
  }, [fetchData]);

  if (loading) return <Spinner />;
  if (error) return <ErrorMessage error={error} />;
  if (!data) return <div>No data</div>;

  return <DataList data={data} />;
}
```

</CodeBlock>

### 8.4 çŠ¶æ€æŒä¹…åŒ–

<CodeBlock>

```jsx
// âœ… å¥½çš„æŒä¹…åŒ–å®è·µ
const usePersistentStore = create(
  persist(
    (set) => ({
      // éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€
      user: null,
      preferences: {
        theme: 'light',
        language: 'en',
      },

      // ä¸éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€
      loading: false,
      temporaryData: null,
    }),
    {
      name: 'app-storage',
      partialize: (state) => ({
        // åªæŒä¹…åŒ–å¿…è¦çš„æ•°æ®
        user: state.user,
        preferences: state.preferences,
      }),
      // version: 1,
      // migrate: (persistedState) => {
      //   if (persistedState.version === 0) {
      //     return { ...persistedState, newField: 'default' };
      //   }
      //   return persistedState;
      // },
    }
  )
);

// âœ… é¿å…å­˜å‚¨æ•æ„Ÿä¿¡æ¯
const useAuthStore = create(
  persist(
    (set) => ({
      user: null,
      token: null, // âŒ ä¸å¥½ï¼šä¸è¦åœ¨localStorageä¸­å­˜å‚¨token
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        // åªæŒä¹…åŒ–éæ•æ„Ÿä¿¡æ¯
        user: state.user,
        // ä¸è¦åŒ…å«token
      }),
    }
  )
);

// âœ… ä½¿ç”¨sessionStorage
const useSessionStore = create(
  persist(
    (set) => ({
      data: null,
    }),
    {
      name: 'session-data',
      storage: createJSONStorage(() => sessionStorage),
    }
  )
);
```

</CodeBlock>

---

## 9. å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

### é™·é˜±1ï¼šé”™è¯¯çš„ä¸å¯å˜æ›´æ–°

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - ç›´æ¥ä¿®æ”¹çŠ¶æ€
const useBadStore = create((set) => ({
  count: 0,
  array: [],
  increment: () => set((state) => {
    state.count += 1; // ä¸è¦ç›´æ¥ä¿®æ”¹
    state.array.push(1); // ä¸è¦ç›´æ¥ä¿®æ”¹æ•°ç»„
    return state;
  }),
}));

// âœ… æ­£ç¡® - è¿”å›æ–°çŠ¶æ€
const useGoodStore = create((set) => ({
  count: 0,
  array: [],
  increment: () => set((state) => ({
    count: state.count + 1,
    array: [...state.array, 1],
  })),
}));

// æˆ–è€…ä½¿ç”¨Immer
import { immer } from 'zustand/middleware/immer';

const useImmerStore = create(
  immer((set) => ({
    count: 0,
    array: [],
    increment: () => set((state) => {
      state.count += 1;
      state.array.push(1);
    }),
  }))
);
```

</ErrorBox>

### é™·é˜±2ï¼šè¿‡åº¦è®¢é˜…çŠ¶æ€

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - è®¢é˜…æ•´ä¸ªçŠ¶æ€
function BadComponent() {
  const state = useStore(); // è®¢é˜…æ•´ä¸ªçŠ¶æ€
  return <div>{state.count}</div>; // ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½ä¼šå¯¼è‡´é‡æ¸²æŸ“
}

// âœ… æ­£ç¡® - åªè®¢é˜…éœ€è¦çš„éƒ¨åˆ†
function GoodComponent() {
  const count = useStore((state) => state.count); // åªè®¢é˜…count
  return <div>{count}</div>;
}

// âœ… æ­£ç¡® - ä½¿ç”¨shallow
const selector = (state) => ({ count: state.count, text: state.text });
const { count } = useStore(selector, shallow);
```

</ErrorBox>

### é™·é˜±3ï¼šåœ¨ç»„ä»¶å¤–ä½¿ç”¨store

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - åœ¨ç»„ä»¶å¤–ç›´æ¥ä½¿ç”¨
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));

// é”™è¯¯åšæ³•
const state = useStore(); // è¿™ä¸ä¼šå·¥ä½œ

// âœ… æ­£ç¡® - ä½¿ç”¨getState()
const store = useStore.getState();
const count = store.count;
const increment = store.increment;

// âœ… æ­£ç¡® - åœ¨useEffectä¸­è®¢é˜…
function Component() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const unsubscribe = useStore.subscribe(
      (state) => state.count,
      setCount
    );
    return () => unsubscribe();
  }, []);

  return <div>{count}</div>;
}
```

</ErrorBox>

### é™·é˜±4ï¼šå¤§å‹storeçš„æ€§èƒ½é—®é¢˜

<ErrorBox>

```jsx
// âŒ é”™è¯¯ - å•ä¸ªå·¨å¤§çš„store
const useBadStore = create((set) => ({
  // 100ä¸ªå­—æ®µå’Œ100ä¸ªæ–¹æ³•
  // ä»»ä½•å˜åŒ–éƒ½ä¼šå¯¼è‡´æ‰€æœ‰è®¢é˜…è€…é‡æ¸²æŸ“
}));

// âœ… æ­£ç¡® - åˆ†ç¦»ä¸ºå¤šä¸ªstore
const useUserStore = create((set) => ({ user: null, setUser: (user) => set({ user }) }));
const useCartStore = create((set) => ({ items: [], addItem: (item) => set((state) => ({ items: [...state.items, item] })) }));
const useProductStore = create((set) => ({ products: [], addProduct: (product) => set((state) => ({ products: [...state.products, product] })) }));

// âœ… æ­£ç¡® - æ·±å±‚çŠ¶æ€
const useNestedStore = create((set) => ({
  nested: {
    deep: {
      value: 0,
    },
  },
  // ä½¿ç”¨é€‰æ‹©å™¨é¿å…æ·±å±‚è®¢é˜…çš„è­¦å‘Š
  increment: () => set((state) => ({
    nested: {
      ...state.nested,
      deep: { ...state.nested.deep, value: state.nested.deep.value + 1 },
    },
  })),
}));

function Component() {
  const value = useNestedStore((state) => state.nested.deep.value);
  return <div>{value}</div>;
}
```

</ErrorBox>

---

## 10. å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šå®ç°ç®€å•çš„è®¡æ•°å™¨åº”ç”¨

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å¢åŠ /å‡å°‘æŒ‰é’®
- é‡ç½®æŒ‰é’®
- æ˜¾ç¤ºå½“å‰å€¼
- æ˜¾ç¤ºæ“ä½œå†å²

**å®ç°è¦æ±‚**ï¼š
```javascript
// éœ€è¦å®ç°çš„åŠŸèƒ½
const useCounterStore = create((set) => ({
  count: 0,
  history: [],
  // increment: () => {},
  // decrement: () => {},
  // reset: () => {},
}));
```

**æç¤º**ï¼š
- ä½¿ç”¨ä¸å¯å˜æ›´æ–°
- è®°å½•æ“ä½œå†å²
- ä½¿ç”¨shallowæ¯”è¾ƒä¼˜åŒ–

</Expandable>

### ç»ƒä¹ 2ï¼šå®ç°å¾…åŠäº‹é¡¹ç®¡ç†

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- æ·»åŠ å¾…åŠäº‹é¡¹
- æ ‡è®°å®Œæˆ/æœªå®Œæˆ
- åˆ é™¤å¾…åŠäº‹é¡¹
- è¿‡æ»¤ï¼ˆå…¨éƒ¨/æ´»è·ƒ/å·²å®Œæˆï¼‰
- æŒä¹…åŒ–åˆ°localStorage

**å®ç°è¦æ±‚**ï¼š
```javascript
// éœ€è¦å®ç°çš„åŠŸèƒ½
const useTodoStore = create(
  persist(
    (set) => ({
      todos: [],
      filter: 'all',
      // addTodo: () => {},
      // toggleTodo: () => {},
      // removeTodo: () => {},
      // setFilter: () => {},
    }),
    {
      name: 'todo-storage',
    }
  )
);
```

**æç¤º**ï¼š
- ä½¿ç”¨Immerç®€åŒ–ä¸å¯å˜æ›´æ–°
- å®ç°è¿‡æ»¤é€»è¾‘
- æŒä¹…åŒ–åˆ°localStorage

</Expandable>

### ç»ƒä¹ 3ï¼šå®ç°åšå®¢æ–‡ç« ç³»ç»Ÿ

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- è·å–æ–‡ç« åˆ—è¡¨
- è·å–å•ç¯‡æ–‡ç« 
- æœç´¢åŠŸèƒ½
- æ”¶è—æ–‡ç« 
- é˜…è¯»å†å²

**å®ç°è¦æ±‚**ï¼š
```javascript
// éœ€è¦å®ç°çš„åŠŸèƒ½
const useBlogStore = create(
  persist(
    (set, get) => ({
      articles: [],
      selectedArticle: null,
      searchQuery: '',
      favorites: [],
      history: [],
      // fetchArticles: async () => {},
      // fetchArticle: async (id) => {},
      // searchArticles: (query) => {},
      // addToFavorites: (id) => {},
    }),
    {
      name: 'blog-storage',
    }
  )
);
```

**æç¤º**ï¼š
- å®ç°å¼‚æ­¥æ•°æ®è·å–
- ä½¿ç”¨ç¼“å­˜ç­–ç•¥
- ä¹è§‚æ›´æ–°

</Expandable>

### ç»ƒä¹ 4ï¼šå®ç°å¤æ‚è¡¨å•çŠ¶æ€ç®¡ç†

<Expandable title="ç‚¹å‡»æŸ¥çœ‹è¦æ±‚">

**åŠŸèƒ½è¦æ±‚**ï¼š
- å¤šæ­¥éª¤è¡¨å•
- è¡¨å•éªŒè¯
- è‡ªåŠ¨ä¿å­˜è‰ç¨¿
- æ­¥éª¤é—´å¯¼èˆª

**å®ç°è¦æ±‚**ï¼š
```javascript
// éœ€è¦å®ç°çš„åŠŸèƒ½
const useFormStore = create(
  persist(
    (set) => ({
      currentStep: 0,
      totalSteps: 3,
      formData: {
        step1: {},
        step2: {},
        step3: {},
      },
      errors: {},
      // nextStep: () => {},
      // prevStep: () => {},
      // updateField: () => {},
      // validate: () => {},
    }),
    {
      name: 'form-storage',
    }
  )
);
```

**æç¤º**ï¼š
- åˆ†æ­¥ç®¡ç†æ•°æ®
- éªŒè¯æ¯ä¸ªæ­¥éª¤
- æŒä¹…åŒ–è‰ç¨¿

</Expandable>

---

## 11. Zustand vs å…¶ä»–æ–¹æ¡ˆ

### 11.1 Zustand vs Redux

<Compare>

| ç‰¹æ€§ | Zustand | Redux |
|------|---------|-------|
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ - ç›´è§‚API | é™¡å³­ - éœ€è¦ç†è§£å¤æ‚æ¦‚å¿µ |
| **æ ·æ¿ä»£ç ** | æå°‘ | è¾ƒå¤š |
| **Bundleå¤§å°** | ~12kb | è¾ƒå¤§ |
| **TypeScript** | ä¼˜ç§€ | è‰¯å¥½ |
| **æ€§èƒ½** | ä¼˜ç§€ - è‡ªåŠ¨ä¼˜åŒ– | ä¼˜ç§€ - éœ€è¦é…ç½® |
| **DevTools** | Redux DevToolsæ”¯æŒ | å®˜æ–¹DevTools |
| **ä¸­é—´ä»¶** | è½»é‡çº§ | ä¸°å¯Œ |
| **ç”Ÿæ€** | æ–°å…´ | æˆç†Ÿ |

</Compare>

<CodeBlock>

```jsx
// å¤æ‚åº¦å¯¹æ¯”

// âŒ Redux - å¤æ‚
// éœ€è¦å®šä¹‰typesã€actionsã€reducers
const INCREMENT = 'counter/increment';
function increment() {
  return { type: INCREMENT };
}
function counterReducer(state = 0, action) {
  switch (action.type) {
    case INCREMENT:
      return state + 1;
    default:
      return state;
  }
}
const store = createStore(counterReducer);

// âœ… Zustand - ç®€å•
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));
```

</CodeBlock>

### 11.2 Zustand vs Context

<Compare>

| ç‰¹æ€§ | Zustand | Context |
|------|---------|---------|
| **æ€§èƒ½** | ä¼˜ç§€ - è‡ªåŠ¨é€‰æ‹©å™¨ | è¾ƒå·® - æ‰€æœ‰æ¶ˆè´¹è€…é‡æ¸²æŸ“ |
| **æ ·æ¿ä»£ç ** | æå°‘ | é€‚ä¸­ |
| **åŠŸèƒ½** | ä¸°å¯Œ - middlewareã€DevTools | åŸºç¡€ - åªæä¾›çŠ¶æ€å…±äº« |
| **å­¦ä¹ æˆæœ¬** | ä½ | ä½ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚çŠ¶æ€ | ç®€å•çŠ¶æ€ |

</Compare>

<CodeBlock>

```jsx
// æ€§èƒ½å¯¹æ¯”

// âŒ Context - æ¯æ¬¡éƒ½é‡æ¸²æŸ“
const AppContext = createContext();

function AppProvider({ children }) {
  const [state, setState] = useState({ count: 0, text: 'hello' });
  return (
    <AppContext.Provider value={{ state, setState }}>
      {children}
    </AppContext.Provider>
  );
}

// ä»»ä½•çŠ¶æ€å˜åŒ–ï¼Œæ‰€æœ‰Consumeréƒ½é‡æ¸²æŸ“
function Consumer() {
  const { state } = useContext(AppContext);
  return <div>{state.count}</div>; // å³ä½¿åªä½¿ç”¨countï¼Œtextå˜åŒ–ä¹Ÿä¼šé‡æ¸²æŸ“
}

// âœ… Zustand - åªè®¢é˜…éœ€è¦çš„çŠ¶æ€
const useStore = create((set) => ({
  count: 0,
  text: 'hello',
}));

function OptimizedConsumer() {
  const count = useStore((state) => state.count);
  // åªæœ‰countå˜åŒ–æ—¶æ‰é‡æ¸²æŸ“
  return <div>{count}</div>;
}
```

</CodeBlock>

### 11.3 Zustand vs Jotai

<Compare>

| ç‰¹æ€§ | Zustand | Jotai |
|------|---------|-------|
| **èŒƒå¼** | å…¨å±€çŠ¶æ€ | åŸå­åŒ–çŠ¶æ€ |
| **ç²’åº¦** | ç²—ç²’åº¦ | ç»†ç²’åº¦ |
| **å­¦ä¹ æˆæœ¬** | ä½ | ä¸­ç­‰ |
| **æ€§èƒ½** | ä¼˜ç§€ | ä¼˜ç§€ |
| **ç±»å‹å®‰å…¨** | è‰¯å¥½ | ä¼˜ç§€ |
| **ç”Ÿæ€** | ä¸­ç­‰ | è¾ƒå° |

</Compare>

<CodeBlock>

```jsx
// èŒƒå¼å¯¹æ¯”

// âœ… Zustand - é›†ä¸­å¼store
const useStore = create((set) => ({
  user: null,
  posts: [],
  comments: [],
  setUser: (user) => set({ user }),
  addPost: (post) => set((state) => ({ posts: [...state.posts, post] })),
  addComment: (comment) => set((state) => ({ comments: [...state.comments, comment] })),
}));

// âœ… Jotai - åŸå­åŒ–
const userAtom = atom(null);
const postsAtom = atom([]);
const commentsAtom = atom([]);

function UserComponent() {
  const [user, setUser] = useAtom(userAtom);
  return <div>{user?.name}</div>;
}

function PostsComponent() {
  const [posts] = useAtom(postsAtom);
  return posts.map((post) => <div key={post.id}>{post.title}</div>);
}

// é€‰æ‹©ï¼šZustandé€‚åˆä¼ ç»ŸçŠ¶æ€ç®¡ç†ï¼ŒJotaié€‚åˆæ›´ç»†ç²’åº¦çš„æ§åˆ¶
```

</CodeBlock>

---

## 12. æœ¬ç« å°ç»“

### å…³é”®è¦ç‚¹

<Checklist>

- âœ… Zustandæ˜¯ä¸€ä¸ªè½»é‡çº§çš„çŠ¶æ€ç®¡ç†åº“
- âœ… ç®€æ´çš„APIè®¾è®¡ï¼Œæœ€å°‘çš„æ ·æ¿ä»£ç 
- âœ… è‡ªåŠ¨ä¼˜åŒ–çš„é€‰æ‹©å™¨ï¼Œæœ€å°åŒ–é‡æ¸²æŸ“
- âœ… å¼ºå¤§çš„middlewareç³»ç»Ÿ
- âœ… åŸç”Ÿæ”¯æŒTypeScript
- âœ… æ˜“äºå­¦ä¹ å’Œä½¿ç”¨
- âœ… é€‚ç”¨äºå„ç§è§„æ¨¡çš„é¡¹ç›®
- âœ… ä¸Reactå®Œç¾é›†æˆ
- âœ… æ”¯æŒçŠ¶æ€æŒä¹…åŒ–
- âœ… æ”¯æŒRedux DevToolsè°ƒè¯•

</Checklist>

### Zustandæœ€ä½³å®è·µ

<BestPractices>

1. **ä¿æŒstoreç²¾ç®€** - å°†å¤§å‹åº”ç”¨æ‹†åˆ†ä¸ºå¤šä¸ªå°store
2. **ä½¿ç”¨é€‰æ‹©å™¨** - åªè®¢é˜…éœ€è¦çš„çŠ¶æ€éƒ¨åˆ†
3. **åˆ†ç¦»å…³æ³¨ç‚¹** - æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡çŠ¶æ€
4. **ä½¿ç”¨Immer** - ç®€åŒ–ä¸å¯å˜æ›´æ–°
5. **TypeScriptä¼˜å…ˆ** - å……åˆ†åˆ©ç”¨ç±»å‹ç³»ç»Ÿ
6. **æŒä¹…åŒ–ç­–ç•¥** - åªæŒä¹…åŒ–å¿…è¦æ•°æ®
7. **æ€§èƒ½ä¼˜åŒ–** - ä½¿ç”¨shallowæ¯”è¾ƒ
8. **ä¸­é—´ä»¶åº”ç”¨** - åˆç†ä½¿ç”¨middleware

</BestPractices>

### ä½•æ—¶ä½¿ç”¨Zustand

<BestPractices>

**æ¨èä½¿ç”¨Zustandçš„åœºæ™¯**ï¼š
- ä¸­å°å‹åˆ°å¤§å‹åº”ç”¨
- éœ€è¦ç®€å•ã€æ˜“ç»´æŠ¤çš„çŠ¶æ€ç®¡ç†
- æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åº”ç”¨
- TypeScripté¡¹ç›®
- å¿«é€ŸåŸå‹å¼€å‘
- å›¢é˜Ÿå¯¹æ–°çŠ¶æ€ç®¡ç†åº“å¼€æ”¾

**è€ƒè™‘å…¶ä»–æ–¹æ¡ˆçš„åœºæ™¯**ï¼š
- å·²æœ‰Reduxæ¶æ„çš„é—ç•™ç³»ç»Ÿ
- éœ€è¦å¤æ‚ä¸­é—´ä»¶ç”Ÿæ€
- å›¢é˜Ÿç†Ÿæ‚‰Reduxä¸æ„¿è¿ç§»
- éœ€è¦å®˜æ–¹æ”¯æŒçš„ç”Ÿæ€

**Zustandä¸é€‚åˆçš„åœºæ™¯**ï¼š
- æç®€çŠ¶æ€ï¼ˆContextè¶³å¤Ÿï¼‰
- åŸå­åŒ–çŠ¶æ€éœ€æ±‚ï¼ˆJotaiæ›´é€‚åˆï¼‰
- éœ€è¦å¤§é‡ç¬¬ä¸‰æ–¹æ’ä»¶

</BestPractices>

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»æŒæ¡äº†Zustandçš„åŸºç¡€å’Œå®è·µï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š

1. **[JotaiåŸå­åŒ–çŠ¶æ€](./jotai)** - ç»†ç²’åº¦çŠ¶æ€ç®¡ç†
2. **[çŠ¶æ€ç®¡ç†å¯¹æ¯”åˆ†æ]** - å…¨é¢å¯¹æ¯”å„ç§æ–¹æ¡ˆ
3. **[æ€§èƒ½ä¼˜åŒ–åŸºç¡€](../performance/react-memo)** - çŠ¶æ€æ›´æ–°æ€§èƒ½ä¼˜åŒ–
4. **[è‡ªå®šä¹‰Hooksè¿›é˜¶](../hooks/advanced/custom-hooks)** - é€»è¾‘å¤ç”¨æ¨¡å¼

---

## 13. å»¶ä¼¸é˜…è¯»

### å®˜æ–¹èµ„æº

- [Zustandå®˜æ–¹æ–‡æ¡£](https://github.com/pmndrs/zustand) - å®Œæ•´çš„APIå‚è€ƒ
- [Zustandç¤ºä¾‹](https://github.com/pmndrs/zustand/tree/main/examples) - å®é™…åº”ç”¨ç¤ºä¾‹
- [Zustand Middleware](https://github.com/pmndrs/zustand#middleware) - ä¸­é—´ä»¶åˆ—è¡¨

### æ¨èé˜…è¯»

- [Zustandè®¾è®¡åŸç†](https://github.com/pmndrs/zustand#design-principles) - è®¾è®¡ç†å¿µ
- [Zustandæ€§èƒ½æŒ‡å—](https://docs.pmnd.rs/zustand/recipes/performance) - æ€§èƒ½ä¼˜åŒ–
- [Zustand TypeScriptæŒ‡å—](https://docs.pmnd.rs/zustand/typescript) - ç±»å‹ç³»ç»Ÿ

### ç›¸å…³è¯é¢˜

- [ReduxåŸºç¡€](./redux-fundamentals) - ä¼ ç»ŸçŠ¶æ€ç®¡ç†
- [Context API](../context-api) - Reactå†…ç½®çŠ¶æ€ç®¡ç†
- [çŠ¶æ€ç®¡ç†å¯¹æ¯”] - å„æ–¹æ¡ˆè¯¦ç»†å¯¹æ¯”

---

[â† ä¸Šä¸€ç« ï¼šReduxåŸºç¡€](redux-fundamentals) | [ä¸‹ä¸€ç« ï¼šJotaiåŸå­åŒ–çŠ¶æ€ â†’](jotai)
